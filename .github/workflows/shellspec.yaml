name: "Shellspec"

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  SHELLSPEC_VERSION: 0.28.1
  TERM: xterm-256color
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  HOMEBREW_NO_ENV_HINTS: 1
  # Enable CI auto-install mode for dependencies
  CI_E_BASH_INSTALL_DEPENDENCIES: 1

jobs:
  shellspec-macos:
    name: "MacOS"
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, 'ci skip')"
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history needed for release-it to generate proper changelog
          fetch-tags: true # For correct version detection by release-it

      - name: Detect Homebrew Path
        id: brew_path
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            echo "path=/home/linuxbrew/.linuxbrew" >> "$GITHUB_OUTPUT"
            echo "cache_dir=/home/runner/.cache/Homebrew" >> "$GITHUB_OUTPUT"
          else
            if [ -d "/opt/homebrew" ]; then
              echo "path=/opt/homebrew" >> "$GITHUB_OUTPUT"
            else
              echo "path=/usr/local/Homebrew" >> "$GITHUB_OUTPUT"
            fi
            echo "cache_dir=$HOME/Library/Caches/Homebrew" >> "$GITHUB_OUTPUT"
          fi

      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.brew_path.outputs.path }}
            ${{ steps.brew_path.outputs.cache_dir }}
          key: brew-${{ runner.os }}-${{ hashFiles('.envrc') }}
          restore-keys: |
            brew-${{ runner.os }}-

      - name: Add Homebrew to PATH
        shell: bash
        run: |
          echo "${{ steps.brew_path.outputs.path }}/bin" >> $GITHUB_PATH

      - name: Setup PATH for local binaries
        run: |
          echo "${HOME}/.local/bin" >> "$GITHUB_PATH"
          mkdir -p "${HOME}/.local/bin"
      - name: Install DIRENV
        run: |
          # Install direnv for macOS
          brew install direnv
      - name: Verify installation order and setup
        run: |
          # Verify critical tools are available in correct order
          echo "=== Verifying installation order ==="
          echo "1. Homebrew: $(which brew || echo 'NOT FOUND')"
          echo "2. DIRENV: $(which direnv || echo 'NOT FOUND')"
          echo "3. Homebrew available: $(brew --help >/dev/null 2>&1 && echo 'YES' || echo 'NO')"
          echo "4. DIRENV version: $(direnv version || echo 'FAILED')"
      - name: Setup project dependencies using DIRENV and CI auto-install mode
        run: |
          # Allow .envrc execution and export environment to GitHub Actions
          direnv allow .
          direnv export gha >> "$GITHUB_ENV"
          echo "Dependencies loaded via DIRENV with CI auto-install mode"
      - name: Run shellspec Tests
        run: |
          # Environment variables from .envrc are now available
          # Note: shellspec 0.28.1 has a bug with pop_var_context that causes exit code 102
          # even when all tests pass. We capture output and check for successful test completion.
          output=$(shellspec 2>&1) || {
            echo "Shellspec exited with code $?, checking if tests actually passed..."
            echo "$output"

            # Dynamic test validation (no hardcoded test counts)
            # Check: 1) At least one test passed, 2) No failures, 3) Summary shows success
            passed_tests=$(echo "$output" | grep -c "^ok " || true)
            failed_tests=$(echo "$output" | grep -c "^not ok " || true)
            has_summary=$(echo "$output" | grep -q "examples, .* failures" && echo "yes" || echo "no")

            if [ "$passed_tests" -gt 0 ] && [ "$failed_tests" -eq 0 ] && [ "$has_summary" = "yes" ]; then
              echo "âœ… All $passed_tests tests passed (0 failures) - ignoring shellspec exit code bug"
              exit 0
            else
              echo "âŒ Tests actually failed or incomplete"
              echo "   Passed: $passed_tests, Failed: $failed_tests, Has summary: $has_summary"
              exit 1
            fi
          }
          echo "$output"
  
  shellspec-ubuntu:
    name: "Ubuntu"
    # kcov only works on ubuntu 22.04, on ubuntu-latest installation fails
    runs-on: ubuntu-22.04
    if: "!contains(github.event.head_commit.message, 'ci skip')"
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history needed for release-it to generate proper changelog
          fetch-tags: true # For correct version detection by release-it

      - name: Fetch PR base branch for coverage comparison
        if: github.event_name == 'pull_request'
        run: |
          # Fetch the base branch to enable Codecov comparison
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
          echo "Base branch ${{ github.base_ref }} fetched for coverage comparison"

      - name: Detect Homebrew Path
        id: brew_path
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            echo "path=/home/linuxbrew/.linuxbrew" >> "$GITHUB_OUTPUT"
            echo "cache_dir=/home/runner/.cache/Homebrew" >> "$GITHUB_OUTPUT"
          else
            if [ -d "/opt/homebrew" ]; then
              echo "path=/opt/homebrew" >> "$GITHUB_OUTPUT"
            else
              echo "path=/usr/local/Homebrew" >> "$GITHUB_OUTPUT"
            fi
            echo "cache_dir=$HOME/Library/Caches/Homebrew" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup PATH for local binaries
        run: |
          echo "${HOME}/.local/bin" >> "$GITHUB_PATH"
          mkdir -p "${HOME}/.local/bin"

      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.brew_path.outputs.path }}
            ${{ steps.brew_path.outputs.cache_dir }}
          key: brew-${{ runner.os }}-${{ hashFiles('.envrc') }}
          restore-keys: |
            brew-${{ runner.os }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y kcov uuid-runtime curl build-essential procps file git
      - name: Install Homebrew (Linux only)
        run: |
          # Check if Homebrew is already installed (from cache)
          if [ ! -x ${{ steps.brew_path.outputs.path }}/bin/brew ]; then
            echo "Installing Homebrew for Linux..."
            NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          else
            echo "Homebrew found in cache, skipping installation"
          fi

      - name: Add Homebrew to PATH
        shell: bash
        run: |
          echo "${{ steps.brew_path.outputs.path }}/bin" >> $GITHUB_PATH
          # Set up Homebrew environment variables
          eval "$(${{ steps.brew_path.outputs.path }}/bin/brew shellenv)"
          echo "HOMEBREW_PREFIX=${{ steps.brew_path.outputs.path }}" >> "$GITHUB_ENV"
          echo "HOMEBREW_CELLAR=${{ steps.brew_path.outputs.path }}/Cellar" >> "$GITHUB_ENV"
          echo "HOMEBREW_REPOSITORY=${{ steps.brew_path.outputs.path }}/Homebrew" >> "$GITHUB_ENV"
      - name: Install DIRENV
        run: |
          # Install direnv for Ubuntu (must be after Homebrew for dependency order)
          curl -sfL https://direnv.net/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Verify installation order and setup
        run: |
          # Verify critical tools are available in correct order
          echo "=== Verifying installation order ==="
          echo "1. Homebrew: $(which brew || echo 'NOT FOUND')"
          echo "2. DIRENV: $(which direnv || echo 'NOT FOUND')"
          echo "3. Homebrew available: $(brew --help >/dev/null 2>&1 && echo 'YES' || echo 'NO')"
          echo "4. DIRENV version: $(direnv version || echo 'FAILED')"
      - name: Setup project dependencies using DIRENV and CI auto-install mode
        run: |
          # Ensure Homebrew is in PATH for this step
          eval "$(${{ steps.brew_path.outputs.path }}/bin/brew shellenv)"
          # Allow .envrc execution and export environment to GitHub Actions
          direnv allow .
          direnv export gha >> "$GITHUB_ENV"
          echo "Dependencies loaded via DIRENV with CI auto-install mode"
      - name: Run shellspec tests with coverage
        run: |
          # Environment variables from .envrc are now available (includes GNU tools setup)
          # Run with kcov to generate coverage reports
          # Note: shellspec 0.28.1 has a bug with pop_var_context that causes exit code 102
          # even when all tests pass. We capture output and check for successful test completion.
          output=$(shellspec --kcov 2>&1) || {
            echo "Shellspec exited with code $?, checking if tests actually passed..."
            echo "$output"

            # Dynamic test validation (no hardcoded test counts)
            # Check: 1) At least one test passed, 2) No failures, 3) Summary shows success
            passed_tests=$(echo "$output" | grep -c "^ok " || true)
            failed_tests=$(echo "$output" | grep -c "^not ok " || true)
            has_summary=$(echo "$output" | grep -q "examples, .* failures" && echo "yes" || echo "no")

            if [ "$passed_tests" -gt 0 ] && [ "$failed_tests" -eq 0 ] && [ "$has_summary" = "yes" ]; then
              echo "âœ… All $passed_tests tests passed (0 failures) - ignoring shellspec exit code bug"
              exit 0
            else
              echo "âŒ Tests actually failed or incomplete"
              echo "   Passed: $passed_tests, Failed: $failed_tests, Has summary: $has_summary"
              exit 1
            fi
          }
          echo "$output"

      - name: Generate coverage summary
        if: always()
        run: |
          # Extract coverage percentage from cobertura.xml
          if [ -f coverage/cobertura.xml ]; then
            coverage=$(grep -oP 'line-rate="\K[0-9.]+' coverage/cobertura.xml | head -1 | awk '{printf "%.1f%%", $1*100}')
            echo "## ðŸ“Š Code Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Line Coverage:** $coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ Full HTML report available in workflow artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Coverage report not generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/cobertura.xml
          flags: shellspec-ubuntu
          name: shellspec-ubuntu-22.04
          fail_ci_if_error: false
          verbose: true
          # Override branch detection for master branch pushes
          override_branch: ${{ github.ref_name }}
          override_commit: ${{ github.sha }}
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-ubuntu
          path: coverage/
          retention-days: 30

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-ubuntu
          path: report/
          retention-days: 30
