name: "Shellspec"

on: [push, pull_request]

env:
  SHELLSPEC_VERSION: 0.28.1
  TERM: xterm-256color
  HOMEBREW_NO_AUTO_UPDATE: 1
  # Enable CI auto-install mode for dependencies
  CI_E_BASH_INSTALL_DEPENDENCIES: 1

jobs:
  shellspec-macos:
    name: "MacOS"
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, 'ci skip')"
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history needed for release-it to generate proper changelog
          fetch-tags: true # For correct version detection by release-it
      - name: Setup PATH for local binaries
        run: |
          echo "${HOME}/.local/bin" >> "$GITHUB_PATH"
          mkdir -p "${HOME}/.local/bin"
      - name: Install DIRENV
        run: |
          # Install direnv for macOS
          brew install direnv
      - name: Setup project dependencies using DIRENV and CI auto-install mode
        run: |
          # Allow .envrc execution and export environment to GitHub Actions
          direnv allow .
          direnv export gha >> "$GITHUB_ENV"
          echo "Dependencies loaded via DIRENV with CI auto-install mode"
      - name: Run shellspec Tests
        run: |
          # Environment variables from .envrc are now available
          shellspec
  
  shellspec-ubuntu:
    name: "Ubuntu"
    # kcov only works on ubuntu 22.04, on ubuntu-latest installation fails
    runs-on: ubuntu-22.04
    if: "!contains(github.event.head_commit.message, 'ci skip')"
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history needed for release-it to generate proper changelog
          fetch-tags: true # For correct version detection by release-it
      - name: Setup PATH for local binaries
        run: |
          echo "${HOME}/.local/bin" >> "$GITHUB_PATH"
          mkdir -p "${HOME}/.local/bin"
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y kcov uuid-runtime curl
      - name: Install DIRENV
        run: |
          # Install direnv for Ubuntu
          curl -sfL https://direnv.net/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Setup project dependencies using DIRENV and CI auto-install mode
        run: |
          # Allow .envrc execution and export environment to GitHub Actions
          direnv allow .
          direnv export gha >> "$GITHUB_ENV"
          echo "Dependencies loaded via DIRENV with CI auto-install mode"
      - name: Run shellspec tests
        run: |
          # Environment variables from .envrc are now available (includes GNU tools setup)
          shellspec
