name: "Shellspec"

on: [push, pull_request]

env:
  SHELLSPEC_VERSION: 0.28.1
  TERM: xterm-256color
  HOMEBREW_NO_AUTO_UPDATE: 1
  # Enable CI auto-install mode for dependencies
  CI_E_BASH_INSTALL_DEPENDENCIES: 1

jobs:
  shellspec-macos:
    name: "MacOS"
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, 'ci skip')"
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history needed for release-it to generate proper changelog
          fetch-tags: true # For correct version detection by release-it
      - name: Setup PATH for local binaries
        run: |
          echo "${HOME}/.local/bin" >> "$GITHUB_PATH"
          mkdir -p "${HOME}/.local/bin"
      - name: Auto-install dependencies using CI mode
        run: |
          export E_BASH="$(pwd)/.scripts"
          # Source dependencies script - CI auto-install mode will handle all installations
          source "$PWD/.scripts/_dependencies.sh"
          # Load project dependencies from .envrc (excluding direnv-specific parts)
          dependency bash "5.*.*" "brew install bash"
          dependency git "2.*.*" "brew install git"
          dependency git-lfs "3.*.*" "brew install git-lfs"
          dependency shellspec "0.28.*" "curl -fsSL https://git.io/shellspec | sh -s ${{ env.SHELLSPEC_VERSION }} --yes"
          dependency shellcheck "0.10.*" "curl -sS https://webi.sh/shellcheck | sh"
          dependency shfmt "3.*.*" "curl -sS https://webi.sh/shfmt | sh"
          dependency ggrep "3.*" "brew install grep"
          dependency gsed "4.*" "brew install gnu-sed"
          dependency gawk "5.*.*" "brew install gawk"
          dependency timeout "9.*" "brew install coreutils"
          dependency jq "1.[6-9].*" "brew install jq"
          dependency kcov "43" "brew install kcov"
      - name: Run shellspec Tests
        run: |
          export E_BASH="$(pwd)/.scripts"
          shellspec
  
  shellspec-ubuntu:
    name: "Ubuntu"
    # kcov only works on ubuntu 22.04, on ubuntu-latest installation fails
    runs-on: ubuntu-22.04
    if: "!contains(github.event.head_commit.message, 'ci skip')"
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history needed for release-it to generate proper changelog
          fetch-tags: true # For correct version detection by release-it
      - name: Setup PATH for local binaries
        run: |
          echo "${HOME}/.local/bin" >> "$GITHUB_PATH"
          mkdir -p "${HOME}/.local/bin"
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y kcov uuid-runtime curl
      - name: Auto-install dependencies using CI mode
        run: |
          export E_BASH="$(pwd)/.scripts"
          # Source dependencies script - CI auto-install mode will handle all installations
          source "$PWD/.scripts/_dependencies.sh"
          # Load project dependencies (Ubuntu-specific install commands)
          dependency bash "5.*.*" "sudo apt-get install -y bash"
          dependency git "2.*.*" "sudo apt-get install -y git"
          dependency git-lfs "3.*.*" "sudo apt-get install -y git-lfs"
          dependency shellspec "0.28.*" "curl -fsSL https://git.io/shellspec | sh -s -- --yes"
          dependency shellcheck "0.10.*" "curl -sS https://webi.sh/shellcheck | sh"
          dependency shfmt "3.*.*" "curl -sS https://webi.sh/shfmt | sh"
          dependency jq "1.[6-9].*" "sudo apt-get install -y jq"
          # GNU tools are already available on Ubuntu, just verify versions
          dependency grep "3.*" "sudo apt-get install -y grep"
          dependency sed "4.*" "sudo apt-get install -y sed"
          dependency gawk "5.*.*" "sudo apt-get install -y gawk"
          dependency timeout "9.*" "sudo apt-get install -y coreutils"
      - name: Setup GNU tools symbolic links
        run: |
          export E_BASH="$(pwd)/.scripts"
          # register aliases for GNU tools
          source "$E_BASH/_setup_gnu_symbolic_links.sh"
          export PATH="$(pwd)/bin/gnubin:$PATH"
      - name: Run shellspec tests
        run: |
          export E_BASH="$(pwd)/.scripts"
          export PATH="$(pwd)/bin/gnubin:$PATH"
          # run tests
          shellspec
