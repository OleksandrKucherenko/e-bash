name: "Shellspec"

on: [push, pull_request]

env:
  SHELLSPEC_VERSION: 0.28.1
  TERM: xterm-256color
  HOMEBREW_NO_AUTO_UPDATE: 1
  # Enable CI auto-install mode for dependencies
  CI_E_BASH_INSTALL_DEPENDENCIES: 1

jobs:
  shellspec-macos:
    name: "MacOS"
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, 'ci skip')"
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history needed for release-it to generate proper changelog
          fetch-tags: true # For correct version detection by release-it
      - name: Setup PATH for local binaries
        run: |
          echo "${HOME}/.local/bin" >> "$GITHUB_PATH"
          mkdir -p "${HOME}/.local/bin"
      - name: Install DIRENV
        run: |
          # Install direnv for macOS
          brew install direnv
      - name: Verify installation order and setup
        run: |
          # Verify critical tools are available in correct order
          echo "=== Verifying installation order ==="
          echo "1. Homebrew: $(which brew || echo 'NOT FOUND')"
          echo "2. DIRENV: $(which direnv || echo 'NOT FOUND')"
          echo "3. Homebrew version: $(brew --version | head -1 || echo 'FAILED')"
          echo "4. DIRENV version: $(direnv version || echo 'FAILED')"
      - name: Setup project dependencies using DIRENV and CI auto-install mode
        run: |
          # Allow .envrc execution and export environment to GitHub Actions
          direnv allow .
          direnv export gha >> "$GITHUB_ENV"
          echo "Dependencies loaded via DIRENV with CI auto-install mode"
      - name: Run shellspec Tests
        run: |
          # Environment variables from .envrc are now available
          shellspec
  
  shellspec-ubuntu:
    name: "Ubuntu"
    # kcov only works on ubuntu 22.04, on ubuntu-latest installation fails
    runs-on: ubuntu-22.04
    if: "!contains(github.event.head_commit.message, 'ci skip')"
    steps:
      - name: Checkout Code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history needed for release-it to generate proper changelog
          fetch-tags: true # For correct version detection by release-it
      - name: Setup PATH for local binaries
        run: |
          echo "${HOME}/.local/bin" >> "$GITHUB_PATH"
          mkdir -p "${HOME}/.local/bin"
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y kcov uuid-runtime curl build-essential procps file git
      - name: Install Homebrew (required for dependency script)
        run: |
          # Install Homebrew for Linux - required by .envrc dependencies
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          # Add Homebrew to PATH for current and future steps
          echo "/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin" >> "$GITHUB_PATH"
          # Set up Homebrew environment variables
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "HOMEBREW_PREFIX=/home/linuxbrew/.linuxbrew" >> "$GITHUB_ENV"
          echo "HOMEBREW_CELLAR=/home/linuxbrew/.linuxbrew/Cellar" >> "$GITHUB_ENV"
          echo "HOMEBREW_REPOSITORY=/home/linuxbrew/.linuxbrew/Homebrew" >> "$GITHUB_ENV"
      - name: Install DIRENV
        run: |
          # Install direnv for Ubuntu (must be after Homebrew for dependency order)
          curl -sfL https://direnv.net/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Verify installation order and setup
        run: |
          # Verify critical tools are available in correct order
          echo "=== Verifying installation order ==="
          echo "1. Homebrew: $(which brew || echo 'NOT FOUND')"
          echo "2. DIRENV: $(which direnv || echo 'NOT FOUND')"
          echo "3. Homebrew version: $(brew --version | head -1 || echo 'FAILED')"
          echo "4. DIRENV version: $(direnv version || echo 'FAILED')"
      - name: Setup project dependencies using DIRENV and CI auto-install mode
        run: |
          # Ensure Homebrew is in PATH for this step
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          # Allow .envrc execution and export environment to GitHub Actions
          direnv allow .
          direnv export gha >> "$GITHUB_ENV"
          echo "Dependencies loaded via DIRENV with CI auto-install mode"
      - name: Run shellspec tests
        run: |
          # Environment variables from .envrc are now available (includes GNU tools setup)
          shellspec
