# e-docs: Documentation Generator for e-bash Scripts

**Status**: Proposed
**Created**: 2025-01-24
**Author**: AI Assistant (Claude)
**Related**: CLAUDE.md, docs/public/

---

## Problem Statement

The e-bash project uses a distinctive documentation comment format (`##` blocks with structured sections) that differs from shdoc's `@tag` format. The goal is to create a custom documentation generator that:

1. Parses the existing e-bash documentation style
2. Generates clean Markdown documentation
3. Integrates seamlessly with the existing project structure

---

## Analysis: shdoc vs e-bash Documentation Styles

### shdoc Format (Traditional)
```bash
# @description Function that does something
# @arg $1 string The first argument
# @arg $2 integer The second argument
# @exitcode 0 Success
# @exitcode 1 Failure
# @stdout The result
# @example
#   my_function "hello" 42
```

### e-bash Format (Current)

Each `.scripts` module follows a **6-zone structure**:

```bash
#!/usr/bin/env bash
# shellcheck disable=SC2155,SC2034

# ZONE 1: Copyright Header (## block)
## Copyright (C) 2017-present, Oleksandr Kucherenko
## Last revisit: 2026-01-07
## Version: 2.0.0
## License: MIT
## Source: https://github.com/OleksandrKucherenko/e-bash

# ZONE 2: Dependencies / Source
[ -z "$E_BASH" ] && readonly E_BASH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$E_BASH/_colors.sh"

# ZONE 3: Global Variables
use_macos_extensions=false
declare -g -A TAGS

# ZONE 4: Functions (with ## documentation blocks)
##
## Function description
##
## Parameters:
## - arg1 - Description, type, required|default
##
## Globals:
## - reads/listen: VAR1, VAR2
## - mutate/publish: VAR3
##
## Side effects:
## - Description of side effect
##
## Returns:
## - 0 on success, 1 on failure
## - Echoes result
##
## Usage:
## - example_call "hello" 42
##
function my_func() { ... }

# ZONE 5: Execution Part (optional, after ${__SOURCED__:+return})
${__SOURCED__:+return}

# ZONE 6: Module Summary (## block at END of file)
##
## Module: Module Title
##
## Brief description of what this module provides.
##
## References:
## - demo: demo.example.sh
## - bin: tool.sh
## - documentation: docs/public/module.md
## - tests: spec/module_spec.sh
##
## Globals:
## - VAR_NAME - Description
##
## Categories:
##
## Category Name:
## - function_name() - Brief description
##
```

### Key Differences

| Feature         | shdoc               | e-bash                               |
| --------------- | ------------------- | ------------------------------------ |
| Comment prefix  | `#`                 | `##`                                 |
| Tag format      | `@tag value`        | `Section:` header                    |
| Parameters      | `@arg $N type desc` | `- name - desc, type, default`       |
| Return values   | `@exitcode N msg`   | `## Returns:` section                |
| Globals         | `@set var`          | `## Globals:` with reads/mutate      |
| Side effects    | N/A                 | `## Side effects:` section           |
| File metadata   | `@brief`, `@file`   | Copyright header (Zone 1)            |
| Module overview | First `@file` block | **Module Summary at END** (Zone 6)   |
| Categories      | N/A                 | `## Categories:` with function index |
| References      | `@see`              | `## References:` with demo/bin/docs  |

---

## Proposed Solution: e-docs

Create a documentation generator (`bin/e-docs`) that:

1. **Parses** e-bash documentation format
2. **Generates** GitHub-flavored Markdown
3. **Supports** file-level and function-level documentation
4. **Configurable** via `.edocsrc` file
5. **Integrates** with existing project CI/CD

**Implementation strategy**: Start with pure gawk script (~300 lines). If complexity exceeds maintainability threshold, fallback to TypeScript + BUN runtime.

---

## Proposed Changes

### New Files

#### [NEW] bin/e-docs

Core documentation generator (gawk script, target ~300 lines):

- Parse `##` comment blocks
- Extract structured sections (Parameters, Globals, Returns, Side effects, Usage, References, Categories)
- Generate Markdown with Table of Contents
- Support multiple output styles (github, minimal)
- Handle 6-zone file structure (Copyright, Dependencies, Globals, Functions, Execution, Module Summary)

Key features:
- Detect function declarations: `function name()`, `name()`, `function name {`
- Parse section headers: `## Section:`
- Handle multiline content within sections
- Generate anchors for TOC links
- Extract Module Summary from END of file (Zone 6)

> [!NOTE]
> If gawk complexity exceeds ~400 lines or becomes hard to maintain, will refactor to TypeScript + BUN.

#### [NEW] .edocsrc

Configuration file (shell-sourceable):

```bash
# e-docs configuration
EDOCS_OUTPUT_DIR="docs/public/lib"
EDOCS_SOURCE_DIRS=".scripts"
EDOCS_STYLE="github"
EDOCS_TOC="true"
EDOCS_INCLUDE_PRIVATE="false"
```

#### [NEW] docs/public/e-docs.md

User documentation for the generator tool.

### Integration

#### [MODIFY] mise.toml

Add mise task for documentation generation:

```toml
[tasks.docs]
description = "Generate documentation from .scripts"
run = "bin/e-docs"

[tasks."docs:check"]
description = "Check if docs are up to date"
run = "bin/e-docs --check"
```

---

## Implementation Architecture

### Multi-Tool Strategy

Instead of relying solely on gawk regex for function detection (error-prone), use a **hybrid approach**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          e-docs                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ctags     â”‚    â”‚   shfmt     â”‚    â”‚      gawk           â”‚  â”‚
â”‚  â”‚  (primary)  â”‚    â”‚  (verify)   â”‚    â”‚   (doc parser)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                      â”‚              â”‚
â”‚         â–¼                  â–¼                      â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Function Discovery + Doc Extraction          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Markdown Generator                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tool Responsibilities

| Tool | Purpose | Output |
|------|---------|--------|
| **ctags** | Primary function detection | Function names, line numbers |
| **shfmt** | AST verification (optional) | JSON AST with function nodes |
| **gawk** | Documentation block parsing | Extracted sections |
| **bash** | Orchestration + Markdown generation | Final .md files |

### 1. Function Detection via ctags (Primary)

Universal Ctags already in use (v6.2.0). Extract functions with JSON output:

```bash
# Generate function list with line numbers
ctags --language-force=sh --kinds-sh=f \
      --output-format=json --fields=+n \
      -o- .scripts/_logger.sh
```

Output:
```json
{"_type": "tag", "name": "logger:compose", "path": ".scripts/_logger.sh",
 "line": 39, "kind": "function"}
{"_type": "tag", "name": "logger", "path": ".scripts/_logger.sh",
 "line": 162, "kind": "function"}
```

### 2. AST Verification via shfmt (Optional)

Cross-reference with shfmt's JSON AST for accuracy:

```bash
shfmt --to-json .scripts/_logger.sh | jq '.[] | select(.Type == "FuncDecl")'
```

### 3. Documentation Parsing via gawk

With function locations known from ctags, gawk only needs to:
1. Find `##` blocks above each known function line
2. Parse section headers (Parameters, Globals, etc.)
3. Extract content between sections

### 4. Tree-sitter-bash (Future Enhancement)

For advanced parsing needs, tree-sitter provides full AST:

```bash
# Query for function declarations with comments
tree-sitter query '(function_definition name: (word) @func)' script.sh
```

> [!NOTE]
> Tree-sitter requires Node.js/WASM runtime. Reserved for future TypeScript implementation.

---

## Githook Integration

Instead of CI-based doc generation, use **pre-commit hook** for instant feedback:

### [NEW] .githook/pre-commit.d/docs-update.sh

```bash
#!/usr/bin/env bash
# Auto-update documentation on commit

# Check if any .scripts/*.sh files are staged
if git diff --cached --name-only | grep -q '\.scripts/.*\.sh$'; then
  echo "ðŸ“š Updating documentation for modified scripts..."

  # Get list of modified script files
  modified_scripts=$(git diff --cached --name-only | grep '\.scripts/.*\.sh$')

  for script in $modified_scripts; do
    # Generate docs for this script
    bin/e-docs "$script" > "docs/public/lib/$(basename "$script" .sh).md"
  done

  # Stage the updated docs
  git add docs/public/lib/*.md

  echo "âœ… Documentation updated and staged"
fi
```

---

## Implementation Details

### e-docs Script Structure

```bash
#!/usr/bin/env bash
# bin/e-docs - Documentation generator for e-bash scripts

# Load configuration
[[ -f .edocsrc ]] && source .edocsrc

# Defaults
EDOCS_OUTPUT_DIR="${EDOCS_OUTPUT_DIR:-docs/public/lib}"
EDOCS_SOURCE_DIRS="${EDOCS_SOURCE_DIRS:-.scripts}"

# Step 1: Get functions via ctags
get_functions() {
  ctags --language-force=sh --kinds-sh=f \
        --output-format=json --fields=+n \
        -o- "$1" 2>/dev/null
}

# Step 2: Parse documentation blocks via gawk
parse_docs() {
  gawk -f "$E_BASH/lib/e-docs-parser.awk" "$1"
}

# Step 3: Generate Markdown
generate_markdown() {
  # Combine ctags output with parsed docs
  ...
}

# Main
for script in "${EDOCS_SOURCE_DIRS}"/*.sh; do
  generate_markdown "$script" > "${EDOCS_OUTPUT_DIR}/$(basename "$script" .sh).md"
done
```

### Expected Markdown Output Format

```markdown
# Module Name

Brief description from **Module Summary** (Zone 6 at END of file).

## Overview

Detailed module description from Zone 6.

## References

- **Demo**: demo.example.sh
- **Bin**: tool.sh
- **Documentation**: docs/public/module.md
- **Tests**: spec/module_spec.sh

## Categories

### Category Name
- `function_name()` - Brief description

---

## Index

* [function_one](#function_one)
* [function_two](#function_two)

---

## function_one

Description text.

### Parameters

| Name   | Type   | Default  | Description    |
| ------ | ------ | -------- | -------------- |
| `arg1` | string | required | First argument |

### Globals

| Variable | Access | Description     |
| -------- | ------ | --------------- |
| `E_BASH` | read   | Path to scripts |

### Returns

- 0 on success
- Echoes result string

### Usage

```bash
result=$(function_one "hello")
```
```

---

## Verification Plan

### ShellSpec Unit Testing Strategy

The test suite will follow e-bash patterns from existing specs (e.g., `spec/logger_spec.sh`).

#### Test File Structure

```
spec/
â”œâ”€â”€ e_docs_spec.sh                # Main test file
â””â”€â”€ fixtures/
    â””â”€â”€ e-docs/
        â”œâ”€â”€ simple_function.sh    # Single function with description
        â”œâ”€â”€ full_function.sh      # Function with all sections
        â”œâ”€â”€ full_module.sh        # Complete 6-zone module
        â”œâ”€â”€ multiline.sh          # Multiline descriptions
        â”œâ”€â”€ file_metadata.sh      # File-level copyright/version
        â”œâ”€â”€ no_docs.sh            # Functions without docs
        â”œâ”€â”€ internal_marker.sh    # Internal/private functions
        â””â”€â”€ expected/
            â”œâ”€â”€ simple_function.md
            â”œâ”€â”€ full_function.md
            â””â”€â”€ ...
```

#### Test Specification (spec/e_docs_spec.sh)

```bash
#!/usr/bin/env bash
# shell: bash altsh=shellspec
# shellcheck shell=bash

eval "$(shellspec - -c) exit 1"

Describe 'e-docs /'
  # Helper to run e-docs on fixture
  edocs() { bin/e-docs "$1"; }

  # Helper to get expected output
  expected() { cat "spec/fixtures/e-docs/expected/$1"; }

  Context 'Documentation block detection /'
    It 'parses simple function with description'
      When call edocs "spec/fixtures/e-docs/simple_function.sh"
      The status should be success
      The output should include '## simple_func'
      The output should include 'A simple function that does one thing'
    End

    It 'ignores functions without documentation blocks'
      When call edocs "spec/fixtures/e-docs/no_docs.sh"
      The status should be success
      The output should not include '## undocumented_func'
    End

    It 'skips functions marked as internal'
      When call edocs "spec/fixtures/e-docs/internal_marker.sh"
      The status should be success
      The output should not include '## _private_helper'
    End
  End

  Context 'Section parsing /'
    It 'extracts Parameters section as table'
      When call edocs "spec/fixtures/e-docs/full_function.sh"
      The output should include '### Parameters'
      The output should include '| `arg1` |'
      The output should include 'string'
    End

    It 'extracts Globals section with read/mutate'
      When call edocs "spec/fixtures/e-docs/full_function.sh"
      The output should include '### Globals'
      The output should include 'reads/listen'
      The output should include 'mutate/publish'
    End

    It 'extracts Returns section as bullet list'
      When call edocs "spec/fixtures/e-docs/full_function.sh"
      The output should include '### Returns'
      The output should include '- 0 on success'
    End

    It 'extracts Usage section as code block'
      When call edocs "spec/fixtures/e-docs/full_function.sh"
      The output should include '### Usage'
      The output should include '```bash'
    End

    It 'handles Side effects section'
      When call edocs "spec/fixtures/e-docs/full_function.sh"
      The output should include '### Side effects'
    End
  End

  Context 'Function detection variants /'
    fixture() { printf '%s' "$1" | bin/e-docs /dev/stdin; }

    It 'detects function name() { style'
      input() { cat <<'EOF'
##
## Test function
##
function test_func() {
  echo "hello"
}
EOF
      }
      When call fixture "$(input)"
      The output should include '## test_func'
    End

    It 'detects name() { style without function keyword'
      input() { cat <<'EOF'
##
## Test function
##
test_func() {
  echo "hello"
}
EOF
      }
      When call fixture "$(input)"
      The output should include '## test_func'
    End

    It 'detects function:with:colons name style'
      input() { cat <<'EOF'
##
## Test function
##
function my:namespaced:func() {
  echo "hello"
}
EOF
      }
      When call fixture "$(input)"
      The output should include '## my:namespaced:func'
    End
  End

  Context 'Markdown output /'
    It 'generates valid Table of Contents'
      When call edocs "spec/fixtures/e-docs/full_function.sh"
      The output should include '## Index'
      The output should include '* [full_func](#full_func)'
    End

    It 'extracts file-level metadata'
      When call edocs "spec/fixtures/e-docs/file_metadata.sh"
      The output should include '# _metadata.sh'
      The output should include 'Version:'
    End

    It 'handles multiline descriptions'
      When call edocs "spec/fixtures/e-docs/multiline.sh"
      The output should include 'First line of description'
      The output should include 'continued on second line'
    End
  End

  Context 'Module Summary parsing (Zone 6) /'
    It 'extracts module title from END of file'
      When call edocs "spec/fixtures/e-docs/full_module.sh"
      The output should include '# Module: Test Module'
    End

    It 'extracts References section from module summary'
      When call edocs "spec/fixtures/e-docs/full_module.sh"
      The output should include '## References'
      The output should include 'demo:'
      The output should include 'documentation:'
    End

    It 'extracts Categories from module summary'
      When call edocs "spec/fixtures/e-docs/full_module.sh"
      The output should include '## Categories'
      The output should include 'my_func()'
    End

    It 'places Module Summary content before function index'
      When call edocs "spec/fixtures/e-docs/full_module.sh"
      # Module overview should appear before ## Index
      The output should match pattern '*## Overview*## Index*'
    End
  End

  Context 'Integration tests /'
    It 'generates consistent output for _colors.sh'
      When call edocs ".scripts/_colors.sh"
      The status should be success
      The output should include '# _colors.sh'
    End

    It 'output matches expected fixture exactly'
      When call edocs "spec/fixtures/e-docs/full_function.sh"
      The output should eq "$(expected 'full_function.md')"
    End
  End
End
```

#### Running Tests

```bash
# Run all e-docs tests
shellspec spec/e_docs_spec.sh

# Run with verbose output
shellspec spec/e_docs_spec.sh --format documentation

# Run specific context
shellspec spec/e_docs_spec.sh:25  # Line number

# TDD mode - watch for changes
watchman-make -p 'bin/e-docs' 'spec/e_docs_spec.sh' \
  --run "shellspec spec/e_docs_spec.sh --quick"
```

---

## User Review Required

> [!IMPORTANT]
> Please confirm the following before proceeding:

1. âœ… **Output location**: `docs/public/lib/` (configurable via `.edocsrc`)

2. âœ… **Tool name**: `bin/e-docs`

3. âœ… **Implementation strategy**: gawk first, TypeScript + BUN fallback if too complex

4. **CI integration**: Should docs be auto-generated in CI? Should `mise run docs:check` fail the build if docs are out of sync?

5. **Style preference**: Do you prefer tables (as shown) or definition lists for Parameters/Globals?

6. **Scope**: Should the tool also process `bin/*.sh` scripts or only `.scripts/*.sh`?
