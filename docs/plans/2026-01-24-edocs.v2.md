# e-docs: Documentation Generator for e-bash Scripts

**Status**: Implemented (2026-01-29)
**Created**: 2025-01-24
**Author**: AI Assistant (Claude)
**Related**: CLAUDE.md, docs/public/

---

## Problem Statement

The e-bash project uses a distinctive documentation comment format (`##` blocks with structured sections) that differs from shdoc's `@tag` format. The goal is to create a custom documentation generator that:

1. Parses the existing e-bash documentation style
2. Generates clean Markdown documentation
3. Integrates seamlessly with the existing project structure

---

## Implementation Summary

**Status**: ✅ Complete - All improvements implemented and tested

### Key Features Implemented

1. **Modern Argument Parsing** (args:i COMPOSER pattern)
   - Replaced manual while/case loops with declarative `args:i` pattern
   - Help text included via `-h` flag (no `args:d` needed)
   - Follows pattern from `version-up.v2.sh`

2. **Enhanced Logger Configuration**
   - 7 domain-specific loggers with color-coded prefixes:
     - `edocs` (blue) - Main e-docs operations
     - `parse` (cyan) - Document parsing
     - `generate` (magenta) - Markdown generation
     - `ctags` (yellow) - Function detection
     - `validate` (orange) - Validation warnings
     - `ok` (green) - Success messages
     - `err` (red) - Error messages

3. **Dependency Checking**
   - [`validate_ctags()`](bin/e-docs.sh:192) - Checks ctags >= 6.0.0
   - [`validate_gawk()`](bin/e-docs.sh:213) - Checks gawk >= 4.0.0
   - Smart skipping for `--help` flag and when no file arguments

4. **Dry-Run Mode**
   - Proper command classification:
     - `run:*` for read-only operations (ctags, cat, grep, sed, awk)
     - `dry:*` for state-mutating operations (mkdir, cp, mv, rm)
   - Enables dry-run without if/else branching

5. **Trap Handlers**
   - [`TEMP_DIR`](bin/e-docs.sh:92) automatically cleaned up on EXIT, INT, TERM
   - LIFO execution order for proper cleanup

6. **Error Handling**
   - [`validate_doc_block()`](bin/e-docs.sh:141) - Checks documentation format
   - [`validate_structure()`](bin/e-docs.sh:234) - Validates 6-zone script structure
   - Clear error messages with installation instructions

7. **Function Refactoring**
   - [`is_doc_comment()`](bin/e-docs.sh:388) - Check if line is ## comment
   - [`is_regular_comment()`](bin/e-docs.sh:396) - Check if line is # comment
   - [`find_doc_boundaries()`](bin/e-docs.sh:404) - Find documentation boundaries
   - Simplified [`extract_doc_block()`](bin/e-docs.sh:453) using helper functions

### Technical Implementation Details

#### Multi-Tool Strategy

Uses a **hybrid approach** for reliability:

```
┌──────────────────────────────────────────────────────────────────┐
│                          e-docs                                   │
├──────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │
│  │   ctags     │    │   shfmt     │    │      bash           │  │
│  │  (primary)  │    │  (optional) │    │   (orchestration)  │  │
│  └──────┬──────┘    └──────┬──────┘    └──────────┬──────────┘  │
│         │                  │                      │              │
│         ▼                  ▼                      ▼              │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Function Discovery + Doc Extraction          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Markdown Generator                     │   │
│  └──────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────┘
```

#### Tool Responsibilities

| Tool      | Purpose                             | Output                       |
| --------- | ----------------------------------- | ---------------------------- |
| **ctags** | Primary function detection          | Function names, line numbers |
| **bash**  | Orchestration + Markdown generation | Final .md files              |

### Function Detection via ctags (Primary)

Universal Ctags already in use (v6.2.0). Extract functions with JSON output:

```bash
# Generate function list with line numbers
ctags --language-force=sh --kinds-sh=f \
      --output-format=json --fields=+n \
      -o- .scripts/_logger.sh
```

Output:
```json
{"_type": "tag", "name": "logger:compose", "path": ".scripts/_logger.sh",
 "line": 39, "kind": "function"}
{"_type": "tag", "name": "logger", "path": ".scripts/_logger.sh",
 "line": 162, "kind": "function"}
```

### Documentation Parsing via Bash

With function locations known from ctags, bash extracts `##` blocks:

1. Find `##` blocks above each known function line
2. Parse section headers (Parameters, Globals, etc.)
3. Extract content between sections
4. Skip non-documentation comments (like `# shellcheck disable`)

### Expected Markdown Output Format

```markdown
# Module Name

Brief description from **Module Summary** (Zone 6 at END of file).

## Overview

Detailed module description from Zone 6.

## References

- **Demo**: demo.example.sh
- **Bin**: tool.sh
- **Documentation**: docs/public/module.md
- **Tests**: spec/module_spec.sh

## Categories

### Category Name
- `function_name()` - Brief description

---

## Index

* [function_one](#function_one)
* [function_two](#function_two)

---

## function_one

Description text.

### Parameters

| Name   | Type   | Default  | Description    |
| ------ | ------ | -------- | -------------- |
| `arg1` | string | required | First argument |

### Globals

| Variable | Access | Description     |
| -------- | ------ | --------------- |
| `E_BASH` | read   | Path to scripts |

### Returns

- 0 on success
- Echoes result string

### Usage

```bash
result=$(function_one "hello")
```
```

---

## CLI Interface

### Arguments

| Flag                | Description                                        |
| ------------------- | -------------------------------------------------- |
| `-h, --help`        | Show help and exit                                 |
| `--version`         | Show version and exit                              |
| `-o, --output-dir`  | Output directory for documentation                 |
| `-c, --check`       | Check if docs are up to date (exit 1 if not)       |
| `-n, --dry-run`     | Print to stdout without creating files/directories |
| `-s, --stdout`      | Alias for --dry-run (for backwards compatibility)  |
| `--no-toc`          | Disable table of contents                          |
| `-v, --validate`    | Enable validation warnings                         |
| `--no-validate`     | Disable validation warnings                        |
| `--include-private` | Include private functions (starting with _)        |
| `--debug`           | Enable debug mode                                  |

### Examples

```bash
# Generate docs for all scripts
e-docs

# Generate docs for specific file
e-docs .scripts/_logger.sh

# Preview docs without writing
e-docs --dry-run file.sh

# Verify docs are current
e-docs --check
```

### @{keyword} Hints

- `@{internal}` - Skip this function in output (internal implementation)
- `@{ignore}` - Skip this function in output (explicit exclusion)
- `@{deprecated:msg}` - Mark function as deprecated with message
- `@{since:version}` - Version when function was added

---

## Configuration

### .edocsrc File

Configuration file (shell-sourceable):

```bash
# e-docs configuration
EDOCS_OUTPUT_DIR="docs/public/lib"
EDOCS_SOURCE_DIRS=".scripts"
EDOCS_STYLE="github"
EDOCS_TOC="true"
EDOCS_INCLUDE_PRIVATE="false"
```

### Environment Variables

| Variable                | Default           | Description                         |
| ----------------------- | ----------------- | ----------------------------------- |
| `EDOCS_OUTPUT_DIR`      | `docs/public/lib` | Output directory for generated docs |
| `EDOCS_SOURCE_DIRS`     | `.scripts`        | Source directories to scan          |
| `EDOCS_STYLE`           | `github`          | Output style (github, minimal)      |
| `EDOCS_TOC`             | `true`            | Enable/disable table of contents    |
| `EDOCS_INCLUDE_PRIVATE` | `false`           | Include private functions           |
| `EDOCS_VALIDATE`        | `true`            | Enable validation warnings          |

---

## Improvements Summary

### Code Quality Improvements

1. **Modern Argument Parsing**
   - Replaced 45-line manual while/case loop with `args:i` COMPOSER pattern
   - Declarative argument definition
   - Help text included via `-h` flag
   - No need for `args:d` calls

2. **Enhanced Logging**
   - 7 domain-specific loggers with color-coded prefixes
   - Clear separation of concerns (edocs, parse, generate, ctags, validate)
   - Better debugging and error tracking

3. **Proper Dry-Run Support**
   - Command classification: `run:*` vs `dry:*`
   - No if/else branching needed for dry-run mode
   - Clean separation of read-only vs state-mutating operations

4. **Dependency Validation**
   - Version-aware checking for ctags (>= 6.0.0) and gawk (>= 4.0.0)
   - Clear error messages with installation instructions
   - Smart skipping for `--help` and when no file arguments

5. **Trap Handlers**
   - Automatic cleanup of `TEMP_DIR` on exit
   - LIFO execution order for proper resource management

6. **Error Handling**
   - [`validate_doc_block()`](bin/e-docs.sh:141) - Checks documentation completeness
   - [`validate_structure()`](bin/e-docs.sh:234) - Validates 6-zone format
   - [`validate_ctags()`](bin/e-docs.sh:192) - Version checking
   - [`validate_gawk()`](bin/e-docs.sh:213) - Version checking

7. **Function Refactoring**
   - Helper functions for documentation parsing:
     - [`is_doc_comment()`](bin/e-docs.sh:388) - Check ## comments
     - [`is_regular_comment()`](bin/e-docs.sh:396) - Check # comments
     - [`find_doc_boundaries()`](bin/e-docs.sh:404) - Find doc boundaries
   - Simplified [`extract_doc_block()`](bin/e-docs.sh:453) using helpers

### Elegant Code Principles Applied

From `.claude/skills/elegant-code/SKILL.md`:

- **Rule 1 (Preserve intent)**: Code clearly expresses documentation generation purpose
- **Rule 2 (Minimize concepts)**: No mini-frameworks, direct functions
- **Rule 3 (Common case simple)**: Dry-run mode without branching
- **Rule 4 (Small, cohesive units)**: Helper functions <50 lines
- **Rule 5 (Explicit data flow)**: Parameters and return values explicit

---

## Testing

### Verified Functionality

✅ `--help` flag displays formatted help with all options
✅ `--version` flag shows correct version
✅ `--dry-run` mode works without writing files
✅ Dependency validation properly checks tool versions
✅ All loggers initialize with color-coded prefixes
✅ Dry-run mode properly classifies commands (read-only vs state-mutating)
✅ Trap handlers clean up temporary directory

### Running Tests

```bash
# Run all e-docs tests
shellspec spec/e_docs_spec.sh

# Run with verbose output
shellspec spec/e_docs_spec.sh --format documentation

# Run specific context
shellspec spec/e_docs_spec.sh:25  # Line number
```

---

## Integration with e-bash Ecosystem

### Module Dependencies

The `bin/e-docs.sh` script properly uses e-bash modules:

| Module             | Purpose                                  |
| ------------------ | ---------------------------------------- |
| `_gnu.sh`          | Cross-platform GNU tools                 |
| `_colors.sh`       | Color definitions                        |
| `_dependencies.sh` | Version-aware dependency checking        |
| `_logger.sh`       | Tag-based logging                        |
| `_arguments.sh`    | Declarative command-line argument parser |
| `_dryrun.sh`       | Dry-run mode with command wrapping       |
| `_traps.sh`        | Cleanup handlers for resource management |

### Loading Order

```bash
1. Bootstrap E_BASH location
2. Source _gnu.sh
3. Set DEBUG variable (before logger)
4. Source _colors.sh
5. Source _logger.sh
6. Source _dependencies.sh
7. Export SKIP_ARGS_PARSING=1
8. Source _arguments.sh
9. Source _traps.sh
10. Source _dryrun.sh (and call dryrun mkdir)
11. Initialize domain-specific loggers
12. Check dependencies
13. Parse arguments
14. Execute main logic
```

---

## Migration Guide

For existing scripts transitioning to use `bin/e-docs.sh`:

1. **Ensure `##` Documentation Format**
   - Use `##` for documentation blocks
   - Include required sections (Summary, Parameters, Globals, Returns)
   - Follow 6-zone file structure

2. **Add Module Summary at File End**
   ```bash
   ##
   ## Module: Module Name
   ##
   ## Purpose: Brief description
   ##
   ## References:
   ## - demos/demo.sh
   ## - documentation: docs/public/module.md
   ##
   ```

3. **Generate Documentation**
   ```bash
   # Generate for all scripts
   e-docs
   
   # Generate for specific file
   e-docs .scripts/my_module.sh
   
   # Preview without writing
   e-docs --dry-run .scripts/my_module.sh
   
   # Verify docs are current
   e-docs --check
   ```

4. **Customize Output**
   Create `.edocsrc`:
   ```bash
   EDOCS_OUTPUT_DIR="docs/public/lib"
   EDOCS_SOURCE_DIRS=".scripts:bin"
   EDOCS_TOC="true"
   EDOCS_INCLUDE_PRIVATE="false"
   EDOCS_VALIDATE="true"
   ```

---

## Documentation Standards Reference

For complete documentation standards, see:

- **[Script Commenting Standard](2026-01-24-self-documenting.md)** - Full specification for `##` format
- **docs/public/e-docs.md** - User documentation for the tool
- **docs/public/self-documenting.md** - Self-documenting patterns

---

## Summary

The `bin/e-docs.sh` script has been successfully enhanced with:

1. ✅ Modern argument parsing using `args:i` COMPOSER pattern
2. ✅ Enhanced logger configuration with 7 domain-specific loggers
3. ✅ Dependency validation for ctags and gawk
4. ✅ Proper dry-run mode with command classification
5. ✅ Trap handlers for automatic cleanup
6. ✅ Improved error handling and validation
7. ✅ Function refactoring for elegance and maintainability

All improvements follow e-bash patterns and elegant code principles.
