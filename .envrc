# shellcheck disable=SC2148,SC2155

#
# Setup Git hooks from .githook directory
#
[ -d ".git" ] && git config core.hooksPath .githook
[ -d ".githook" ] && chmod +x .githook/*

#
# on terminal bootstrap .zshrc loading takes time, and path to tools can be not yet available
# so we need to add path to tools to PATH variable to prevent false fails
#
PATH_add "$HOME/.local/bin"

#
# Add scripts to PATH for simpler run
#
PATH_add "$PWD/.scripts"
PATH_add "$PWD/bin"
PATH_add "$PWD/.github/scripts"

#
# Make global variable for all scripts, declare before any source ...
#
export E_BASH="$PWD/.scripts"

#
# Load scripts: _logger <-- _commons <-- _dependencies
#
source "$PWD/.scripts/_dependencies.sh"

#
# Set up GNU tool shims/paths on Linux
#
if [[ "$(uname -s)" == "Linux" ]]; then
  PATH_add "$PWD/bin/gnubin"
  source "$PWD/.scripts/_gnu.sh"
fi

#
# Project dependencies
#
dependency bash "5.*.*" "brew install bash"
dependency direnv "2.*.*" "curl -sfL https://direnv.net/install.sh | bash"
dependency git "2.*.*" "brew install git"
dependency git-lfs "3.*.*" "brew install git-lfs"
dependency lefthook "2.*.*" "brew install lefthook"
dependency shellspec "0.2[89].*" "brew install shellspec"
dependency shellcheck "0.11.*" "curl -sS https://webi.sh/shellcheck | sh"
dependency shfmt "3.12.*" "curl -sS https://webi.sh/shfmt | sh"
dependency ggrep "3.*" "brew install grep"
dependency gsed "4.*" "brew install gnu-sed"
dependency gawk "5.*.*" "brew install gawk"
dependency timeout "9.*" "brew install coreutils"
dependency jq "1.[6-9].*" "brew install jq"
dependency kcov "43" "brew install kcov"

# Allow of HEAD or stable versions of the watchman tool (optional for TDD workflow)
wHead=$(optional watchman "HEAD-[a-f0-9]{1,8}" "brew install watchman")
wStab=$(optional watchman "202[5-6].*.*.*" "brew install watchman")
echo "$wHead" | grep 'wrong version' &>/dev/null && echo "$wStab" || echo "$wHead"

# terminal recorder
optional t-rec "0.[78].*" "brew install t-rec" # 0.7.9+ expected
# mise - https://github.com/mise-sh/mise
optional mise "202[5-6].*.*" "brew install mise"

# ref:https://github.com/liquidaty/zsv
# optional zsv "0.3.*-alpha" "brew tap liquidaty/zsv && brew install zsv" "version"

#
# Alternative Shell Formatter, that understands unit test spec files
# ref: https://github.com/shellspec/altshfmt
#
export ALTSHFMT="$PWD/../altshfmt/altshfmt"

#
# Ask watchman to automatically update formatting of the scripts (Optional)
#

# `watchman-make -p 'spec/*.sh' '**/.shellspec' --run ./00-format.sh`
command -v watchman >/dev/null 2>&1 && watchman watch-project "$(pwd)" >/dev/null
# watchman -j <<-EOT
# ["trigger", ".", {
#   "name": "tdd-run-ebash-formatting",
#   "expression": ["anyof",
#     ["match", "*_spec.sh"],
#     ["match", "spec_helper.sh"],
#     ["match", ".shellspec"]
#   ],
#   "relative_root": ".",
#   "command": ["./00-format.sh"]
# }]
# EOT

#
# ShellSpec Timeout Patch Detection & Auto-apply
#
SHELLSPEC_BIN="$(command -v shellspec 2>/dev/null)"
if [[ -n "$SHELLSPEC_BIN" ]]; then
  if ! "$SHELLSPEC_BIN" --help 2>/dev/null | grep -q -- '--timeout'; then
     echo "Applying ShellSpec timeout patch..."
     if [[ "$(uname -s)" == "Darwin" ]]; then
        if [[ -f "$PWD/patches/apply.macos.sh" ]]; then
             "$PWD/patches/apply.macos.sh"
        fi
     else
        if [[ -f "$PWD/patches/apply.sh" ]]; then
             "$PWD/patches/apply.sh"
        fi
     fi
  fi
fi

#
# Git Hooks Setup - Phase 1: Parallel Testing (Lefthook Migration)
# Legacy hooks are still active, lefthook installed for testing
#
[ -d ".git" ] && git config core.hooksPath .githook
[ -d ".githook" ] && chmod +x .githook/*

# Install lefthook for parallel testing (Phase 1 of migration)
if command -v lefthook >/dev/null 2>&1; then
  lefthook install 2>/dev/null || true
  echo "âœ… Lefthook installed (parallel testing mode - see docs/plans/2025-01-25-lefthook-migration.md)"
fi

cl:unset

