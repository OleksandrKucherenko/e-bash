# shellcheck disable=SC2148,SC2155

#
# Setup Git hooks from .githook directory
#
[ -d ".git" ] && git config core.hooksPath .githook
[ -d ".githook" ] && chmod +x .githook/*

#
# on terminal bootstrap .zshrc loading takes time, and path to tools can be not yet available
# so we need to add path to tools to PATH variable to prevent false fails
#
PATH_add "$HOME/.local/bin"

#
# Add scripts to PATH for simpler run
#
PATH_add "$PWD/.scripts"
PATH_add "$PWD/bin"
PATH_add "$PWD/.github/scripts"

#
# Make global variable for all scripts, declare before any source ...
#
export E_BASH="$(pwd)/.scripts"

#
# Load scripts: _logger <-- _commons <-- _dependencies
#
source "$PWD/.scripts/_dependencies.sh"

#
# Set up GNU tool shims/paths on Linux
#
if [[ "$(uname -s)" == "Linux" ]]; then
  PATH_add "$PWD/bin/gnubin"
  source "$PWD/.scripts/_gnu.sh"
fi

#
# ref: https://www.perplexity.ai/account/api
#
# export PERPLEXITY_API_KEY=$(cat "$PWD/.secrets/perplexity_api_key")
#
# ref: https://console.anthropic.com/settings/workspaces/wrkspc_016VV8qzVEzP37znEdSGQ3bD/keys
#
# export ANTHROPIC_API_KEY=$(cat "$PWD/.secrets/anthropic_api_key")

#
# Project dependencies
#
dependency bash "5.*.*" "brew install bash"
dependency direnv "2.*.*" "curl -sfL https://direnv.net/install.sh | bash"
dependency git "2.*.*" "brew install git"
dependency git-lfs "3.*.*" "brew install git-lfs"
dependency shellspec "0.28.*" "brew install shellspec"
dependency shellcheck "0.11.*" "curl -sS https://webi.sh/shellcheck | sh"
dependency shfmt "3.12.*" "curl -sS https://webi.sh/shfmt | sh"
dependency ggrep "3.*" "brew install grep"
dependency gsed "4.*" "brew install gnu-sed"
dependency gawk "5.*.*" "brew install gawk"
dependency timeout "9.*" "brew install coreutils"
dependency jq "1.[6-9].*" "brew install jq"

# ref:https://github.com/liquidaty/zsv
# optional zsv "0.3.*-alpha" "brew tap liquidaty/zsv && brew install zsv" "version"

dependency kcov "43" "brew install kcov"

# Allow of HEAD or stable versions of the watchman tool (optional for TDD workflow)
wHead=$(optional watchman "HEAD-[a-f0-9]{1,8}" "brew install watchman")
wStab=$(optional watchman "202[4-5].*.*.*" "brew install watchman")
echo "$wHead" | grep 'wrong version' &>/dev/null && echo "$wStab" || echo "$wHead"

# terminal recorder
optional t-rec "0.[78].*" "brew install t-rec" # 0.7.9+ expected
# mise - https://github.com/mise-sh/mise
optional mise "2025.*.*" "brew install mise"

#
# ShellSpec Timeout Patch Detection
# Check if the timeout feature patch has been applied to ShellSpec
#
SHELLSPEC_BIN="$(command -v shellspec 2>/dev/null)"

# Function to find the ShellSpec marker file
_shellspec_find_marker() {
  local shellspec_dir
  if [[ -z "$SHELLSPEC_BIN" ]]; then
    return 1
  fi

  # Resolve to installation directory
  shellspec_dir="$(dirname "$SHELLSPEC_BIN")"
  if [[ -L "$SHELLSPEC_BIN" ]]; then
    local resolved
    resolved="$(readlink "$SHELLSPEC_BIN")"
    [[ "$resolved" != /* ]] && resolved="$shellspec_dir/$resolved"
    # Follow symlinks
    while [[ -L "$resolved" ]]; do
      local link_dir
      link_dir="$(dirname "$resolved")"
      resolved="$(readlink "$resolved")"
      [[ "$resolved" != /* ]] && resolved="$link_dir/$resolved"
    done
    shellspec_dir="$(dirname "$resolved")"
  fi

  # Check for marker in installation directory
  if [[ -f "$shellspec_dir/.patched-timeout" ]]; then
    echo "$shellspec_dir/.patched-timeout"
    return 0
  fi

  return 1
}

apply_shellspec_timeout_hint() {
  if [[ -n "$SHELLSPEC_BIN" ]]; then
    if ! "$SHELLSPEC_BIN" --help 2>/dev/null | grep -q -- '--timeout'; then
      echo ""
      echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      echo "  ⚠️  ShellSpec Timeout Patch Not Applied"
      echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      echo ""
      echo "  The ShellSpec timeout feature patch is not applied to your"
      echo "  local installation. This patch adds:"
      echo ""
      echo "    • --timeout SECONDS   Set global timeout for tests"
      echo "    • --no-timeout        Disable timeout"
      echo "    • %timeout:N          Per-test timeout override"
      echo ""
      echo "  To apply the patch, run:"
      echo "    ./patches/apply.sh"
      echo ""
      echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      echo ""
    fi
  fi
}

# Show hint on shell load (only in interactive shells)
# Note: Use 'shellspec-patch-check' command to manually check
shellspec-patch-check() {
  if [[ -n "$SHELLSPEC_BIN" ]]; then
    if "$SHELLSPEC_BIN" --help 2>/dev/null | grep -q -- '--timeout'; then
      echo "✓ ShellSpec timeout patch is applied"
    else
      apply_shellspec_timeout_hint
    fi
  else
    echo "✗ ShellSpec not found in PATH"
  fi
}

#
# Alternative Shell Formatter, that understands unit test spec files
# ref: https://github.com/shellspec/altshfmt
#
export ALTSHFMT="$PWD/../altshfmt/altshfmt"

#
# Ask watchman to automatically update formatting of the scripts (Optional)
#

# `watchman-make -p 'spec/*.sh' '**/.shellspec' --run ./00-format.sh`
command -v watchman >/dev/null 2>&1 && watchman watch-project "$(pwd)" >/dev/null
# watchman -j <<-EOT
# ["trigger", ".", {
#   "name": "tdd-run-ebash-formatting",
#   "expression": ["anyof",
#     ["match", "*_spec.sh"],
#     ["match", "spec_helper.sh"],
#     ["match", ".shellspec"]
#   ],
#   "relative_root": ".",
#   "command": ["./00-format.sh"]
# }]
# EOT

cl:unset
