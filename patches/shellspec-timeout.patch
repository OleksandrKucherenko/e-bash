diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/bin/shellspec new/bin/shellspec
--- old/bin/shellspec	2021-01-11 06:25:23.000000000 +0100
+++ new/bin/shellspec	2025-12-23 15:20:28.000000000 +0100
@@ -5,9 +5,12 @@
 
 set -e -u -f
 
+#shellcheck disable=SC3044
+[ "${OIL_VERSION:-}" ] && shopt -s compat_array
+
 if [ "${1:-}" = "-" ]; then
   if [ $# -gt 1 ]; then shift; set -- "$0" "$@"; else set -- "$0"; fi
-  for i; do i="$i'" j=''
+  for i in "$@"; do i="$i'" j=''
     while [ "$i" ]; do j="$j${i%%\'*}'\''" && i=${i#*\'}; done
     set -- "$@" "'${j%????}'" && shift
   done
@@ -18,9 +21,10 @@
   exit 0
 fi
 
-export SHELLSPEC_VERSION='0.28.1'
-export SHELLSPEC_CWD=$PWD
+export SHELLSPEC_VERSION='0.29.0-dev'
+export SHELLSPEC_CWD="$PWD"
 export SHELLSPEC_PATH=''
+export SHELLSPEC_POSIX_PATH=''
 export SHELLSPEC_GRAMMAR_DSLS=''
 export SHELLSPEC_GRAMMAR_DIRECTIVES=''
 export SHELLSPEC_GRAMMAR_BLOCKS=''
@@ -30,7 +34,11 @@
 export SHELLSPEC_BUILTIN_PRINTF=''
 export SHELLSPEC_BUILTIN_PRINT=''
 export SHELLSPEC_BUILTIN_TYPESETF=''
-export SHELLSPEC_TIME=''
+export SHELLSPEC_BUILTIN_READARRAY=''
+export SHELLSPEC_SEEKABLE=''
+export SHELLSPEC_READ_DELIM=''
+export SHELLSPEC_YASH_ARRAY=''
+export SHELLSPEC_STRING_CONCAT=''
 export SHELLSPEC_LIST=''
 export SHELLSPEC_COUNT_FILE=''
 export SHELLSPEC_DEBUG_TRAP=''
@@ -38,7 +46,6 @@
 export SHELLSPEC_COVERAGE_SETUP=''
 export SHELLSPEC_COVERAGE_SHELL_OPTIONS=''
 export SHELLSPEC_KCOV_COMPATIBLE_SHELL=''
-export SHELLSPEC_OUTPUT_FD=9
 export SHELLSPEC_DEFECT_EMPTYPARAMS=''
 export SHELLSPEC_DEFECT_READONLY=''
 export SHELLSPEC_DEFECT_BUILTIN=''
@@ -46,24 +53,25 @@
 export SHELLSPEC_DEFECT_SHELLFLAG=''
 export SHELLSPEC_DEFECT_ERREXIT=''
 export SHELLSPEC_DEFECT_ZSHEXIT=''
+export SHELLSPEC_DEFECT_BOSHEXIT=''
 export SHELLSPEC_DEFECT_SUBSHELL=''
 export SHELLSPEC_DEFECT_SETE=''
 export SHELLSPEC_DEFECT_XTRACE=''
 export SHELLSPEC_DEFECT_EXPORTP=''
 export SHELLSPEC_DEFECT_SIGNAL=''
+export SHELLSPEC_DEFECT_DEBUGXS=''
 export SHELLSPEC_SHEBANG_MULTIARG=''
 export SHELLSPEC_BUSYBOX_W32=''
 export SHELLSPEC_SHOPT_AVAILABLE=''
 export SHELLSPEC_FAILGLOB_AVAILABLE=''
 export SHELLSPEC_NOMATCH_AVAILABLE=''
+export SHELLSPEC_FDVAR_AVAILABLE=''
 export SHELLSPEC_PATHSEP=":"
 export SHELLSPEC_REPAIR=''
 export SHELLSPEC_INFO=''
 export SHELLSPEC_TTY=''
 export SHELLSPEC_DEV_TTY="/dev/null"
-export SHELLSPEC_XTRACE_ON=''
-export SHELLSPEC_XTRACE_OFF=''
-export SHELLSPEC_XTRACEFD=2
+export SHELLSPEC_XTRACEFD=''
 export SHELLSPEC_XTRACEFD_VAR=''
 export SHELLSPEC_CLONE_TYPE=''
 export SHELLSPEC_PROC_VERSION='/proc/version'
@@ -80,9 +88,13 @@
 export SHELLSPEC_LS="ls"
 export SHELLSPEC_SORT="sort"
 export SHELLSPEC_FIND="find"
+export SHELLSPEC_OD="od"
+export SHELLSPEC_HEXDUMP="hexdump"
+
+SHELLSPEC_POSIX_PATH=$(getconf PATH 2>/dev/null) ||:
 
 #shellcheck disable=SC2039,SC3028
-export SHELLSPEC_HOSTNAME=${HOSTNAME:-localhost}
+export SHELLSPEC_HOSTNAME="${HOSTNAME:-localhost}"
 
 export SHELLSPEC_COLOR=''
 if [ ! "${NO_COLOR:-}" ] && { [ -t 1 ] || [ "${FORCE_COLOR:-}" ]; } then
@@ -118,6 +130,8 @@
 export SHELLSPEC_LIBEXEC="$SHELLSPEC_ROOT/libexec"
 export SHELLSPEC_INSPECTION="$SHELLSPEC_LIBEXEC/shellspec-inspection.sh"
 export SHELLSPEC_UNREADONLY_PATH="$SHELLSPEC_LIBEXEC/shellspec-unreadonly-path.sh"
+export SHELLSPEC_TIME_TYPE=auto
+export SHELLSPEC_TIME="$SHELLSPEC_LIBEXEC/shellspec-time.sh"
 
 # shellcheck source=lib/libexec/shellspec.sh
 . "$SHELLSPEC_LIB/libexec/shellspec.sh"
@@ -179,13 +193,14 @@
   SHELLSPEC_PROJECT_ROOT=${SHELLSPEC_PROJECT_ROOT%/*}
 done
 cd "${SHELLSPEC_PROJECT_ROOT:-.}"
+abspath SHELLSPEC_PROJECT_ROOT "$SHELLSPEC_PROJECT_ROOT"
 
 # option parsing
 {
   optparser parse_options error_message
 
   error_message() {
-    error "$1${options_file:+" [$options_file]"}"
+    error "$1${options_file:+ "[$options_file]"}"
   }
 
   options_file() {
@@ -221,6 +236,7 @@
   eval "set -- $params"
 }
 
+# shellcheck disable=SC2153
 case $SHELLSPEC_MODE in (init)
   SHELLSPEC_PROJECT_ROOT=${SHELLSPEC_PROJECT_ROOT:-$SHELLSPEC_CWD}
   helperdir=$SHELLSPEC_HELPERDIR
@@ -341,8 +357,13 @@
     warn "Unsupported shell (signal handling broken)."
   fi
 
-  [ "$SHELLSPEC_BUSYBOX_W32" ] && SHELLSPEC_PATHSEP=";"
-  [ "$SHELLSPEC_TTY" ] && SHELLSPEC_DEV_TTY=/dev/tty
+  if [ "$SHELLSPEC_BUSYBOX_W32" ]; then
+    SHELLSPEC_PATHSEP=";"
+  fi
+
+  if [ "$SHELLSPEC_TTY" ]; then
+    SHELLSPEC_DEV_TTY=/dev/tty
+  fi
 }
 
 setup_load_path
@@ -351,34 +372,34 @@
   warn "Some features may fail due to incompatibilities with sandbox features."
 fi
 
-# xtrace
-{
-  # shellcheck disable=SC2153
-  if [ "$SHELLSPEC_XTRACE" ]; then
-    if [ ! "$SHELLSPEC_XTRACE_ONLY" ]; then
-      [ "$SHELLSPEC_XTRACEFD_VAR" ] && SHELLSPEC_XTRACEFD=9
-      if [ "$SHELLSPEC_XTRACEFD" = "2" ] && SHELLSPEC_XTRACE_ONLY=1; then
-        warn "Fall back to trace-only mode. All expectations will be skipped."
-      fi
-    fi
+# Convert to absolute paths as needed for command-based mocks
+if [ "$SHELLSPEC_BUSYBOX_W32" ]; then
+  case $SHELLSPEC_SHELL in
+    */*) ;;
+    *) SHELLSPEC_SHELL="/bin/$SHELLSPEC_SHELL"
+  esac
+fi
 
-    if [ "$SHELLSPEC_DEFECT_XTRACE" ]; then
-      warn "If xtrace doesn't work, " \
-        'execute `set -x` manually inside the function.'
+# shellcheck disable=SC2153
+if [ "$SHELLSPEC_XTRACE" ]; then
+  if [ "$SHELLSPEC_XTRACE_ONLY" ]; then
+    SHELLSPEC_XTRACEFD=2
+  elif [ "$SHELLSPEC_XTRACEFD_VAR" ]; then
+    if [ "$SHELLSPEC_FDVAR_AVAILABLE" ]; then
+      SHELLSPEC_XTRACEFD=${SHELLSPEC_XTRACEFD:-"{SHELLSPEC_XTRACEFD}"}
+    else
+      # Busybox ash only?
+      SHELLSPEC_XTRACEFD=${SHELLSPEC_XTRACEFD:-8}
     fi
+  else
+    SHELLSPEC_XTRACE_ONLY=1 SHELLSPEC_XTRACEFD=2
+    warn "Fall back to trace-only mode. All expectations will be skipped."
   fi
 
-  if [ "$SHELLSPEC_DEFECT_XTRACE" = "2" ]; then
-    SHELLSPEC_XTRACE_ON='typeset -ft $(typeset +f); '
-    SHELLSPEC_XTRACE_OFF='typeset +ft $(typeset +f); '
-  else
-    if [ "$SHELLSPEC_XTRACEFD_VAR" ]; then
-      SHELLSPEC_XTRACE_ON="$SHELLSPEC_XTRACEFD_VAR=\$SHELLSPEC_XTRACEFD; "
-    fi
+  if [ "$SHELLSPEC_DEFECT_XTRACE" ]; then
+    warn "If xtrace doesn't work, execute 'set -x' manually inside a function."
   fi
-  SHELLSPEC_XTRACE_ON="${SHELLSPEC_XTRACE_ON}set -x"
-  SHELLSPEC_XTRACE_OFF=": @SHELLSPEC_XTRACE_OFF@; ${SHELLSPEC_XTRACE_OFF}set +x"
-}
+fi
 
 # resolve basic command path
 {
@@ -394,17 +415,8 @@
   command_path SHELLSPEC_LS "ls" ||:
   command_path SHELLSPEC_SORT "sort" ||:
   command_path SHELLSPEC_FIND "find" ||:
-
-  if command_path "time" || [ "$SHELLSPEC_BUSYBOX_W32" ]; then
-    SHELLSPEC_TIME="time -p"
-  else
-    SHELLSPEC_TIME="$SHELLSPEC_LIBEXEC/shellspec-time.sh"
-    if command_path bash; then
-      SHELLSPEC_TIME="bash $SHELLSPEC_TIME"
-    elif command_path ksh; then
-      SHELLSPEC_TIME="ksh $SHELLSPEC_TIME"
-    fi
-  fi
+  command_path SHELLSPEC_OD "od" ||:
+  command_path SHELLSPEC_HEXDUMP "hexdump" ||:
 }
 
 if ! signal 0 $$ 2>/dev/null; then
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/.circleci/config.yml new/.circleci/config.yml
--- old/.circleci/config.yml	2021-01-11 06:25:23.000000000 +0100
+++ new/.circleci/config.yml	1970-01-01 01:00:00.000000000 +0100
@@ -1,59 +0,0 @@
-version: 2
-jobs:
-  lint:
-    docker:
-      - image: koalaman/shellcheck-alpine:v0.7.1
-    steps:
-      - checkout
-      - run: shellcheck shellspec $(find lib libexec spec examples -name '*.sh')
-  test:
-    working_directory: ~/shellspec
-    docker:
-      - image: alpine
-    steps:
-      - run: apk add --no-progress --no-cache ca-certificates
-      - checkout
-      - run: ./shellspec --task fixture:stat:prepare
-      - run: ./shellspec -o tap -o junit
-      - run:
-          command: |
-            mkdir -p ~/report/shellspec
-            cp report/results_junit.xml ~/report/shellspec/
-          when: always
-      - store_test_results:
-          path: ~/report
-      - store_artifacts:
-          path: report
-  coverage:
-    working_directory: ~/shellspec
-    docker:
-      - image: shellspec/kcov
-    steps:
-      - checkout
-      - run: ./shellspec --task fixture:stat:prepare
-      - run: ./shellspec --kcov
-      - store_artifacts:
-          path: coverage
-workflows:
-  version: 2
-  lint_test_and_coverage:
-    jobs:
-      - lint
-      - test
-      - coverage:
-          requires:
-            - lint
-            - test
-  daily_update_schedule:
-    jobs:
-      - lint
-      - coverage:
-          requires:
-            - lint
-    triggers:
-      - schedule:
-          cron: "0 0 * * *"
-          filters:
-            branches:
-              only:
-                - master
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/.cirrus.yml new/.cirrus.yml
--- old/.cirrus.yml	2021-01-11 06:25:23.000000000 +0100
+++ new/.cirrus.yml	1970-01-01 01:00:00.000000000 +0100
@@ -1,80 +0,0 @@
-env:
-  FORCE_COLOR: 1
-
-freebsd_task:
-  freebsd_instance:
-    matrix:
-      - image: freebsd-10-4-release-amd64
-      - image_family: freebsd-11-4
-      - image_family: freebsd-12-2
-      # - image_family: freebsd-13-0-snap
-  install_script: pkg install -y dash bash zsh ksh93 mksh oksh
-  prepare_script:
-    - ./shellspec --task fixture:stat:prepare
-  script:
-    - contrib/all.sh contrib/various_test.sh
-
-# gitbash_task:
-#   timeout_in: 120m
-#   windows_container:
-#     image: cirrusci/windowsservercore:2019
-#     os_version: 2019
-#   env:
-#     PATH: $ProgramFiles\Git\bin;$PATH
-#   install_script:
-#     - git --version
-#   prepare_script:
-#     - bash -c "env | grep -E '^(LC_|LANG|CYGWIN|MSYS)'"
-#     - bash -c "mount"
-#     - bash -c "./shellspec --task fixture:stat:prepare"
-#   script:
-#     - bash -c "contrib/all.sh shellspec"
-
-# msys_task:
-#   timeout_in: 120m
-#   windows_container:
-#     image: cirrusci/windowsservercore:2019
-#     os_version: 2019
-#   env:
-#     PATH: C:\tools\msys64\usr\bin;$PATH
-#   install_script:
-#     - choco install -y --no-progress msys2
-#     - pacman.exe -Syu --noprogressbar --noconfirm
-#     - pacman.exe -S --noprogressbar --noconfirm dash bash busybox mksh zsh
-#     - pacman.exe -Q
-#   prepare_script:
-#     - bash -c "env | grep -E '^(LC_|LANG|CYGWIN|MSYS)'"
-#     - bash -c "mount"
-#     - bash -c "./shellspec --task fixture:stat:prepare"
-#   script:
-#     - bash -c "contrib/all.sh shellspec"
-
-# cygwin_task:
-#   timeout_in: 120m
-#   windows_container:
-#     image: cirrusci/windowsservercore:2019
-#     os_version: 2019
-#   env:
-#     PATH: C:\tools\cygwin\bin;$PATH
-#   install_script:
-#     - choco install -y --no-progress cygwin cyg-get
-#     - cyg-get nc dash bash busybox mksh posh zsh
-#     - cygcheck -c
-#   prepare_script:
-#     - bash -c "env | grep -E '^(LC_|LANG|CYGWIN|MSYS)'"
-#     - bash -c "mount"
-#     - bash -c "./shellspec --task fixture:stat:prepare"
-#     # I don't know why but tests using below files fail in cirrus ci environment.
-#     - bash -c "rm -f ./spec/fixture/stat/{readable,writable}"
-#   script:
-#     - bash -c 'contrib/all.sh shellspec'
-
-# busybox_task:
-#   timeout_in: 120m
-#   windows_container:
-#     image: cirrusci/windowsservercore:2019
-#     os_version: 2019
-#   install_script:
-#     - choco install -y --no-progress busybox
-#   script:
-#     - busybox ash -c "contrib/all.sh shellspec"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/almalinux-8.9-20240410-sh-4.4.20 new/dockerfiles/almalinux-8.9-20240410-sh-4.4.20
--- old/dockerfiles/almalinux-8.9-20240410-sh-4.4.20	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/almalinux-8.9-20240410-sh-4.4.20	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM almalinux:8.9-20240410
+RUN useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/almalinux-9.4-20240506-sh-5.1.8 new/dockerfiles/almalinux-9.4-20240506-sh-5.1.8
--- old/dockerfiles/almalinux-9.4-20240506-sh-5.1.8	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/almalinux-9.4-20240506-sh-5.1.8	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM almalinux:9.4-20240506
+RUN useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/alpine-3.12.3-bash-5.0.17 new/dockerfiles/alpine-3.12.3-bash-5.0.17
--- old/dockerfiles/alpine-3.12.3-bash-5.0.17	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/alpine-3.12.3-bash-5.0.17	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM alpine:3.12.3
-RUN adduser -D user && apk add --no-cache bash
-ENV SH=/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/alpine-3.12.3-loksh-6.7.1 new/dockerfiles/alpine-3.12.3-loksh-6.7.1
--- old/dockerfiles/alpine-3.12.3-loksh-6.7.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/alpine-3.12.3-loksh-6.7.1	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM alpine:3.12.3
-RUN adduser -D user && apk add --no-cache loksh
-ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/alpine-3.12.3-sh-1.31.1 new/dockerfiles/alpine-3.12.3-sh-1.31.1
--- old/dockerfiles/alpine-3.12.3-sh-1.31.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/alpine-3.12.3-sh-1.31.1	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM alpine:3.12.3
-RUN adduser -D user
-ENV SH=/bin/ash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/alpine-3.19.1-loksh-7.4 new/dockerfiles/alpine-3.19.1-loksh-7.4
--- old/dockerfiles/alpine-3.19.1-loksh-7.4	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/alpine-3.19.1-loksh-7.4	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM alpine:3.19.1
+RUN adduser -D user && apk add --no-cache loksh
+ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/alpine-3.19.1-oksh-7.4 new/dockerfiles/alpine-3.19.1-oksh-7.4
--- old/dockerfiles/alpine-3.19.1-oksh-7.4	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/alpine-3.19.1-oksh-7.4	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM alpine:3.19.1
+RUN adduser -D user && apk add --no-cache oksh
+ENV SH=/bin/oksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/alpine-3.19.1-sh-1.36.1 new/dockerfiles/alpine-3.19.1-sh-1.36.1
--- old/dockerfiles/alpine-3.19.1-sh-1.36.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/alpine-3.19.1-sh-1.36.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM alpine:3.19.1
+RUN adduser -D user
+ENV SH=/bin/ash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/alpine-edge-loksh-6.8.1 new/dockerfiles/alpine-edge-loksh-6.8.1
--- old/dockerfiles/alpine-edge-loksh-6.8.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/alpine-edge-loksh-6.8.1	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM alpine:edge
-RUN adduser -D user && apk add --no-cache loksh
-ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/alpine-edge-loksh-7.5 new/dockerfiles/alpine-edge-loksh-7.5
--- old/dockerfiles/alpine-edge-loksh-7.5	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/alpine-edge-loksh-7.5	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM alpine:edge
+RUN adduser -D user && apk add --no-cache loksh
+ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/alpine-edge-oksh-6.8.1 new/dockerfiles/alpine-edge-oksh-6.8.1
--- old/dockerfiles/alpine-edge-oksh-6.8.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/alpine-edge-oksh-6.8.1	1970-01-01 01:00:00.000000000 +0100
@@ -1,4 +0,0 @@
-FROM alpine:edge
-RUN echo "@testing http://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories
-RUN adduser -D user && apk add --no-cache oksh@testing
-ENV SH=/bin/oksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/alpine-edge-oksh-7.5 new/dockerfiles/alpine-edge-oksh-7.5
--- old/dockerfiles/alpine-edge-oksh-7.5	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/alpine-edge-oksh-7.5	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM alpine:edge
+RUN adduser -D user && apk add --no-cache oksh
+ENV SH=/bin/oksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/bash-5.2.26 new/dockerfiles/bash-5.2.26
--- old/dockerfiles/bash-5.2.26	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/bash-5.2.26	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM bash:5.2.26
+RUN adduser -D user
+ENV SH=/usr/local/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/bash-5.3-alpha new/dockerfiles/bash-5.3-alpha
--- old/dockerfiles/bash-5.3-alpha	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/bash-5.3-alpha	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM bash:5.3-alpha
+RUN adduser -D user
+ENV SH=/usr/local/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/bash-devel new/dockerfiles/bash-devel
--- old/dockerfiles/bash-devel	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/bash-devel	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM bash:devel
+RUN adduser -D user
+ENV SH=/usr/local/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/busybox-1.32.0-sh-1.32.0 new/dockerfiles/busybox-1.32.0-sh-1.32.0
--- old/dockerfiles/busybox-1.32.0-sh-1.32.0	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/busybox-1.32.0-sh-1.32.0	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM busybox:1.32.0
-RUN adduser -D user
-ENV SH=/bin/ash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/busybox-1.34.1-sh-1.34.1 new/dockerfiles/busybox-1.34.1-sh-1.34.1
--- old/dockerfiles/busybox-1.34.1-sh-1.34.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/busybox-1.34.1-sh-1.34.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM busybox:1.34.1
+RUN adduser -D user
+ENV SH=/bin/ash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/busybox-1.35.0-sh-1.35.0 new/dockerfiles/busybox-1.35.0-sh-1.35.0
--- old/dockerfiles/busybox-1.35.0-sh-1.35.0	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/busybox-1.35.0-sh-1.35.0	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM busybox:1.35.0
+RUN adduser -D user
+ENV SH=/bin/ash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/busybox-1.36.1-sh-1.36.1 new/dockerfiles/busybox-1.36.1-sh-1.36.1
--- old/dockerfiles/busybox-1.36.1-sh-1.36.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/busybox-1.36.1-sh-1.36.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM busybox:1.36.1
+RUN adduser -D user
+ENV SH=/bin/ash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/centos-8.3.2011-sh-4.4.19 new/dockerfiles/centos-8.3.2011-sh-4.4.19
--- old/dockerfiles/centos-8.3.2011-sh-4.4.19	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/centos-8.3.2011-sh-4.4.19	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM centos:8.3.2011
-RUN useradd -m user
-ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/centos-8.3.2011-zsh-5.5.1 new/dockerfiles/centos-8.3.2011-zsh-5.5.1
--- old/dockerfiles/centos-8.3.2011-zsh-5.5.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/centos-8.3.2011-zsh-5.5.1	1970-01-01 01:00:00.000000000 +0100
@@ -1,4 +0,0 @@
-FROM centos:8.3.2011
-RUN rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
-RUN useradd -m user && yum -y install zsh
-ENV SH=/usr/bin/zsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/centos-8.4.2105-sh-4.4.19 new/dockerfiles/centos-8.4.2105-sh-4.4.19
--- old/dockerfiles/centos-8.4.2105-sh-4.4.19	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/centos-8.4.2105-sh-4.4.19	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM centos:8.4.2105
+RUN useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/centos-8.4.2105-zsh-5.5.1 new/dockerfiles/centos-8.4.2105-zsh-5.5.1
--- old/dockerfiles/centos-8.4.2105-zsh-5.5.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/centos-8.4.2105-zsh-5.5.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,7 @@
+FROM centos:8.4.2105
+RUN rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
+RUN useradd -m user \
+ && sed -i -e 's|^mirrorlist|#mirrorlist|g' /etc/yum.repos.d/CentOS-*repo \
+ && sed -i -e 's|^#baseurl=http://mirror|baseurl=http://vault|g' /etc/yum.repos.d/CentOS-*repo \
+ && yum -y install zsh
+ENV SH=/usr/bin/zsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/centos-stream8-sh-4.4.20 new/dockerfiles/centos-stream8-sh-4.4.20
--- old/dockerfiles/centos-stream8-sh-4.4.20	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/centos-stream8-sh-4.4.20	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM quay.io/centos/centos:stream8
+RUN useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/centos-stream9-sh-6.1.8 new/dockerfiles/centos-stream9-sh-6.1.8
--- old/dockerfiles/centos-stream9-sh-6.1.8	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/centos-stream9-sh-6.1.8	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM quay.io/centos/centos:stream9
+RUN useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/chimera-latest-sh new/dockerfiles/chimera-latest-sh
--- old/dockerfiles/chimera-latest-sh	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/chimera-latest-sh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,4 @@
+FROM chimeralinux/chimera
+RUN apk update && apk add shadow bsdtar
+RUN useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/.coverage new/dockerfiles/.coverage
--- old/dockerfiles/.coverage	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/.coverage	2025-12-23 15:20:28.000000000 +0100
@@ -1,4 +1,20 @@
-FROM shellspec/kcov
-RUN apt-get update && apt-get install -y netcat-openbsd
+FROM alpine:3.20 as builder
+RUN apk add --no-cache build-base cmake ninja python3 \
+      binutils-dev curl-dev elfutils-dev
 WORKDIR /root
+ENV KCOV=https://github.com/SimonKagstrom/kcov/archive/refs/tags/v42.tar.gz
+RUN wget -q $KCOV -O - | tar xz -C ./ --strip-components 1
+RUN mkdir build && cd build \
+ && CXXFLAGS="-D__ptrace_request=int" cmake -G Ninja .. \
+ && cmake --build . --target install
+
+FROM alpine:3.20 as kcov
+RUN apk add --no-cache bash python3 binutils-dev curl-dev elfutils-libelf libdw
+COPY --from=builder /usr/local/bin/kcov* /usr/local/bin/
+COPY --from=builder /usr/local/share/doc/kcov /usr/local/share/doc/kcov
+CMD ["/usr/local/bin/kcov"]
+
+FROM kcov
+RUN apk add --no-cache netcat-openbsd
+WORKDIR /shellspec
 COPY ./ ./
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.13-bash-5.0.3 new/dockerfiles/debian-10.13-bash-5.0.3
--- old/dockerfiles/debian-10.13-bash-5.0.3	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-10.13-bash-5.0.3	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,4 @@
+FROM debian:10.13-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user
+ENV SH=/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.13-busybox-1.30.1 new/dockerfiles/debian-10.13-busybox-1.30.1
--- old/dockerfiles/debian-10.13-busybox-1.30.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-10.13-busybox-1.30.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,6 @@
+FROM debian:10.13-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install busybox \
+ && /bin/busybox --install -s
+ENV SH=/bin/ash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.13-dash-0.5.10.2 new/dockerfiles/debian-10.13-dash-0.5.10.2
--- old/dockerfiles/debian-10.13-dash-0.5.10.2	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-10.13-dash-0.5.10.2	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,4 @@
+FROM debian:10.13-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user
+ENV SH=/bin/dash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.13-ksh-93u new/dockerfiles/debian-10.13-ksh-93u
--- old/dockerfiles/debian-10.13-ksh-93u	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-10.13-ksh-93u	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:10.13-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install ksh
+ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.13-lksh-57 new/dockerfiles/debian-10.13-lksh-57
--- old/dockerfiles/debian-10.13-lksh-57	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-10.13-lksh-57	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:10.13-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install mksh
+ENV SH=/bin/lksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.13-mksh-57 new/dockerfiles/debian-10.13-mksh-57
--- old/dockerfiles/debian-10.13-mksh-57	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-10.13-mksh-57	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:10.13-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install mksh
+ENV SH=/bin/mksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.13-posh-0.13.2 new/dockerfiles/debian-10.13-posh-0.13.2
--- old/dockerfiles/debian-10.13-posh-0.13.2	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-10.13-posh-0.13.2	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:10.13-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install posh procps
+ENV SH=/usr/bin/posh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.13-yash-2.48 new/dockerfiles/debian-10.13-yash-2.48
--- old/dockerfiles/debian-10.13-yash-2.48	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-10.13-yash-2.48	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:10.13-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install yash
+ENV SH=/usr/bin/yash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.13-zsh-5.7.1 new/dockerfiles/debian-10.13-zsh-5.7.1
--- old/dockerfiles/debian-10.13-zsh-5.7.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-10.13-zsh-5.7.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:10.13-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install zsh
+ENV SH=/usr/bin/zsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.7-bash-5.0.3 new/dockerfiles/debian-10.7-bash-5.0.3
--- old/dockerfiles/debian-10.7-bash-5.0.3	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-10.7-bash-5.0.3	1970-01-01 01:00:00.000000000 +0100
@@ -1,4 +0,0 @@
-FROM debian:10.7-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user
-ENV SH=/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.7-busybox-1.30.1 new/dockerfiles/debian-10.7-busybox-1.30.1
--- old/dockerfiles/debian-10.7-busybox-1.30.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-10.7-busybox-1.30.1	1970-01-01 01:00:00.000000000 +0100
@@ -1,6 +0,0 @@
-FROM debian:10.7-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install busybox \
- && /bin/busybox --install -s
-ENV SH=/bin/ash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.7-dash-0.5.10.2 new/dockerfiles/debian-10.7-dash-0.5.10.2
--- old/dockerfiles/debian-10.7-dash-0.5.10.2	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-10.7-dash-0.5.10.2	1970-01-01 01:00:00.000000000 +0100
@@ -1,4 +0,0 @@
-FROM debian:10.7-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user
-ENV SH=/bin/dash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.7-ksh-93u new/dockerfiles/debian-10.7-ksh-93u
--- old/dockerfiles/debian-10.7-ksh-93u	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-10.7-ksh-93u	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:10.7-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install ksh
-ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.7-lksh-57 new/dockerfiles/debian-10.7-lksh-57
--- old/dockerfiles/debian-10.7-lksh-57	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-10.7-lksh-57	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:10.7-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install mksh
-ENV SH=/bin/lksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.7-mksh-57 new/dockerfiles/debian-10.7-mksh-57
--- old/dockerfiles/debian-10.7-mksh-57	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-10.7-mksh-57	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:10.7-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install mksh
-ENV SH=/bin/mksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.7-posh-0.13.2 new/dockerfiles/debian-10.7-posh-0.13.2
--- old/dockerfiles/debian-10.7-posh-0.13.2	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-10.7-posh-0.13.2	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:10.7-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install posh procps
-ENV SH=/usr/bin/posh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.7-yash-2.48 new/dockerfiles/debian-10.7-yash-2.48
--- old/dockerfiles/debian-10.7-yash-2.48	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-10.7-yash-2.48	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:10.7-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install yash
-ENV SH=/usr/bin/yash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-10.7-zsh-5.7.1 new/dockerfiles/debian-10.7-zsh-5.7.1
--- old/dockerfiles/debian-10.7-zsh-5.7.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-10.7-zsh-5.7.1	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:10.7-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install zsh
-ENV SH=/usr/bin/zsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-11.9-bash-5.1.4 new/dockerfiles/debian-11.9-bash-5.1.4
--- old/dockerfiles/debian-11.9-bash-5.1.4	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-11.9-bash-5.1.4	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,4 @@
+FROM debian:11.9-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user
+ENV SH=/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-11.9-busybox-1.30.1 new/dockerfiles/debian-11.9-busybox-1.30.1
--- old/dockerfiles/debian-11.9-busybox-1.30.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-11.9-busybox-1.30.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,6 @@
+FROM debian:11.9-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install busybox \
+ && /bin/busybox --install -s
+ENV SH=/bin/ash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-11.9-dash-0.5.11 new/dockerfiles/debian-11.9-dash-0.5.11
--- old/dockerfiles/debian-11.9-dash-0.5.11	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-11.9-dash-0.5.11	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,4 @@
+FROM debian:11.9-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user
+ENV SH=/bin/dash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-11.9-ksh-93u new/dockerfiles/debian-11.9-ksh-93u
--- old/dockerfiles/debian-11.9-ksh-93u	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-11.9-ksh-93u	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:11.9-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install ksh
+ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-11.9-lksh-59 new/dockerfiles/debian-11.9-lksh-59
--- old/dockerfiles/debian-11.9-lksh-59	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-11.9-lksh-59	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:11.9-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install mksh
+ENV SH=/bin/lksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-11.9-mksh-59 new/dockerfiles/debian-11.9-mksh-59
--- old/dockerfiles/debian-11.9-mksh-59	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-11.9-mksh-59	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:11.9-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install mksh
+ENV SH=/bin/mksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-11.9-posh-0.14.1 new/dockerfiles/debian-11.9-posh-0.14.1
--- old/dockerfiles/debian-11.9-posh-0.14.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-11.9-posh-0.14.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:11.9-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install posh procps
+ENV SH=/usr/bin/posh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-11.9-yash-2.50 new/dockerfiles/debian-11.9-yash-2.50
--- old/dockerfiles/debian-11.9-yash-2.50	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-11.9-yash-2.50	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:11.9-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install yash
+ENV SH=/usr/bin/yash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-11.9-zsh-5.8 new/dockerfiles/debian-11.9-zsh-5.8
--- old/dockerfiles/debian-11.9-zsh-5.8	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-11.9-zsh-5.8	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:11.9-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install zsh
+ENV SH=/usr/bin/zsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-12.5-bash-5.2.15 new/dockerfiles/debian-12.5-bash-5.2.15
--- old/dockerfiles/debian-12.5-bash-5.2.15	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-12.5-bash-5.2.15	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,4 @@
+FROM debian:12.5-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user
+ENV SH=/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-12.5-busybox-1.35.0 new/dockerfiles/debian-12.5-busybox-1.35.0
--- old/dockerfiles/debian-12.5-busybox-1.35.0	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-12.5-busybox-1.35.0	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,6 @@
+FROM debian:12.5-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install busybox \
+ && /bin/busybox --install -s
+ENV SH=/bin/ash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-12.5-dash-0.5.12 new/dockerfiles/debian-12.5-dash-0.5.12
--- old/dockerfiles/debian-12.5-dash-0.5.12	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-12.5-dash-0.5.12	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,4 @@
+FROM debian:12.5-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user
+ENV SH=/bin/dash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-12.5-ksh93um-1.0.4 new/dockerfiles/debian-12.5-ksh93um-1.0.4
--- old/dockerfiles/debian-12.5-ksh93um-1.0.4	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-12.5-ksh93um-1.0.4	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:12.5-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install ksh
+ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-12.5-lksh-59 new/dockerfiles/debian-12.5-lksh-59
--- old/dockerfiles/debian-12.5-lksh-59	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-12.5-lksh-59	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:12.5-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install mksh
+ENV SH=/bin/lksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-12.5-mksh-59 new/dockerfiles/debian-12.5-mksh-59
--- old/dockerfiles/debian-12.5-mksh-59	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-12.5-mksh-59	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:12.5-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install mksh
+ENV SH=/bin/mksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-12.5-posh-0.14.1 new/dockerfiles/debian-12.5-posh-0.14.1
--- old/dockerfiles/debian-12.5-posh-0.14.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-12.5-posh-0.14.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:12.5-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install posh procps
+ENV SH=/usr/bin/posh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-12.5-yash-2.52 new/dockerfiles/debian-12.5-yash-2.52
--- old/dockerfiles/debian-12.5-yash-2.52	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-12.5-yash-2.52	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:12.5-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install yash
+ENV SH=/usr/bin/yash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-12.5-zsh-5.9 new/dockerfiles/debian-12.5-zsh-5.9
--- old/dockerfiles/debian-12.5-zsh-5.9	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-12.5-zsh-5.9	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:12.5-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install zsh
+ENV SH=/usr/bin/zsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/.debian-4.0r9-ksh-93r-! new/dockerfiles/.debian-4.0r9-ksh-93r-!
--- old/dockerfiles/.debian-4.0r9-ksh-93r-!	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/.debian-4.0r9-ksh-93r-!	1970-01-01 01:00:00.000000000 +0100
@@ -1,6 +0,0 @@
-FROM debian/eol:etch-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && sed '/updates/s/^/# /' -i /etc/apt/sources.list \
- && apt-get update && apt-get -y install ksh
-ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-4.0r9-ksh-93r new/dockerfiles/debian-4.0r9-ksh-93r
--- old/dockerfiles/debian-4.0r9-ksh-93r	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-4.0r9-ksh-93r	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,6 @@
+FROM debian/eol:etch-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && sed '/updates/s/^/# /' -i /etc/apt/sources.list \
+ && apt-get update && apt-get -y install ksh
+ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-8.11-bash-4.3.30 new/dockerfiles/debian-8.11-bash-4.3.30
--- old/dockerfiles/debian-8.11-bash-4.3.30	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-8.11-bash-4.3.30	2025-12-23 15:20:28.000000000 +0100
@@ -1,4 +1,4 @@
-FROM debian:8.11-slim
+FROM debian/eol:jessie-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
 RUN useradd -m user
 ENV SH=/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-8.11-busybox-1.22.0 new/dockerfiles/debian-8.11-busybox-1.22.0
--- old/dockerfiles/debian-8.11-busybox-1.22.0	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-8.11-busybox-1.22.0	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:8.11-slim
+FROM debian/eol:jessie-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/security.debian.org/archive.debian.org/' /etc/apt/sources.list
+RUN sed -i '/jessie-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install busybox \
  && /bin/busybox --install -s
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-8.11-dash-0.5.7 new/dockerfiles/debian-8.11-dash-0.5.7
--- old/dockerfiles/debian-8.11-dash-0.5.7	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-8.11-dash-0.5.7	2025-12-23 15:20:28.000000000 +0100
@@ -1,4 +1,4 @@
-FROM debian:8.11-slim
+FROM debian/eol:jessie-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
 RUN useradd -m user
 ENV SH=/bin/dash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-8.11-ksh-93u new/dockerfiles/debian-8.11-ksh-93u
--- old/dockerfiles/debian-8.11-ksh-93u	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-8.11-ksh-93u	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:8.11-slim
+FROM debian/eol:jessie-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/security.debian.org/archive.debian.org/' /etc/apt/sources.list
+RUN sed -i '/jessie-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install ksh
 ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-8.11-lksh-50d new/dockerfiles/debian-8.11-lksh-50d
--- old/dockerfiles/debian-8.11-lksh-50d	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-8.11-lksh-50d	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:8.11-slim
+FROM debian/eol:jessie-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/security.debian.org/archive.debian.org/' /etc/apt/sources.list
+RUN sed -i '/jessie-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install mksh
 ENV SH=/bin/lksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-8.11-mksh-50d new/dockerfiles/debian-8.11-mksh-50d
--- old/dockerfiles/debian-8.11-mksh-50d	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-8.11-mksh-50d	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:8.11-slim
+FROM debian/eol:jessie-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/security.debian.org/archive.debian.org/' /etc/apt/sources.list
+RUN sed -i '/jessie-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install mksh
 ENV SH=/bin/mksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-8.11-posh-0.12.3 new/dockerfiles/debian-8.11-posh-0.12.3
--- old/dockerfiles/debian-8.11-posh-0.12.3	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-8.11-posh-0.12.3	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:8.11-slim
+FROM debian/eol:jessie-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/security.debian.org/archive.debian.org/' /etc/apt/sources.list
+RUN sed -i '/jessie-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install posh
 ENV SH=/bin/posh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-8.11-yash-2.36 new/dockerfiles/debian-8.11-yash-2.36
--- old/dockerfiles/debian-8.11-yash-2.36	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-8.11-yash-2.36	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:8.11-slim
+FROM debian/eol:jessie-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/security.debian.org/archive.debian.org/' /etc/apt/sources.list
+RUN sed -i '/jessie-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install yash
 ENV SH=/usr/bin/yash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-8.11-zsh-5.0.7 new/dockerfiles/debian-8.11-zsh-5.0.7
--- old/dockerfiles/debian-8.11-zsh-5.0.7	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-8.11-zsh-5.0.7	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:8.11-slim
+FROM debian/eol:jessie-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/security.debian.org/archive.debian.org/' /etc/apt/sources.list
+RUN sed -i '/jessie-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install zsh
 ENV SH=/usr/bin/zsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-9.13-bash-4.4.12 new/dockerfiles/debian-9.13-bash-4.4.12
--- old/dockerfiles/debian-9.13-bash-4.4.12	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-9.13-bash-4.4.12	2025-12-23 15:20:28.000000000 +0100
@@ -1,4 +1,4 @@
-FROM debian:9.13-slim
+FROM debian/eol:stretch-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
 RUN useradd -m user
 ENV SH=/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-9.13-busybox-1.22.0 new/dockerfiles/debian-9.13-busybox-1.22.0
--- old/dockerfiles/debian-9.13-busybox-1.22.0	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-9.13-busybox-1.22.0	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:9.13-slim
+FROM debian/eol:stretch-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list
+RUN sed -i '/stretch-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install busybox \
  && /bin/busybox --install -s
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-9.13-dash-0.5.8 new/dockerfiles/debian-9.13-dash-0.5.8
--- old/dockerfiles/debian-9.13-dash-0.5.8	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-9.13-dash-0.5.8	2025-12-23 15:20:28.000000000 +0100
@@ -1,4 +1,4 @@
-FROM debian:9.13-slim
+FROM debian/eol:stretch-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
 RUN useradd -m user
 ENV SH=/bin/dash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-9.13-ksh-93u new/dockerfiles/debian-9.13-ksh-93u
--- old/dockerfiles/debian-9.13-ksh-93u	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-9.13-ksh-93u	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:9.13-slim
+FROM debian/eol:stretch-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list
+RUN sed -i '/stretch-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install ksh
 ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-9.13-lksh-54 new/dockerfiles/debian-9.13-lksh-54
--- old/dockerfiles/debian-9.13-lksh-54	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-9.13-lksh-54	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:9.13-slim
+FROM debian/eol:stretch-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list
+RUN sed -i '/stretch-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install mksh
 ENV SH=/bin/lksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-9.13-mksh-54 new/dockerfiles/debian-9.13-mksh-54
--- old/dockerfiles/debian-9.13-mksh-54	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-9.13-mksh-54	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:9.13-slim
+FROM debian/eol:stretch-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list
+RUN sed -i '/stretch-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install mksh
 ENV SH=/bin/mksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-9.13-posh-0.12.6 new/dockerfiles/debian-9.13-posh-0.12.6
--- old/dockerfiles/debian-9.13-posh-0.12.6	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-9.13-posh-0.12.6	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:9.13-slim
+FROM debian/eol:stretch-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list
+RUN sed -i '/stretch-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install posh procps
 ENV SH=/bin/posh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-9.13-yash-2.43 new/dockerfiles/debian-9.13-yash-2.43
--- old/dockerfiles/debian-9.13-yash-2.43	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-9.13-yash-2.43	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:9.13-slim
+FROM debian/eol:stretch-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list
+RUN sed -i '/stretch-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install yash
 ENV SH=/usr/bin/yash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-9.13-zsh-5.3.1 new/dockerfiles/debian-9.13-zsh-5.3.1
--- old/dockerfiles/debian-9.13-zsh-5.3.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-9.13-zsh-5.3.1	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,7 @@
-FROM debian:9.13-slim
+FROM debian/eol:stretch-slim
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list
+RUN sed -i '/stretch-updates/d' /etc/apt/sources.list
 RUN useradd -m user \
  && apt-get update && apt-get -y install zsh
 ENV SH=/usr/bin/zsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-bullseye-bash-5.1.0 new/dockerfiles/debian-bullseye-bash-5.1.0
--- old/dockerfiles/debian-bullseye-bash-5.1.0	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-bullseye-bash-5.1.0	1970-01-01 01:00:00.000000000 +0100
@@ -1,4 +0,0 @@
-FROM debian:bullseye-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user
-ENV SH=/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-bullseye-dash-0.5.11 new/dockerfiles/debian-bullseye-dash-0.5.11
--- old/dockerfiles/debian-bullseye-dash-0.5.11	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-bullseye-dash-0.5.11	1970-01-01 01:00:00.000000000 +0100
@@ -1,4 +0,0 @@
-FROM debian:bullseye-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user
-ENV SH=/bin/dash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-bullseye-ksh-2020.0.0 new/dockerfiles/debian-bullseye-ksh-2020.0.0
--- old/dockerfiles/debian-bullseye-ksh-2020.0.0	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-bullseye-ksh-2020.0.0	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:bullseye-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install ksh
-ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-bullseye-lksh-59c new/dockerfiles/debian-bullseye-lksh-59c
--- old/dockerfiles/debian-bullseye-lksh-59c	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-bullseye-lksh-59c	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:bullseye-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install mksh
-ENV SH=/bin/lksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-bullseye-mksh-59c new/dockerfiles/debian-bullseye-mksh-59c
--- old/dockerfiles/debian-bullseye-mksh-59c	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-bullseye-mksh-59c	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:bullseye-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install mksh
-ENV SH=/bin/mksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-bullseye-posh-0.14.1 new/dockerfiles/debian-bullseye-posh-0.14.1
--- old/dockerfiles/debian-bullseye-posh-0.14.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-bullseye-posh-0.14.1	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:bullseye-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install posh procps
-ENV SH=/usr/bin/posh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-bullseye-yash-2.50 new/dockerfiles/debian-bullseye-yash-2.50
--- old/dockerfiles/debian-bullseye-yash-2.50	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-bullseye-yash-2.50	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:bullseye-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install yash
-ENV SH=/usr/bin/yash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-bullseye-zsh-5.8 new/dockerfiles/debian-bullseye-zsh-5.8
--- old/dockerfiles/debian-bullseye-zsh-5.8	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/debian-bullseye-zsh-5.8	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM debian:bullseye-slim
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install zsh
-ENV SH=/usr/bin/zsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-i18n-testing new/dockerfiles/debian-i18n-testing
--- old/dockerfiles/debian-i18n-testing	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-i18n-testing	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,7 @@
+FROM debian:12-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN apt-get update && apt-get install -y locales-all ksh mksh posh yash zsh
+RUN useradd -m user
+RUN rm -f /usr/bin/time /bin/time
+ENV LC_ALL=de_DE.utf8
+ENV SH=/bin/bash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/debian-trixie-yash-2.55 new/dockerfiles/debian-trixie-yash-2.55
--- old/dockerfiles/debian-trixie-yash-2.55	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/debian-trixie-yash-2.55	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM debian:trixie-slim
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install yash
+ENV SH=/usr/bin/yash
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/fedora-32-sh-5.0.11 new/dockerfiles/fedora-32-sh-5.0.11
--- old/dockerfiles/fedora-32-sh-5.0.11	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/fedora-32-sh-5.0.11	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM fedora:32
-RUN useradd -m user
-ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/fedora-33-sh-5.0.17 new/dockerfiles/fedora-33-sh-5.0.17
--- old/dockerfiles/fedora-33-sh-5.0.17	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/fedora-33-sh-5.0.17	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM fedora:33
-RUN useradd -m user
-ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/fedora-39-sh-5.2.26 new/dockerfiles/fedora-39-sh-5.2.26
--- old/dockerfiles/fedora-39-sh-5.2.26	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/fedora-39-sh-5.2.26	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM fedora:39
+RUN useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/fedora-40-sh-5.2.26 new/dockerfiles/fedora-40-sh-5.2.26
--- old/dockerfiles/fedora-40-sh-5.2.26	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/fedora-40-sh-5.2.26	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,3 @@
+FROM fedora:40
+RUN useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/gwsh-main new/dockerfiles/gwsh-main
--- old/dockerfiles/gwsh-main	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/gwsh-main	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,15 @@
+FROM buildpack-deps:bookworm as builder
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN apt-get update
+ENV URL=https://github.com/hvdijk/gwsh/archive/main.tar.gz
+RUN wget -nv -O- --trust-server-names "$URL" | tar xzf - --one-top-level=gwsh --strip-components=1 \
+ && ls -al \
+ && cd gwsh \
+ && ./autogen.sh \
+ && ./configure \
+ && make install
+
+FROM debian:bookworm-slim
+COPY --from=builder /usr/local/bin* /usr/local/bin/
+RUN useradd -m user
+ENV SH=/usr/local/bin/gwsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/gwsh-snapshot-20190627 new/dockerfiles/gwsh-snapshot-20190627
--- old/dockerfiles/gwsh-snapshot-20190627	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/gwsh-snapshot-20190627	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/gwsh:20190627
-RUN useradd -m user
-ENV SH=/usr/local/bin/gwsh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/lede-17.01.7-sh-1.25.1 new/dockerfiles/lede-17.01.7-sh-1.25.1
--- old/dockerfiles/lede-17.01.7-sh-1.25.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/lede-17.01.7-sh-1.25.1	2025-12-23 15:20:28.000000000 +0100
@@ -1,4 +1,14 @@
-FROM shellspec/lede:17.01.7
+FROM alpine as builder
+ENV base=https://downloads.openwrt.org/releases/17.01.7/targets/x86/64/
+ENV file=lede-17.01.7-x86-64-generic-rootfs.tar.gz
+RUN wget -q "${base}${file}"
+RUN mkdir /rootfs && tar xf "$file" -C /rootfs
+
+FROM scratch as base
+COPY --from=builder /rootfs/ /
+CMD ["/bin/sh"]
+
+FROM base
 RUN mkdir /var/lock /home \
  && opkg update && opkg install shadow-useradd \
  && useradd -m user
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/openwrt-10.03.1-sh-1.15.3-! new/dockerfiles/openwrt-10.03.1-sh-1.15.3-!
--- old/dockerfiles/openwrt-10.03.1-sh-1.15.3-!	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/openwrt-10.03.1-sh-1.15.3-!	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,15 @@
-FROM shellspec/openwrt:10.03.1
-RUN mkdir /var/lock /home \
- && opkg update && opkg install shadow-groupadd shadow-useradd \
- && groupadd user && useradd -m user -g user
+FROM alpine as builder
+ENV base=https://archive.openwrt.org/backfire/10.03.1/x86_generic/
+ENV file=openwrt-x86-generic-rootfs.tar.gz
+RUN wget -q "${base}${file}"
+RUN mkdir /rootfs && tar xf "$file" -C /rootfs
+
+FROM scratch as base
+COPY --from=builder /rootfs/ /
+CMD ["/bin/sh"]
+
+FROM base
+RUN mkdir -p /home/user \
+ && echo 'user:!:1000:' >> /etc/group \
+ && echo 'user:x:1000:1000::/home/user:' >> /etc/passwd
 ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/openwrt-12.09-sh-1.19.4-! new/dockerfiles/openwrt-12.09-sh-1.19.4-!
--- old/dockerfiles/openwrt-12.09-sh-1.19.4-!	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/openwrt-12.09-sh-1.19.4-!	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,15 @@
-FROM shellspec/openwrt:12.09
-RUN mkdir /var/lock /home \
- && opkg update && opkg install shadow-useradd \
- && useradd -m user
+FROM alpine as builder
+ENV base=https://archive.openwrt.org/attitude_adjustment/12.09/x86/generic/
+ENV file=openwrt-x86-generic-rootfs.tar.gz
+RUN wget -q "${base}${file}"
+RUN mkdir /rootfs && tar xf "$file" -C /rootfs
+
+FROM scratch as base
+COPY --from=builder /rootfs/ /
+CMD ["/bin/sh"]
+
+FROM base
+RUN mkdir -p /home/user \
+ && echo 'user:!:1000:' >> /etc/group \
+ && echo 'user:x:1000:1000::/home/user:' >> /etc/passwd
 ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/openwrt-14.07-sh-1.22.1 new/dockerfiles/openwrt-14.07-sh-1.22.1
--- old/dockerfiles/openwrt-14.07-sh-1.22.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/openwrt-14.07-sh-1.22.1	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,15 @@
-FROM shellspec/openwrt:14.07
-RUN mkdir /var/lock /home \
- && opkg update && opkg install shadow-useradd \
- && useradd -m user
+FROM alpine as builder
+ENV base=https://archive.openwrt.org/barrier_breaker/14.07/x86/generic/
+ENV file=openwrt-x86-generic-Generic-rootfs.tar.gz
+RUN wget -q "${base}${file}"
+RUN mkdir /rootfs && tar xf "$file" -C /rootfs
+
+FROM scratch as base
+COPY --from=builder /rootfs/ /
+CMD ["/bin/sh"]
+
+FROM base
+RUN mkdir -p /home/user \
+ && echo 'user:!:1000:' >> /etc/group \
+ && echo 'user:x:1000:1000::/home/user:' >> /etc/passwd
 ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/openwrt-15.05.1-sh-1.23.2 new/dockerfiles/openwrt-15.05.1-sh-1.23.2
--- old/dockerfiles/openwrt-15.05.1-sh-1.23.2	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/openwrt-15.05.1-sh-1.23.2	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,15 @@
-FROM shellspec/openwrt:15.05.1
-RUN mkdir /var/lock /home \
- && opkg update && opkg install shadow-useradd \
- && useradd -m user
+FROM alpine as builder
+ENV base=https://archive.openwrt.org/chaos_calmer/15.05.1/x86/generic/
+ENV file=openwrt-15.05.1-x86-generic-Generic-rootfs.tar.gz
+RUN wget -q "${base}${file}"
+RUN mkdir /rootfs && tar xf "$file" -C /rootfs
+
+FROM scratch as base
+COPY --from=builder /rootfs/ /
+CMD ["/bin/sh"]
+
+FROM base
+RUN mkdir -p /home/user \
+ && echo 'user:!:1000:' >> /etc/group \
+ && echo 'user:x:1000:1000::/home/user:' >> /etc/passwd
 ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/openwrt-18.06.9-sh-1.28.4 new/dockerfiles/openwrt-18.06.9-sh-1.28.4
--- old/dockerfiles/openwrt-18.06.9-sh-1.28.4	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/openwrt-18.06.9-sh-1.28.4	2025-12-23 15:20:28.000000000 +0100
@@ -1,4 +1,14 @@
-FROM shellspec/openwrt:18.06.9
+FROM alpine as builder
+ENV base=https://downloads.openwrt.org/releases/18.06.9/targets/x86/64/
+ENV file=openwrt-18.06.9-x86-64-generic-rootfs.tar.gz
+RUN wget -q "${base}${file}"
+RUN mkdir /rootfs && tar xf "$file" -C /rootfs
+
+FROM scratch as base
+COPY --from=builder /rootfs/ /
+CMD ["/bin/sh"]
+
+FROM base
 RUN mkdir /var/lock /home \
  && opkg update && opkg install shadow-useradd \
  && useradd -m user
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/openwrt-19.07.5-sh-1.30.1 new/dockerfiles/openwrt-19.07.5-sh-1.30.1
--- old/dockerfiles/openwrt-19.07.5-sh-1.30.1	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/openwrt-19.07.5-sh-1.30.1	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM shellspec/openwrt:19.07.5
-RUN mkdir /var/lock /home \
- && opkg update && opkg install shadow-useradd \
- && useradd -m user
-ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/openwrt-19.07.9-sh-1.30.1 new/dockerfiles/openwrt-19.07.9-sh-1.30.1
--- old/dockerfiles/openwrt-19.07.9-sh-1.30.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/openwrt-19.07.9-sh-1.30.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,15 @@
+FROM alpine as builder
+ENV base=https://downloads.openwrt.org/releases/19.07.9/targets/x86/64/
+ENV file=openwrt-19.07.9-x86-64-generic-rootfs.tar.gz
+RUN wget -q "${base}${file}"
+RUN mkdir /rootfs && tar xf "$file" -C /rootfs
+
+FROM scratch as base
+COPY --from=builder /rootfs/ /
+CMD ["/bin/sh"]
+
+FROM base
+RUN mkdir /var/lock /home \
+ && opkg update && opkg install shadow-useradd \
+ && useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/openwrt-21.02.7-sh-1.33.2 new/dockerfiles/openwrt-21.02.7-sh-1.33.2
--- old/dockerfiles/openwrt-21.02.7-sh-1.33.2	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/openwrt-21.02.7-sh-1.33.2	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,15 @@
+FROM alpine as builder
+ENV base=https://downloads.openwrt.org/releases/21.02.7/targets/x86/64/
+ENV file=openwrt-21.02.7-x86-64-rootfs.tar.gz
+RUN wget -q "${base}${file}"
+RUN mkdir /rootfs && tar xf "$file" -C /rootfs
+
+FROM scratch as base
+COPY --from=builder /rootfs/ /
+CMD ["/bin/sh"]
+
+FROM base
+RUN mkdir /var/lock /home \
+ && opkg update && opkg install shadow-useradd \
+ && useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/openwrt-22.03.6-sh-1.35.0 new/dockerfiles/openwrt-22.03.6-sh-1.35.0
--- old/dockerfiles/openwrt-22.03.6-sh-1.35.0	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/openwrt-22.03.6-sh-1.35.0	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,15 @@
+FROM alpine as builder
+ENV base=https://downloads.openwrt.org/releases/22.03.6/targets/x86/64/
+ENV file=openwrt-22.03.6-x86-64-rootfs.tar.gz
+RUN wget -q "${base}${file}"
+RUN mkdir /rootfs && tar xf "$file" -C /rootfs
+
+FROM scratch as base
+COPY --from=builder /rootfs/ /
+CMD ["/bin/sh"]
+
+FROM base
+RUN mkdir /var/lock /home \
+ && opkg update && opkg install shadow-useradd \
+ && useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/openwrt-23.05.3-sh-1.36.1 new/dockerfiles/openwrt-23.05.3-sh-1.36.1
--- old/dockerfiles/openwrt-23.05.3-sh-1.36.1	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/openwrt-23.05.3-sh-1.36.1	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,15 @@
+FROM alpine as builder
+ENV base=https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/
+ENV file=openwrt-23.05.3-x86-64-rootfs.tar.gz
+RUN wget -q "${base}${file}"
+RUN mkdir /rootfs && tar xf "$file" -C /rootfs
+
+FROM scratch as base
+COPY --from=builder /rootfs/ /
+CMD ["/bin/sh"]
+
+FROM base
+RUN mkdir /var/lock /home \
+ && opkg update && opkg install shadow-useradd \
+ && useradd -m user
+ENV SH=/bin/sh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20181030-bosh-20181007 new/dockerfiles/schily-20181030-bosh-20181007
--- old/dockerfiles/schily-20181030-bosh-20181007	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20181030-bosh-20181007	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2018-10-30
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20181030-pbosh-20181007 new/dockerfiles/schily-20181030-pbosh-20181007
--- old/dockerfiles/schily-20181030-pbosh-20181007	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20181030-pbosh-20181007	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2018-10-30
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20190311-bosh-20190205 new/dockerfiles/schily-20190311-bosh-20190205
--- old/dockerfiles/schily-20190311-bosh-20190205	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20190311-bosh-20190205	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2019-03-11
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20190311-pbosh-20190205 new/dockerfiles/schily-20190311-pbosh-20190205
--- old/dockerfiles/schily-20190311-pbosh-20190205	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20190311-pbosh-20190205	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2019-03-11
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20190922-bosh-20190825 new/dockerfiles/schily-20190922-bosh-20190825
--- old/dockerfiles/schily-20190922-bosh-20190825	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20190922-bosh-20190825	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2019-09-22
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20190922-pbosh-20190825 new/dockerfiles/schily-20190922-pbosh-20190825
--- old/dockerfiles/schily-20190922-pbosh-20190825	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20190922-pbosh-20190825	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2019-09-22
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20191007-bosh-20190927 new/dockerfiles/schily-20191007-bosh-20190927
--- old/dockerfiles/schily-20191007-bosh-20190927	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20191007-bosh-20190927	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2019-10-07
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20191007-pbosh-20190927 new/dockerfiles/schily-20191007-pbosh-20190927
--- old/dockerfiles/schily-20191007-pbosh-20190927	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20191007-pbosh-20190927	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2019-10-07
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20191025-bosh-20191025 new/dockerfiles/schily-20191025-bosh-20191025
--- old/dockerfiles/schily-20191025-bosh-20191025	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20191025-bosh-20191025	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2019-10-25
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20191025-pbosh-20191025 new/dockerfiles/schily-20191025-pbosh-20191025
--- old/dockerfiles/schily-20191025-pbosh-20191025	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20191025-pbosh-20191025	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2019-10-25
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20200211-bosh-20200124 new/dockerfiles/schily-20200211-bosh-20200124
--- old/dockerfiles/schily-20200211-bosh-20200124	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20200211-bosh-20200124	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-02-11
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20200211-pbosh-20200124 new/dockerfiles/schily-20200211-pbosh-20200124
--- old/dockerfiles/schily-20200211-pbosh-20200124	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20200211-pbosh-20200124	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-02-11
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20200327-bosh-20200325 new/dockerfiles/schily-20200327-bosh-20200325
--- old/dockerfiles/schily-20200327-bosh-20200325	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20200327-bosh-20200325	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-03-27
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20200327-pbosh-20200325 new/dockerfiles/schily-20200327-pbosh-20200325
--- old/dockerfiles/schily-20200327-pbosh-20200325	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20200327-pbosh-20200325	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-03-27
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20200418-bosh-20200410-! new/dockerfiles/schily-20200418-bosh-20200410-!
--- old/dockerfiles/schily-20200418-bosh-20200410-!	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20200418-bosh-20200410-!	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-04-18
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20200418-pbosh-20200410-! new/dockerfiles/schily-20200418-pbosh-20200410-!
--- old/dockerfiles/schily-20200418-pbosh-20200410-!	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20200418-pbosh-20200410-!	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-04-18
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20200511-bosh-20200427 new/dockerfiles/schily-20200511-bosh-20200427
--- old/dockerfiles/schily-20200511-bosh-20200427	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20200511-bosh-20200427	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-05-11
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20200511-pbosh-20200427 new/dockerfiles/schily-20200511-pbosh-20200427
--- old/dockerfiles/schily-20200511-pbosh-20200427	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20200511-pbosh-20200427	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-05-11
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20200904-bosh-20200903 new/dockerfiles/schily-20200904-bosh-20200903
--- old/dockerfiles/schily-20200904-bosh-20200903	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20200904-bosh-20200903	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-09-04
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20200904-pbosh-20200903 new/dockerfiles/schily-20200904-pbosh-20200903
--- old/dockerfiles/schily-20200904-pbosh-20200903	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20200904-pbosh-20200903	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-09-04
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20201009-bosh-20201007 new/dockerfiles/schily-20201009-bosh-20201007
--- old/dockerfiles/schily-20201009-bosh-20201007	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20201009-bosh-20201007	1970-01-01 01:00:00.000000000 +0100
@@ -1,4 +0,0 @@
-FROM shellspec/schilytools:2020-10-09
-RUN apt-get update && apt-get install -y procps
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20201009-pbosh-20201007 new/dockerfiles/schily-20201009-pbosh-20201007
--- old/dockerfiles/schily-20201009-pbosh-20201007	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20201009-pbosh-20201007	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-10-09
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20201104-bosh-20201104 new/dockerfiles/schily-20201104-bosh-20201104
--- old/dockerfiles/schily-20201104-bosh-20201104	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20201104-bosh-20201104	1970-01-01 01:00:00.000000000 +0100
@@ -1,4 +0,0 @@
-FROM shellspec/schilytools:2020-11-04
-RUN apt-get update && apt-get install -y procps
-RUN useradd -m user
-ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20201104-pbosh-20201104 new/dockerfiles/schily-20201104-pbosh-20201104
--- old/dockerfiles/schily-20201104-pbosh-20201104	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/schily-20201104-pbosh-20201104	1970-01-01 01:00:00.000000000 +0100
@@ -1,3 +0,0 @@
-FROM shellspec/schilytools:2020-11-04
-RUN useradd -m user
-ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20240321-bosh-20230112 new/dockerfiles/schily-20240321-bosh-20230112
--- old/dockerfiles/schily-20240321-bosh-20230112	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/schily-20240321-bosh-20230112	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,13 @@
+FROM buildpack-deps:bookworm as builder
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN apt-get update && apt-get -y install e2fslibs-dev
+ENV URL=https://codeberg.org/schilytools/schilytools/archive/2024-03-21.tar.gz
+RUN wget -nv -O- --trust-server-names "$URL" | tar xzf -
+WORKDIR schilytools
+RUN make install
+RUN /opt/schily/bin/bosh -c 'echo ${.sh.version}'
+
+FROM debian:bookworm-slim
+COPY --from=builder /opt/schily/bin/* /usr/local/bin/
+RUN useradd -m user
+ENV SH=/usr/local/bin/bosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/schily-20240321-pbosh-20230112 new/dockerfiles/schily-20240321-pbosh-20230112
--- old/dockerfiles/schily-20240321-pbosh-20230112	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/schily-20240321-pbosh-20230112	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,13 @@
+FROM buildpack-deps:bookworm as builder
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN apt-get update && apt-get -y install e2fslibs-dev
+ENV URL=https://codeberg.org/schilytools/schilytools/archive/2024-03-21.tar.gz
+RUN wget -nv -O- --trust-server-names "$URL" | tar xzf -
+WORKDIR schilytools
+RUN make install
+RUN /opt/schily/bin/bosh -c 'echo ${.sh.version}'
+
+FROM debian:bookworm-slim
+COPY --from=builder /opt/schily/bin/* /usr/local/bin/
+RUN useradd -m user
+ENV SH=/usr/local/bin/pbosh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/.shellspec new/dockerfiles/.shellspec
--- old/dockerfiles/.shellspec	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/.shellspec	2025-12-23 15:20:28.000000000 +0100
@@ -7,15 +7,16 @@
 WORKDIR /shellspec
 RUN chmod ug+s /usr/local/bin/su-exec \
  && echo "--no-banner" > /home/user/.shellspec-options \
- && if [ "$KCOV" ]; then echo "--kcov" >> /home/user/.shellspec-options; fi \
+ && echo '--kcov-options "--limits=50,75"' >> /home/user/.shellspec-options \
+ && if [ "$KCOV" ]; then echo '--kcov' >> /home/user/.shellspec-options; fi \
  && ln -s /shellspec/shellspec /usr/local/bin/shellspec \
  && echo "$SH" > /etc/invokesh.conf \
  && [ "$SH" = "/bin/sh" ] || ln -snf /usr/local/bin/invokesh /bin/sh
 
 ENTRYPOINT [ "/entrypoint.sh" ]
-CMD [ "shellspec" ]
+CMD [ "shellspec", "--fail-low-coverage" ]
 
-COPY ./dockerfiles/.shellspec-entrypoint.sh /entrypoint.sh
+COPY --chown=user:user ./dockerfiles/.shellspec-entrypoint.sh /entrypoint.sh
 COPY --chown=user:user ./ /shellspec
 RUN chmod 777 /shellspec
 USER user
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-12.04-ksh-93u new/dockerfiles/ubuntu-12.04-ksh-93u
--- old/dockerfiles/ubuntu-12.04-ksh-93u	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/ubuntu-12.04-ksh-93u	2025-12-23 15:20:28.000000000 +0100
@@ -1,5 +1,6 @@
 FROM ubuntu:12.04
 ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
 RUN useradd -m user \
+ && sed -i -e 's|//.*ubuntu.com/|//old-releases.ubuntu.com/|' /etc/apt/sources.list \
  && apt-get update && apt-get -y install ksh
 ENV SH=/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/.ubuntu-18.04-ksh-93um new/dockerfiles/.ubuntu-18.04-ksh-93um
--- old/dockerfiles/.ubuntu-18.04-ksh-93um	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/.ubuntu-18.04-ksh-93um	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,14 @@
+FROM buildpack-deps:18.04 as builder
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN apt-get update
+WORKDIR /root
+RUN git clone https://github.com/ksh93/ksh.git \
+ && cd ksh \
+ && bin/package make
+
+FROM ubuntu:18.04
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update
+COPY --from=builder /root/ksh/arch/linux.i386-64/bin /usr/local/bin
+ENV SH=/usr/local/bin/ksh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-19.10-kcov-36 new/dockerfiles/ubuntu-19.10-kcov-36
--- old/dockerfiles/ubuntu-19.10-kcov-36	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/ubuntu-19.10-kcov-36	1970-01-01 01:00:00.000000000 +0100
@@ -1,6 +0,0 @@
-FROM ubuntu:19.10
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && sed -i -E 's/(archive|security).ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list \
- && apt-get update && apt-get -y install kcov
-ENV SH=/bin/bash KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-20.04-kcov-38 new/dockerfiles/ubuntu-20.04-kcov-38
--- old/dockerfiles/ubuntu-20.04-kcov-38	2021-01-11 06:25:23.000000000 +0100
+++ new/dockerfiles/ubuntu-20.04-kcov-38	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-FROM ubuntu:20.04
-ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
-RUN useradd -m user \
- && apt-get update && apt-get -y install kcov
-ENV SH=/bin/bash KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-20.04-kcov-38-bash new/dockerfiles/ubuntu-20.04-kcov-38-bash
--- old/dockerfiles/ubuntu-20.04-kcov-38-bash	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/ubuntu-20.04-kcov-38-bash	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM ubuntu:20.04
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install kcov
+ENV SH=/bin/bash KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-20.04-kcov-38-ksh new/dockerfiles/ubuntu-20.04-kcov-38-ksh
--- old/dockerfiles/ubuntu-20.04-kcov-38-ksh	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/ubuntu-20.04-kcov-38-ksh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM ubuntu:20.04
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install kcov ksh93
+ENV SH=/bin/ksh KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-20.04-kcov-38-ksh2020 new/dockerfiles/ubuntu-20.04-kcov-38-ksh2020
--- old/dockerfiles/ubuntu-20.04-kcov-38-ksh2020	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/ubuntu-20.04-kcov-38-ksh2020	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM ubuntu:20.04
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install kcov ksh
+ENV SH=/bin/ksh KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-20.04-kcov-38-zsh new/dockerfiles/ubuntu-20.04-kcov-38-zsh
--- old/dockerfiles/ubuntu-20.04-kcov-38-zsh	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/ubuntu-20.04-kcov-38-zsh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,5 @@
+FROM ubuntu:20.04
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install kcov zsh
+ENV SH=/usr/bin/zsh KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/.ubuntu-20.04-ksh-93um new/dockerfiles/.ubuntu-20.04-ksh-93um
--- old/dockerfiles/.ubuntu-20.04-ksh-93um	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/.ubuntu-20.04-ksh-93um	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,14 @@
+FROM buildpack-deps:20.04 as builder
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN apt-get update
+WORKDIR /root
+RUN git clone https://github.com/ksh93/ksh.git \
+ && cd ksh \
+ && bin/package make
+
+FROM ubuntu:20.04
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user \
+ && apt-get update && apt-get -y install kcov
+COPY --from=builder /root/ksh/arch/linux.i386-64/bin /usr/local/bin
+ENV SH=/usr/local/bin/ksh KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/.ubuntu-20.04-osh-0.8.7 new/dockerfiles/.ubuntu-20.04-osh-0.8.7
--- old/dockerfiles/.ubuntu-20.04-osh-0.8.7	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/.ubuntu-20.04-osh-0.8.7	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,17 @@
+FROM buildpack-deps:20.04 as builder
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN apt-get update
+WORKDIR /root/oil
+RUN URL=https://www.oilshell.org/download/oil-0.8.7.tar.xz \
+ && curl -fsSL "$URL" | tar xvJ --strip-components 1 \
+ && ./configure \
+ && make \
+ && make install
+
+FROM ubuntu:20.04
+ENV DEBIAN_FRONTEND=noninteractive DEBCONF_NOWARNINGS=yes
+RUN useradd -m user && apt-get update
+RUN apt-get -y install libreadline8
+COPY --from=builder /usr/local/bin /usr/local/bin
+COPY --from=builder /usr/local/share /usr/local/share
+ENV SH=/usr/local/bin/osh
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-22.04-kcov-39 new/dockerfiles/ubuntu-22.04-kcov-39
--- old/dockerfiles/ubuntu-22.04-kcov-39	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/ubuntu-22.04-kcov-39	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,18 @@
+FROM buildpack-deps:22.04 AS builder
+RUN apt-get update && \
+    apt-get install -y cmake ninja-build libdw-dev libiberty-dev
+ENV URL="https://github.com/SimonKagstrom/kcov/archive/refs/tags/v39.tar.gz"
+WORKDIR /root/kcov
+RUN wget -O- "$URL" | tar xzv --transform 's|^[^/]*|src|'
+RUN mkdir src/build && \
+    cd src/build && \
+    cmake -G 'Ninja' .. && \
+    cmake --build . && \
+    cmake --build . --target install
+
+FROM ubuntu:22.04
+RUN apt-get update && apt-get install -y binutils libcurl4 libdw1
+COPY --from=builder /usr/local/bin/kcov* /usr/local/bin/
+COPY --from=builder /usr/local/share/doc/kcov /usr/local/share/doc/kcov
+RUN useradd -m user
+ENV SH=/bin/bash KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-22.04-kcov-40 new/dockerfiles/ubuntu-22.04-kcov-40
--- old/dockerfiles/ubuntu-22.04-kcov-40	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/ubuntu-22.04-kcov-40	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,18 @@
+FROM buildpack-deps:22.04 AS builder
+RUN apt-get update && \
+    apt-get install -y cmake ninja-build libdw-dev libiberty-dev
+ENV URL="https://github.com/SimonKagstrom/kcov/archive/refs/tags/v40.tar.gz"
+WORKDIR /root/kcov
+RUN wget -O- "$URL" | tar xzv --transform 's|^[^/]*|src|'
+RUN mkdir src/build && \
+    cd src/build && \
+    cmake -G 'Ninja' .. && \
+    cmake --build . && \
+    cmake --build . --target install
+
+FROM ubuntu:22.04
+RUN apt-get update && apt-get install -y binutils libcurl4 libdw1
+COPY --from=builder /usr/local/bin/kcov* /usr/local/bin/
+COPY --from=builder /usr/local/share/doc/kcov /usr/local/share/doc/kcov
+RUN useradd -m user
+ENV SH=/bin/bash KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-24.04-kcov-41 new/dockerfiles/ubuntu-24.04-kcov-41
--- old/dockerfiles/ubuntu-24.04-kcov-41	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/ubuntu-24.04-kcov-41	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,18 @@
+FROM buildpack-deps:24.04 AS builder
+RUN apt-get update && \
+    apt-get install -y cmake ninja-build libdw-dev libiberty-dev
+ENV URL="https://github.com/SimonKagstrom/kcov/archive/refs/tags/v41.tar.gz"
+WORKDIR /root/kcov
+RUN wget -O- "$URL" | tar xzv --transform 's|^[^/]*|src|'
+RUN mkdir src/build && \
+    cd src/build && \
+    cmake -G 'Ninja' .. && \
+    cmake --build . && \
+    cmake --build . --target install
+
+FROM ubuntu:24.04
+RUN apt-get update && apt-get install -y binutils libcurl4 libdw1
+COPY --from=builder /usr/local/bin/kcov* /usr/local/bin/
+COPY --from=builder /usr/local/share/doc/kcov /usr/local/share/doc/kcov
+RUN useradd -m user
+ENV SH=/bin/bash KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/dockerfiles/ubuntu-24.04-kcov-42 new/dockerfiles/ubuntu-24.04-kcov-42
--- old/dockerfiles/ubuntu-24.04-kcov-42	1970-01-01 01:00:00.000000000 +0100
+++ new/dockerfiles/ubuntu-24.04-kcov-42	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,18 @@
+FROM buildpack-deps:24.04 AS builder
+RUN apt-get update && \
+    apt-get install -y cmake ninja-build libdw-dev libiberty-dev
+ENV URL="https://github.com/SimonKagstrom/kcov/archive/refs/tags/v42.tar.gz"
+WORKDIR /root/kcov
+RUN wget -O- "$URL" | tar xzv --transform 's|^[^/]*|src|'
+RUN mkdir src/build && \
+    cd src/build && \
+    cmake -G 'Ninja' .. && \
+    cmake --build . && \
+    cmake --build . --target install
+
+FROM ubuntu:24.04
+RUN apt-get update && apt-get install -y binutils libcurl4 libdw1
+COPY --from=builder /usr/local/bin/kcov* /usr/local/bin/
+COPY --from=builder /usr/local/share/doc/kcov /usr/local/share/doc/kcov
+RUN useradd -m user
+ENV SH=/bin/bash KCOV=1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/.dockerignore new/.dockerignore
--- old/.dockerignore	2021-01-11 06:25:23.000000000 +0100
+++ new/.dockerignore	2025-12-23 15:20:28.000000000 +0100
@@ -17,3 +17,4 @@
 !Makefile
 !package.json
 !*.sh
+!.shellcheckrc
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/examples/count_lines.sh new/examples/count_lines.sh
--- old/examples/count_lines.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/examples/count_lines.sh	2025-12-23 15:20:28.000000000 +0100
@@ -13,7 +13,7 @@
 
 # When included from shellspec, __SOURCED__ variable defined and script
 # end here. The script path is assigned to the __SOURCED__ variable.
-${__SOURCED__:+return}
+${__SOURCED__:+false} : || return 0
 
 if [ "${1:-}" ]; then
   count_lines < "$1"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/install.sh new/install.sh
--- old/install.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/install.sh	2025-12-23 15:20:28.000000000 +0100
@@ -113,6 +113,7 @@
 
 git_remote_tags() {
   git ls-remote --tags "$repo" | while read -r line; do
+    # shellcheck disable=SC2295
     tag=${line##*/} && pre=${tag#${tag%%[-+]*}}
     [ "${1:-}" = "--pre" ] || case $pre in (-*) continue; esac
     echo "${tag%\^\{\}}"
@@ -130,7 +131,7 @@
 
 version_sort() {
   while read -r version; do
-    ver=${version%%+*} && num=${ver%%-*} && pre=${ver#$num}
+    ver=${version%%+*} && num=${ver%%-*} && pre=${ver#"$num"}
     #shellcheck disable=SC2086
     case $num in
       *[!0-9.]*)  set -- 0 0 0 0 ;;
@@ -165,7 +166,7 @@
   get_versions | version_sort | last
 }
 
-${__SOURCED__:+return}
+${__SOURCED__:+false} : || return 0
 
 trap finished EXIT
 VERSION='' PREFIX=$HOME/.local BIN='' DIR='' SWITCH='' PRE='' YES='' FETCH=''
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/bootstrap.sh new/lib/bootstrap.sh
--- old/lib/bootstrap.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/bootstrap.sh	2025-12-23 15:20:28.000000000 +0100
@@ -3,12 +3,20 @@
 shellspec() { echo '#'; }
 
 # Disable verbose_errexit by default for osh
-# shellcheck disable=SC2039
+# shellcheck disable=SC3044
 shopt -u verbose_errexit 2>/dev/null ||:
 
 # shellcheck source=lib/general.sh
 . "$SHELLSPEC_LIB/general.sh"
 
+# Load timeout parser
+if [ -f "$SHELLSPEC_LIB/libexec/timeout-parser.sh" ]; then
+  # shellcheck source=lib/libexec/timeout-parser.sh
+  . "$SHELLSPEC_LIB/libexec/timeout-parser.sh"
+else
+  shellspec_parse_timeout() { echo "${1:-${SHELLSPEC_TIMEOUT:-60}}"; }
+fi
+
 # Workaround for ksh #40 in contrib/bugs.sh
 if [ "$SHELLSPEC_DEFECT_REDEFINE" ]; then
   shellspec_redefinable() { eval "alias $1='shellspec_redefinable_ $1'"; }
@@ -74,10 +82,23 @@
   shellspec_profile_end() { :; }
 fi
 shellspec_profile_wait() {
-  echo '=' > "$SHELLSPEC_PROFILER_SIGNAL"
+  echo '=' >| "$SHELLSPEC_PROFILER_SIGNAL"
   while [ -s "$SHELLSPEC_PROFILER_SIGNAL" ]; do :; done
 }
 
+SHELLSPEC_XTRACE_ON='' SHELLSPEC_XTRACE_OFF=''
+
+if [ "$SHELLSPEC_DEFECT_XTRACE" = "2" ]; then
+  SHELLSPEC_XTRACE_ON='typeset -ft $(typeset +f); '
+  SHELLSPEC_XTRACE_OFF='typeset +ft $(typeset +f); '
+else
+  if [ "$SHELLSPEC_XTRACEFD_VAR" ]; then
+    SHELLSPEC_XTRACE_ON="$SHELLSPEC_XTRACEFD_VAR=\$SHELLSPEC_XTRACEFD; "
+  fi
+fi
+SHELLSPEC_XTRACE_ON="${SHELLSPEC_XTRACE_ON}set -x"
+SHELLSPEC_XTRACE_OFF=": @SHELLSPEC_XTRACE_OFF@; ${SHELLSPEC_XTRACE_OFF}set +x"
+
 #shellcheck disable=SC2034
 case $- in
   *e*) SHELLSPEC_ERREXIT="-e" ;;
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/clone.sh new/lib/core/clone.sh
--- old/lib/core/clone.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/clone.sh	2025-12-23 15:20:28.000000000 +0100
@@ -15,10 +15,12 @@
 }
 
 shellspec_clone_unset() {
-  for shellspec_clone; do
-    set -- "$@" "${1#*:}"
-    shift
-  done
+  if [ $# -gt 0 ]; then
+    for shellspec_clone in "$@"; do
+      set -- "$@" "${1#*:}"
+      shift
+    done
+  fi
   echo unset "$@" "||:"
 }
 
@@ -38,7 +40,7 @@
   shellspec_putsn "$2=$shellspec_clone"
 }
 
-# bash >= 2.03
+# bash >= 2.03 (exclude 2.05 - 3.00)
 shellspec_clone_bash() {
   shellspec_clone_typeset -p "$1" | {
     IFS= read -r shellspec_clone || return 1
@@ -48,6 +50,20 @@
       shellspec_putsn "$shellspec_clone"
     done
   }
+}
+
+# bash 2.05 - 3.00
+shellspec_clone_old_bash() {
+  shellspec_clone_typeset -p "$1" | {
+    IFS= read -r shellspec_clone || return 1
+    shellspec_clone=${shellspec_clone%\\}
+    set -- "$shellspec_clone" "$1" "$2"
+    shellspec_putsn "${1%%\ "$2="*} $3=${1#*\ "$2="}"
+    while IFS= read -r shellspec_clone; do
+      shellspec_clone=${shellspec_clone%\\}
+      shellspec_putsn "$shellspec_clone"
+    done
+  }
 }
 
 # zsh >= 4.2.5
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/core.sh new/lib/core/core.sh
--- old/lib/core/core.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/core.sh	2025-12-23 15:20:28.000000000 +0100
@@ -5,6 +5,7 @@
 
 shellspec_import "core/clone"
 shellspec_import "core/utils"
+shellspec_import "core/file_descriptor"
 shellspec_import "core/switch"
 shellspec_import "core/output"
 shellspec_import "core/outputs"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/dsl.sh new/lib/core/dsl.sh
--- old/lib/core/dsl.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/dsl.sh	2025-12-23 15:20:28.000000000 +0100
@@ -27,6 +27,7 @@
 SHELLSPEC_PENDING_REASON=''
 SHELLSPEC_SHELL_OPTIONS=''
 SHELLSPEC_HOOK_ERROR=''
+SHELLSPEC_USE_FDS=''
 
 shellspec_group_id() {
   # shellcheck disable=SC2034
@@ -39,17 +40,11 @@
 }
 
 shellspec_metadata() {
-  if [ "${1:-}" ]; then
-    shellspec_output METADATA
-  fi
+  shellspec_output METADATA
 }
 
 shellspec_finished() {
-  if [ "${1:-}" ]; then
-    shellspec_output FINISHED
-  else
-    shellspec_output_to_fd shellspec_putsn
-  fi
+  shellspec_output FINISHED
 }
 
 shellspec_yield() {
@@ -195,24 +190,86 @@
     return 0
   fi
 
+  # Timeout setup
+  SHELLSPEC_TIMEOUT_SIGNAL_FILE="$SHELLSPEC_STDIO_FILE_BASE.timeout_signal"
+  SHELLSPEC_TIMEOUT_RESULT_FILE="$SHELLSPEC_STDIO_FILE_BASE.timeout_result"
+  shellspec_effective_timeout="${SHELLSPEC_EXAMPLE_TIMEOUT:-${SHELLSPEC_TIMEOUT:-60}}"
+  shellspec_timeout_seconds=$(shellspec_parse_timeout "$shellspec_effective_timeout")
+
+  if [ "$shellspec_timeout_seconds" -gt 0 ]; then
+    : > "$SHELLSPEC_TIMEOUT_SIGNAL_FILE"
+    : > "$SHELLSPEC_TIMEOUT_RESULT_FILE"
+  fi
+
   shellspec_profile_start
   case $- in
     *e*) eval "set -- -e ${1+\"\$@\"}" ;;
     *) eval "set -- +e ${1+\"\$@\"}" ;;
   esac
+  shellspec_open_file_descriptors "$SHELLSPEC_USE_FDS"
   set +e
-  ( set -e
-    shift
-    case $# in
-      0) shellspec_invoke_example 3>&2 ;;
-      *) shellspec_invoke_example "$@" 3>&2 ;;
-    esac
-  )
-  set "$1" -- $? "$SHELLSPEC_LEAK_FILE"
+
+  # Execute test with timeout watchdog
+  if [ "$shellspec_timeout_seconds" -gt 0 ]; then
+    ( set -e
+      shift
+      case $# in
+        0) shellspec_invoke_example ;;
+        *) shellspec_invoke_example "$@" ;;
+      esac
+    ) &
+    shellspec_test_pid=$!
+
+    # Start watchdog in background
+    ( "$SHELLSPEC_SHELL" "$SHELLSPEC_LIBEXEC/shellspec-timeout-watchdog.sh" \
+      "$shellspec_timeout_seconds" "$shellspec_test_pid" \
+      "$SHELLSPEC_TIMEOUT_SIGNAL_FILE" "$SHELLSPEC_TIMEOUT_RESULT_FILE" \
+    ) &
+
+    # Wait for test to complete
+    wait "$shellspec_test_pid"
+    shellspec_exit_status=$?
+
+    # Signal watchdog to stop
+    shellspec_rm -f "$SHELLSPEC_TIMEOUT_SIGNAL_FILE"
+
+    # Check for timeout
+    if [ -s "$SHELLSPEC_TIMEOUT_RESULT_FILE" ]; then
+      shellspec_exit_status=124
+      shellspec_timeout_occurred=1
+    else
+      shellspec_timeout_occurred=0
+    fi
+    shellspec_rm -f "$SHELLSPEC_TIMEOUT_RESULT_FILE"
+  else
+    # No timeout - execute normally
+    ( set -e
+      shift
+      case $# in
+        0) shellspec_invoke_example ;;
+        *) shellspec_invoke_example "$@" ;;
+      esac
+    )
+    shellspec_exit_status=$?
+    shellspec_timeout_occurred=0
+  fi
+
+  set "$1" -- $shellspec_exit_status "$SHELLSPEC_LEAK_FILE"
+  shellspec_close_file_descriptors "$SHELLSPEC_USE_FDS"
+
+  # Handle timeout
+  if [ "$shellspec_timeout_occurred" -eq 1 ]; then
+    shellspec_output TIMEOUT "$shellspec_timeout_seconds"
+    shellspec_output FAILED
+    shellspec_profile_end
+    return 0
+  fi
+
   if [ "$1" -ne 0 ]; then
     [ -s "$2" ] || set -- "$1" "$SHELLSPEC_STDERR_FILE"
     shellspec_output ABORTED "$@"
     shellspec_output FAILED
+    [ "$1" -ne "$SHELLSPEC_ERROR_EXIT_CODE" ] || exit "$1"
   fi
   shellspec_profile_end
 }
@@ -220,8 +277,8 @@
 shellspec_invoke_example() {
   shellspec_output EXAMPLE
 
-  shellspec_on NOT_IMPLEMENTED
-  shellspec_off FAILED WARNED EXPECTATION LEAK
+  shellspec_on NOT_IMPLEMENTED NO_EXPECTATION
+  shellspec_off FAILED WARNED LEAK
   shellspec_off UNHANDLED_STATUS UNHANDLED_STDOUT UNHANDLED_STDERR
 
   # Output SKIP message if skipped in outer group.
@@ -231,6 +288,10 @@
       shellspec_output FAILED
       return 0
     fi
+    if ! shellspec_dsl_check; then
+      shellspec_output ERROR
+      return 0
+    fi
     if ! shellspec_call_before_hooks EACH; then
       shellspec_output BEFORE_EACH_ERROR
       shellspec_output FAILED
@@ -238,8 +299,8 @@
     fi
     shellspec_output_if PENDING ||:
     case $# in
-      0) shellspec_yield 2>"$SHELLSPEC_LEAK_FILE" ;;
-      *) shellspec_yield "$@" 2>"$SHELLSPEC_LEAK_FILE" ;;
+      0) shellspec_yield 2>|"$SHELLSPEC_LEAK_FILE" ;;
+      *) shellspec_yield "$@" 2>|"$SHELLSPEC_LEAK_FILE" ;;
     esac
     if ! shellspec_call_after_hooks EACH; then
       shellspec_output AFTER_EACH_ERROR
@@ -259,7 +320,7 @@
     return 0
   }
 
-  shellspec_output_unless EXPECTATION && shellspec_on WARNED
+  shellspec_output_if NO_EXPECTATION && shellspec_on WARNED
   shellspec_output_if UNHANDLED_STATUS && shellspec_on WARNED
   shellspec_output_if UNHANDLED_STDOUT && shellspec_on WARNED
   shellspec_output_if UNHANDLED_STDERR && shellspec_on WARNED
@@ -278,6 +339,28 @@
   shellspec_output_if WARNED || shellspec_output SUCCEEDED
 }
 
+shellspec_dsl_check() {
+  shellspec_fds_check
+}
+
+shellspec_fds_check() {
+  set -- "$SHELLSPEC_USE_FDS:"
+  while [ "${1%%:*}" ]; do
+    set -- "${1#*:}" "${1%%:*}"
+    case $2 in ([0-9]) continue; esac
+    if shellspec_is_identifier "$2"; then
+      [ "$SHELLSPEC_FDVAR_AVAILABLE" ] && continue
+      set -- "Assigning file descriptors to variables is not supported" \
+        "in the current shell"
+    else
+      set -- "Invalid file descriptor:" "$2"
+    fi
+    shellspec_output DSL_ERROR "UseFD: $1 $2"
+    return 1
+  done
+  return 0
+}
+
 shellspec_statement() {
   shellspec_off SYNTAX_ERROR
   shellspec_if SKIP && return 0
@@ -288,12 +371,16 @@
 }
 
 shellspec_when() {
+  # Allow "When I"
+  if [ "$#" -gt "0" ] && [ "$1" = "I" ]; then
+    shift
+  fi
   eval shellspec_join SHELLSPEC_EVALUATION '" "' When ${1+'"$@"'}
   shellspec_off NOT_IMPLEMENTED
 
   shellspec_if EVALUATION && {
     set -- "Evaluation has already been executed." \
-      "Only one Evaluation allow per Example." \
+      "Only one Evaluation is allowed per Example." \
       "(Use 'parameterized example' if you want a loop)"
     shellspec_output SYNTAX_ERROR_EVALUATION "$1 $2${SHELLSPEC_LF}$3"
     shellspec_on FAILED
@@ -301,7 +388,7 @@
   }
   shellspec_on EVALUATION
 
-  shellspec_if EXPECTATION && {
+  shellspec_if NO_EXPECTATION || {
     set -- "Expectation has already been executed."
     shellspec_output SYNTAX_ERROR_EVALUATION "$1"
     shellspec_on FAILED
@@ -342,8 +429,7 @@
 
 shellspec_the() {
   eval shellspec_join SHELLSPEC_EXPECTATION '" "' The ${1+'"$@"'}
-  shellspec_off NOT_IMPLEMENTED
-  shellspec_on EXPECTATION
+  shellspec_off NOT_IMPLEMENTED NO_EXPECTATION
   [ "$SHELLSPEC_XTRACE_ONLY" ] && return 0
 
   if [ $# -eq 0 ]; then
@@ -357,8 +443,7 @@
 
 shellspec_assert() {
   eval shellspec_join SHELLSPEC_EXPECTATION '" "' Assert ${1+'"$@"'}
-  shellspec_off NOT_IMPLEMENTED
-  shellspec_on EXPECTATION
+  shellspec_off NOT_IMPLEMENTED NO_EXPECTATION
   [ "$SHELLSPEC_XTRACE_ONLY" ] && return 0
 
   if [ $# -eq 0 ]; then
@@ -374,15 +459,12 @@
     *) eval "set -- +e ${1+\"\$@\"}" ;;
   esac
   set +e
-  ( set -e; shift; "$@" </dev/null 2>"$SHELLSPEC_ASSERT_STDERR_FILE" )
+  ( set -e; shift; "$@" </dev/null 2>|"$SHELLSPEC_ASSERT_STDERR_FILE" )
   set "$1" -- $?
 
-  shellspec_readfile SHELLSPEC_ASSERT_STDERR "$SHELLSPEC_ASSERT_STDERR_FILE"
-
   if [ "$1" -eq 0 ]; then
-    if [ "$SHELLSPEC_ASSERT_STDERR" ]; then
-      shellspec_output ASSERT_WARN "$1"
-      shellspec_output_assert_message "$SHELLSPEC_ASSERT_STDERR"
+    if [ -s "$SHELLSPEC_ASSERT_STDERR_FILE" ]; then
+      shellspec_output ASSERT_WARN "$1" "$SHELLSPEC_ASSERT_STDERR_FILE"
       shellspec_on WARNED
       return 0
     fi
@@ -390,8 +472,7 @@
     return 0
   fi
 
-  shellspec_output ASSERT_ERROR "$1"
-  shellspec_output_assert_message "$SHELLSPEC_ASSERT_STDERR"
+  shellspec_output ASSERT_ERROR "$1" "$SHELLSPEC_ASSERT_STDERR_FILE"
   shellspec_on FAILED
 }
 
@@ -453,7 +534,8 @@
 shellspec_logger() {
   shellspec_sleep 0
   if [ "$SHELLSPEC_LOGFILE" ]; then
-    shellspec_putsn "$@" >>"$SHELLSPEC_LOGFILE"
+    : <> "$SHELLSPEC_LOGFILE"
+    shellspec_putsn "$@" >> "$SHELLSPEC_LOGFILE"
   else
     shellspec_putsn "$@"
   fi
@@ -461,7 +543,8 @@
 
 shellspec_deprecated() {
   set -- "${SHELLSPEC_SPECFILE:-}:${SHELLSPEC_LINENO:-$SHELLSPEC_LINENO_BEGIN}" "$@"
-  shellspec_putsn "$@" >>"$SHELLSPEC_DEPRECATION_LOGFILE"
+  : <> "$SHELLSPEC_DEPRECATION_LOGFILE"
+  shellspec_putsn "$@" >> "$SHELLSPEC_DEPRECATION_LOGFILE"
 }
 
 shellspec_intercept() {
@@ -516,25 +599,36 @@
 }
 
 shellspec_dump() {
-  set -- ""
-  if [ "${SHELLSPEC_STDOUT+x}" ]; then
-    set -- "$@" "[stdout]${SHELLSPEC_LF}${SHELLSPEC_STDOUT}"
-  else
-    set -- "$@" "[stdout] <unset>"
-  fi
-  if [ "${SHELLSPEC_STDERR+x}" ]; then
-    set -- "$@" "[stderr]${SHELLSPEC_LF}${SHELLSPEC_STDERR}"
+  shellspec_putsn
+  shellspec_puts "[Dump] $SHELLSPEC_SPECFILE:$SHELLSPEC_AUX_LINENO "
+  shellspec_puts "(exit status: ${SHELLSPEC_STATUS-<unset>})"
+
+  shellspec_dump_file stdout SHELLSPEC_STDOUT "$SHELLSPEC_STDOUT_FILE"
+  shellspec_dump_file stderr SHELLSPEC_STDERR "$SHELLSPEC_STDERR_FILE"
+
+  shellspec_dump_callback() {
+    shellspec_dump_file "fd $1" "SHELLSPEC_FD_$1" "$2"
+  }
+
+  shellspec_enum_file_descriptors shellspec_dump_callback "$SHELLSPEC_USE_FDS"
+  shellspec_putsn
+}
+
+shellspec_dump_file() {
+  shellspec_readfile_once "$2" "$3"
+  shellspec_putsn
+  if eval "[ \"\${$2:-}\" ] &&:"; then
+    eval "shellspec_puts \"- $1:\${SHELLSPEC_LF}\${$2}\""
+  elif eval "[ \${$2+x} ] &&:"; then
+    shellspec_puts "- $1: <empty>"
   else
-    set -- "$@" "[stderr] <unset>"
+    shellspec_puts "- $1: <unset>"
   fi
-  set -- "$@" "[status] ${SHELLSPEC_STATUS-<unset>}" ""
-  IFS="${SHELLSPEC_LF}${IFS}"
-  shellspec_putsn "$*"
-  IFS=${IFS#?}
 }
 
 shellspec_preserve() {
   [ $# -eq 0 ] && return 0
+  : <> "$SHELLSPEC_VARS_FILE"
   shellspec_clone "$@" >> "$SHELLSPEC_VARS_FILE"
 }
 
@@ -555,7 +649,17 @@
 }
 
 shellspec_gen_mock_code() {
-  shellspec_putsn "#!$1"
+  # shellcheck disable=SC2295
+  set -- "$1" "${1%%[$SHELLSPEC_IFS]-*}"
+  shellspec_putsn "#!$2"
+  if [ "$1" != "$2" ]; then
+    shellspec_putsn "if [ \"\${SHELLSPEC_EXEC_MOCK:-}\" ]; then"
+    shellspec_putsn "  unset SHELLSPEC_EXEC_MOCK"
+    shellspec_putsn "else"
+    shellspec_putsn "  export SHELLSPEC_EXEC_MOCK=1"
+    shellspec_putsn "  exec $1 \"\$0\" \"\$@\""
+    shellspec_putsn "fi"
+  fi
   shellspec_putsn ". \"\$SHELLSPEC_LIB/general.sh\""
   shellspec_putsn ". \"\$SHELLSPEC_LIB/core/clone.sh\""
   shellspec_putsn "if [ -e \"\$SHELLSPEC_VARS_FILE\" ]; then"
@@ -563,6 +667,7 @@
   shellspec_putsn "fi"
   shellspec_putsn "shellspec_preserve() {"
   shellspec_putsn "  [ \$# -eq 0 ] && return 0"
+  shellspec_putsn "  : <> \"\$SHELLSPEC_VARS_FILE\""
   shellspec_putsn "  shellspec_clone \"\$@\" >> \"\$SHELLSPEC_VARS_FILE\""
   shellspec_putsn "}"
   shellspec_cat
@@ -578,3 +683,16 @@
     shellspec_mv "$1#$2" "$1"
   fi
 }
+
+shellspec_usefd() {
+  # Workaround for ksh93t on AIX 7.2
+  case ${KSH_VERSION:-} in (*93t*)
+    (
+      case $1 in
+        [0-9]) eval "exec $1>/dev/null" ;;
+        *) eval "exec {$1}>/dev/null" ;;
+      esac
+    )
+  esac
+  SHELLSPEC_USE_FDS="${SHELLSPEC_USE_FDS}${SHELLSPEC_USE_FDS:+:}$1"
+}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/evaluation.sh new/lib/core/evaluation.sh
--- old/lib/core/evaluation.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/evaluation.sh	2025-12-23 15:20:28.000000000 +0100
@@ -17,15 +17,20 @@
   "$@" > /dev/null
 }
 shellspec_evaluation_to_stdout() {
-  "$@" > "$SHELLSPEC_STDOUT_FILE"
+  "$@" >| "$SHELLSPEC_STDOUT_FILE"
 }
 shellspec_evaluation_to_stderr() {
-  "$@" 2> "$SHELLSPEC_STDERR_FILE"
+  "$@" 2>| "$SHELLSPEC_STDERR_FILE"
 }
 shellspec_evaluation_to_xtrace() {
   # shellcheck disable=SC2153
   set -- "$SHELLSPEC_XTRACEFD" SHELLSPEC_XTRACE_FILE "$@"
-  eval "shellspec_evaluation_to_xtrace_() { \"\$@\" $1> \"\$$2\"; }"
+  SHELLSPEC_EVAL="
+    shellspec_evaluation_to_xtrace_() { \
+      exec $1>|\"\$$2\"; \"\$@\"; set -- \$?; exec $1>&-; return \"\$1\"; \
+    }
+  "
+  eval "$SHELLSPEC_EVAL"
   shift 2
   shellspec_evaluation_to_xtrace_ "$@"
 }
@@ -52,8 +57,8 @@
 shellspec_invoke_data() {
   [ "$SHELLSPEC_DATA" ] || return 0
   case $# in
-    0) shellspec_data > "$SHELLSPEC_STDIN_FILE" ;;
-    *) shellspec_data "$@" > "$SHELLSPEC_STDIN_FILE" ;;
+    0) shellspec_data >| "$SHELLSPEC_STDIN_FILE" ;;
+    *) shellspec_data "$@" >| "$SHELLSPEC_STDIN_FILE" ;;
   esac
 }
 
@@ -102,7 +107,7 @@
 
 shellspec_evaluation_run_trap_exit_status() {
   SHELLSPEC_ZSH_EXIT_CODES="$SHELLSPEC_STDIO_FILE_BASE.exit_codes"
-  : > "$SHELLSPEC_ZSH_EXIT_CODES"
+  : >| "$SHELLSPEC_ZSH_EXIT_CODES"
 
   case $- in
     *e*) set +e -- -e "$@" ;;
@@ -134,12 +139,20 @@
 
 shellspec_shebang_arguments() {
   read -r line
+  # Trim spaces between `#!` and the command.
+  case $line in (\#!\ *)
+    shellspec_trim line "${line#* }"
+    line="#!$line"
+  esac
+  # Trim `env` call.
   case $line in (\#!/usr/bin/env\ * | \#!/bin/env\ *)
     shellspec_trim line "${line#* }"
     line="#!$line"
   esac
+  # Trim line if shebang.
   case $line in (\#!*)
     shellspec_trim line "$line"
+    # Get shebang arguments.
     case $line in (*\ *)
       shellspec_trim line "${line#* }"
       shellspec_putsn "$line"
@@ -250,6 +263,7 @@
   done
   shift 2
   case $SHELLSPEC_INTERCEPTOR in (*\|$1:*)
+    # shellcheck disable=SC2295
     eval "shift; set -- \"${SHELLSPEC_INTERCEPTOR##*\|$1:}\" ${2:+\"\$@\"}"
     eval "shift; set -- \"${1%%\|*}\" ${2:+\"\$@\"}"
     "$@"
@@ -257,11 +271,10 @@
 }
 
 shellspec_evaluation_cleanup() {
-  SHELLSPEC_STATUS=$1 SHELLSPEC_STDOUT='' SHELLSPEC_STDERR=''
-  [ "$SHELLSPEC_XTRACE" ] && [ "$SHELLSPEC_XTRACEFD" -eq 2 ] && return 0
-  shellspec_readfile SHELLSPEC_STDOUT "$SHELLSPEC_STDOUT_FILE"
-  shellspec_readfile SHELLSPEC_STDERR "$SHELLSPEC_STDERR_FILE"
+  SHELLSPEC_STATUS=$1
+  unset SHELLSPEC_STDOUT SHELLSPEC_STDERR ||:
+  [ "$SHELLSPEC_XTRACE" ] && [ "$SHELLSPEC_XTRACEFD" = 2 ] && return 0
   shellspec_toggle UNHANDLED_STATUS [ "$SHELLSPEC_STATUS" -ne 0 ]
-  shellspec_toggle UNHANDLED_STDOUT [ "$SHELLSPEC_STDOUT" ]
-  shellspec_toggle UNHANDLED_STDERR [ "$SHELLSPEC_STDERR" ]
+  shellspec_toggle UNHANDLED_STDOUT [ -s "$SHELLSPEC_STDOUT_FILE" ]
+  shellspec_toggle UNHANDLED_STDERR [ -s "$SHELLSPEC_STDERR_FILE" ]
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/file_descriptor.sh new/lib/core/file_descriptor.sh
--- old/lib/core/file_descriptor.sh	1970-01-01 01:00:00.000000000 +0100
+++ new/lib/core/file_descriptor.sh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,47 @@
+#shellcheck shell=sh
+
+shellspec_enum_file_descriptors() {
+  set -- "$1" "$2:"
+  while [ "${2%%:*}" ]; do
+    set -- "$1" "${2#*:}" "${2%%:*}"
+    "$1" "$3" "$SHELLSPEC_STDIO_FILE_BASE.fd-$3"
+  done
+}
+
+shellspec_open_file_descriptors() {
+  set -- "$1:"
+  while [ "${1%%:*}" ]; do
+    set -- "${1#*:}" "${1%%:*}"
+    case $2 in ([0-9])
+      shellspec_open_file_descriptor "$2" "$SHELLSPEC_STDIO_FILE_BASE.fd-$2"
+      continue
+    esac
+    if [ "$SHELLSPEC_FDVAR_AVAILABLE" ]; then
+      shellspec_is_identifier "$2" || continue
+      shellspec_open_file_descriptor "{$2}" "$SHELLSPEC_STDIO_FILE_BASE.fd-$2"
+    fi
+  done
+}
+
+shellspec_open_file_descriptor() {
+  eval "exec $1>\"\$2\""
+}
+
+shellspec_close_file_descriptors() {
+  set -- "$1:"
+  while [ "${1%%:*}" ]; do
+    set -- "${1#*:}" "${1%%:*}"
+    case $2 in ([0-9])
+      shellspec_close_file_descriptor "$2"
+      continue
+    esac
+    if [ "$SHELLSPEC_FDVAR_AVAILABLE" ]; then
+      shellspec_is_identifier "$2" || continue
+      shellspec_close_file_descriptor "{$2}"
+    fi
+  done
+}
+
+shellspec_close_file_descriptor() {
+  eval "exec $1>&-"
+}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/hook.sh new/lib/core/hook.sh
--- old/lib/core/hook.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/hook.sh	2025-12-23 15:20:28.000000000 +0100
@@ -49,7 +49,7 @@
 shellspec_call_before_hooks() {
   [ $# -lt 2 ] && set -- "$1" 1
   eval "[ \"\$2\" -gt \"\$SHELLSPEC_BEFORE_$1_INDEX\" ] &&:" && return 0
-  shellspec_call_hook "BEFORE_$1" "$2" 2>"$SHELLSPEC_ERROR_FILE" || return 1
+  shellspec_call_hook "BEFORE_$1" "$2" 2>|"$SHELLSPEC_ERROR_FILE" || return 1
   [ -s "$SHELLSPEC_ERROR_FILE" ] && return 1
   shellspec_call_before_hooks "$1" "$(($2 + 1))"
 }
@@ -57,7 +57,7 @@
 shellspec_call_after_hooks() {
   [ $# -lt 2 ] && eval "set -- \"\$1\" \"\$SHELLSPEC_AFTER_$1_INDEX\""
   [ "$2" -lt 1 ] && return 0
-  shellspec_call_hook "AFTER_$1" "$2" 2>"$SHELLSPEC_ERROR_FILE" || return 1
+  shellspec_call_hook "AFTER_$1" "$2" 2>|"$SHELLSPEC_ERROR_FILE" || return 1
   [ -s "$SHELLSPEC_ERROR_FILE" ] && return 1
   shellspec_call_after_hooks "$1" $(($2 - 1))
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/matchers/be/stat.sh new/lib/core/matchers/be/stat.sh
--- old/lib/core/matchers/be/stat.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/matchers/be/stat.sh	2025-12-23 15:20:28.000000000 +0100
@@ -36,6 +36,7 @@
   eval "$SHELLSPEC_EVAL"
 }
 
+# deprecated, should use "file should exist" instead
 shellspec_make_file_matcher exist            "-e" "exists" "does not exist"
 shellspec_make_file_matcher file             "-f" "is a regular file"
 shellspec_make_file_matcher directory        "-d" "is a directory"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/matchers/exist.sh new/lib/core/matchers/exist.sh
--- old/lib/core/matchers/exist.sh	1970-01-01 01:00:00.000000000 +0100
+++ new/lib/core/matchers/exist.sh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,17 @@
+#shellcheck shell=sh disable=SC2016
+
+shellspec_syntax 'shellspec_matcher_exist'
+
+shellspec_matcher_exist() {
+  shellspec_matcher__match() {
+    [ -e "${SHELLSPEC_SUBJECT:-}" ]
+  }
+
+  shellspec_syntax_failure_message + \
+    'expected $1 to exist'
+  shellspec_syntax_failure_message - \
+    'did not expect $1 to exist'
+
+  shellspec_syntax_param count [ $# -eq 0 ] || return 0
+  shellspec_matcher_do_match
+}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/matchers/has/stat.sh new/lib/core/matchers/has/stat.sh
--- old/lib/core/matchers/has/stat.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/matchers/has/stat.sh	1970-01-01 01:00:00.000000000 +0100
@@ -1,30 +0,0 @@
-#shellcheck shell=sh disable=SC2016
-
-shellspec_syntax 'shellspec_matcher_has_setgid'
-shellspec_syntax 'shellspec_matcher_has_setuid'
-
-shellspec_matcher_has_setgid() {
-  shellspec_matcher__match() {
-    [ -g "${SHELLSPEC_SUBJECT:-}" ]
-  }
-
-  shellspec_syntax_failure_message + 'The $1 not have setgid flag'
-  shellspec_syntax_failure_message - 'The $1 has setgid flag'
-
-  [ "${1:-}" = "flag" ] && shift
-  shellspec_syntax_param count [ $# -eq 0 ] || return 0
-  shellspec_matcher_do_match
-}
-
-shellspec_matcher_has_setuid() {
-  shellspec_matcher__match() {
-    [ -u "${SHELLSPEC_SUBJECT:-}" ]
-  }
-
-  shellspec_syntax_failure_message + 'The $1 not have setuid flag'
-  shellspec_syntax_failure_message - 'The $1 has setuid flag'
-
-  [ "${1:-}" = "flag" ] && shift
-  shellspec_syntax_param count [ $# -eq 0 ] || return 0
-  shellspec_matcher_do_match
-}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/matchers/has.sh new/lib/core/matchers/has.sh
--- old/lib/core/matchers/has.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/matchers/has.sh	1970-01-01 01:00:00.000000000 +0100
@@ -1,5 +0,0 @@
-#shellcheck shell=sh
-
-shellspec_syntax_chain 'shellspec_matcher_has'
-
-shellspec_import 'core/matchers/has/stat'
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/matchers/have/stat.sh new/lib/core/matchers/have/stat.sh
--- old/lib/core/matchers/have/stat.sh	1970-01-01 01:00:00.000000000 +0100
+++ new/lib/core/matchers/have/stat.sh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,34 @@
+#shellcheck shell=sh disable=SC2016
+
+shellspec_syntax 'shellspec_matcher_have_setgid'
+shellspec_syntax 'shellspec_matcher_have_setuid'
+
+# deprecated
+shellspec_syntax_alias 'shellspec_matcher_has_setgid' 'shellspec_matcher_have_setgid'
+shellspec_syntax_alias 'shellspec_matcher_has_setuid' 'shellspec_matcher_have_setuid'
+
+shellspec_matcher_have_setgid() {
+  shellspec_matcher__match() {
+    [ -g "${SHELLSPEC_SUBJECT:-}" ]
+  }
+
+  shellspec_syntax_failure_message + 'The $1 does not have the setgid flag'
+  shellspec_syntax_failure_message - 'The $1 has the setgid flag'
+
+  [ "${1:-}" = "flag" ] && shift
+  shellspec_syntax_param count [ $# -eq 0 ] || return 0
+  shellspec_matcher_do_match
+}
+
+shellspec_matcher_have_setuid() {
+  shellspec_matcher__match() {
+    [ -u "${SHELLSPEC_SUBJECT:-}" ]
+  }
+
+  shellspec_syntax_failure_message + 'The $1 does not have the setuid flag'
+  shellspec_syntax_failure_message - 'The $1 has the setuid flag'
+
+  [ "${1:-}" = "flag" ] && shift
+  shellspec_syntax_param count [ $# -eq 0 ] || return 0
+  shellspec_matcher_do_match
+}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/matchers/have.sh new/lib/core/matchers/have.sh
--- old/lib/core/matchers/have.sh	1970-01-01 01:00:00.000000000 +0100
+++ new/lib/core/matchers/have.sh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,6 @@
+#shellcheck shell=sh
+
+shellspec_syntax_chain 'shellspec_matcher_has'
+shellspec_syntax_chain 'shellspec_matcher_have'
+
+shellspec_import 'core/matchers/have/stat'
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/matchers/satisfy.sh new/lib/core/matchers/satisfy.sh
--- old/lib/core/matchers/satisfy.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/matchers/satisfy.sh	2025-12-23 15:20:28.000000000 +0100
@@ -30,7 +30,7 @@
       while read -r line; do :; done # Discard unnecessary STDIN data
       set_exit_status() { return "$1"; }
       set_exit_status "$ex"
-    ) 2>"$SHELLSPEC_SATISFY_STDERR_FILE" >&4 &&:
+    ) 2>|"$SHELLSPEC_SATISFY_STDERR_FILE" &&:
 
     set -- "$?"
     if [ -s "$SHELLSPEC_SATISFY_STDERR_FILE" ]; then
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/matchers.sh new/lib/core/matchers.sh
--- old/lib/core/matchers.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/matchers.sh	2025-12-23 15:20:28.000000000 +0100
@@ -17,7 +17,10 @@
 
   unset SHELLSPEC_EXPECT ||:
 
-  eval shellspec_syntax_dispatch matcher ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch matcher ;;
+    *) shellspec_syntax_dispatch matcher "$@" ;;
+  esac
 }
 
 shellspec_matcher_do_match_positive() {
@@ -32,10 +35,40 @@
   fi
 }
 
+shellspec_get_failure_message() {
+  set -- "${1:-}"
+
+  if [ ${SHELLSPEC_SUBJECT+x} ]; then
+    if shellspec_is_number "${SHELLSPEC_SUBJECT}"; then
+      set -- "$1" "${SHELLSPEC_SUBJECT}"
+    else
+      set -- "$1" "\"${SHELLSPEC_SUBJECT}\""
+    fi
+  else
+    set -- "$1" "<unset>"
+  fi
+
+  if [ ${SHELLSPEC_EXPECT+x} ]; then
+    if shellspec_is_number "${SHELLSPEC_EXPECT}"; then
+      set -- "$1" "$2" "${SHELLSPEC_EXPECT}"
+    else
+      set -- "$1" "$2" "\"${SHELLSPEC_EXPECT}\""
+    fi
+  else
+    set -- "$1" "$2" "<unset>"
+  fi
+
+  case $1 in
+    positive) shellspec_matcher__failure_message "$2" "$3" ;;
+    negative) shellspec_matcher__failure_message_when_negated "$2" "$3" ;;
+  esac
+}
+
 shellspec_import 'core/matchers/be'
 shellspec_import 'core/matchers/end_with'
 shellspec_import 'core/matchers/equal'
-shellspec_import 'core/matchers/has'
+shellspec_import 'core/matchers/exist'
+shellspec_import 'core/matchers/have'
 shellspec_import 'core/matchers/include'
 shellspec_import 'core/matchers/match'
 shellspec_import 'core/matchers/start_with'
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/modifiers/contents.sh new/lib/core/modifiers/contents.sh
--- old/lib/core/modifiers/contents.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/modifiers/contents.sh	2025-12-23 15:20:28.000000000 +0100
@@ -12,7 +12,10 @@
     unset SHELLSPEC_SUBJECT ||:
   fi
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
 
 shellspec_modifier_entire_contents() {
@@ -24,5 +27,8 @@
     unset SHELLSPEC_SUBJECT ||:
   fi
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/modifiers/length.sh new/lib/core/modifiers/length.sh
--- old/lib/core/modifiers/length.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/modifiers/length.sh	2025-12-23 15:20:28.000000000 +0100
@@ -11,5 +11,8 @@
     unset SHELLSPEC_SUBJECT ||:
   fi
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/modifiers/line.sh new/lib/core/modifiers/line.sh
--- old/lib/core/modifiers/line.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/modifiers/line.sh	2025-12-23 15:20:28.000000000 +0100
@@ -17,5 +17,8 @@
   fi
   shift
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/modifiers/lines.sh new/lib/core/modifiers/lines.sh
--- old/lib/core/modifiers/lines.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/modifiers/lines.sh	2025-12-23 15:20:28.000000000 +0100
@@ -11,5 +11,8 @@
     unset SHELLSPEC_SUBJECT ||:
   fi
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/modifiers/result.sh new/lib/core/modifiers/result.sh
--- old/lib/core/modifiers/result.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/modifiers/result.sh	2025-12-23 15:20:28.000000000 +0100
@@ -24,16 +24,21 @@
     unset SHELLSPEC_SUBJECT ||:
   fi
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
 
 shellspec_modifier_result_invoke() {
+  shellspec_readfile_once SHELLSPEC_STDOUT "$SHELLSPEC_STDOUT_FILE"
+  shellspec_readfile_once SHELLSPEC_STDERR "$SHELLSPEC_STDERR_FILE"
   set -- "${SHELLSPEC_STDOUT:-}" "${SHELLSPEC_STDERR:-}" "${SHELLSPEC_STATUS:-}"
   if [ -e "$SHELLSPEC_STDOUT_FILE" ]; then
     ( "$SHELLSPEC_SUBJECT" "$@" < "$SHELLSPEC_STDOUT_FILE" )
   else
     ( "$SHELLSPEC_SUBJECT" "$@" < /dev/null )
-  fi >"$SHELLSPEC_RESULT_STDOUT_FILE" 2>"$SHELLSPEC_RESULT_STDERR_FILE" &&:
+  fi >|"$SHELLSPEC_RESULT_STDOUT_FILE" 2>|"$SHELLSPEC_RESULT_STDERR_FILE" &&:
   set -- "$?"
   [ -s "$SHELLSPEC_RESULT_STDERR_FILE" ] || return "$1"
   shellspec_output RESULT_WARN "$1" "$SHELLSPEC_RESULT_STDERR_FILE"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/modifiers/word.sh new/lib/core/modifiers/word.sh
--- old/lib/core/modifiers/word.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/modifiers/word.sh	2025-12-23 15:20:28.000000000 +0100
@@ -17,5 +17,8 @@
   fi
   shift
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/output.sh new/lib/core/output.sh
--- old/lib/core/output.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/output.sh	2025-12-23 15:20:28.000000000 +0100
@@ -5,32 +5,47 @@
   "shellspec_output_$@"
 }
 
-shellspec_output_to_fd() {
-  # shellcheck disable=SC2039,SC3021
-  "$@" >&"$SHELLSPEC_OUTPUT_FD"
-}
-
 shellspec_output_raw() {
   [ $# -gt 0 ] || return 0
-
-  shellspec_output_buf="${shellspec_output_buf:-}${SHELLSPEC_RS}"
-  while [ $# -gt 1 ]; do
-    shellspec_output_buf="${shellspec_output_buf}$1${SHELLSPEC_US}"
+  for shellspec_output_raw in "$@"; do
+    case ${shellspec_output_raw%%:*} in
+      message | description | evaluation | failure_message)
+        shellspec_output_raw_sanitize "$shellspec_output_raw" ;;
+      # shell | shell_type | shell_version | info | type) ;;
+      # specfile | example_count | stdout | stderr) ;;
+      # id | block_no | example_no | focused | lineno_range) ;;
+      # tag | lineno | note | fail | quick | temporary | skipid) ;;
+      # *) echo "Unknown reporter tag name: $shellspec_output_raw" >&2; exit 1
+    esac
+    set -- "$@" "$shellspec_output_raw"
     shift
   done
-  shellspec_output_to_fd shellspec_puts "${shellspec_output_buf}$1"
-  shellspec_output_buf=$SHELLSPEC_LF
-}
-
-shellspec_output_raw_append() {
-  shellspec_output_to_fd shellspec_puts "$SHELLSPEC_US"
-  shellspec_output_to_fd shellspec_putsn "$@"
+  IFS="${SHELLSPEC_US}${IFS}"
+  shellspec_putsn "${SHELLSPEC_RS}$*${SHELLSPEC_ETB}"
+  IFS=${IFS#?}
+}
+shellspec_output_raw_sanitize() {
+  set -- "$1" "$IFS" "$-"
+  set -f -u # -u: Workaround for posh 0.10.2. nounset has the effect of noglob.
+  IFS="${SHELLSPEC_RS}${SHELLSPEC_US}${SHELLSPEC_ETB}"
+  eval "shellspec_output_raw_sanitize_ \$${ZSH_VERSION:+=}1"
+  IFS=$2
+  [ "${3#*f}" != "$3" ] || set +f
+  [ "${3#*u}" != "$3" ] || set +u
+}
+shellspec_output_raw_sanitize_() {
+  IFS='?'
+  shellspec_output_raw="$*"
 }
 
 shellspec_output_meta() {
   eval shellspec_output_raw type:meta ${1:+'"$@"'}
 }
 
+shellspec_output_error() {
+  eval shellspec_output_raw type:error ${1:+'"$@"'}
+}
+
 shellspec_output_finished() {
   eval shellspec_output_raw type:finished ${1:+'"$@"'}
 }
@@ -58,10 +73,6 @@
   shellspec_output_raw type:result "$@"
 }
 
-shellspec_output_error() {
-  shellspec_output_raw type:error "$@"
-}
-
 shellspec_output_if() {
   shellspec_if "$1" || return 1
   shellspec_output "$@"
@@ -71,74 +82,3 @@
   shellspec_unless "$1" || return 1
   shellspec_output "$@"
 }
-
-shellspec_output_failure_message() {
-  shellspec_output_to_fd shellspec_puts "${SHELLSPEC_US}failure_message:"
-  set -- "$(shellspec_output_subject)" "$(shellspec_output_expect)"
-  shellspec_output_to_fd shellspec_matcher__failure_message "$@"
-}
-
-shellspec_output_failure_message_when_negated() {
-  shellspec_output_to_fd shellspec_puts "${SHELLSPEC_US}failure_message:"
-  set -- "$(shellspec_output_subject)" "$(shellspec_output_expect)"
-  shellspec_output_to_fd shellspec_matcher__failure_message_when_negated "$@"
-}
-
-shellspec_output_assert_message() {
-  shellspec_output_to_fd shellspec_putsn "$1"
-}
-
-shellspec_output_following_words() {
-  set -- "$1" "${SHELLSPEC_SYNTAXES#:}" "" ""
-
-  while [ "$2" ] && set -- "$1" "${2#*:}" "${2%%:*}" "$4"; do
-    eval "set -- \"\$@\" \${3#${1}_}"
-    case $5 in (*_*) continue; esac
-    set -- "$1" "$2" "$3" "$4${4:+ }$5"
-  done
-  eval "set -- $4"
-
-  callback() {
-    [ $(( ($2 - 1) % 8)) -eq 0 ] && shellspec_puts '  '
-    shellspec_puts "$1"
-    [ "$2" -eq "$3" ] || shellspec_puts ', '
-    [ $(( $2 % 8)) -ne 0 ] || shellspec_puts "$SHELLSPEC_LF"
-  }
-  shellspec_output_to_fd shellspec_putsn
-  shellspec_output_to_fd shellspec_each callback "$@"
-  shellspec_output_to_fd shellspec_putsn
-}
-
-shellspec_output_syntax_name() {
-  [ "${SHELLSPEC_SYNTAX_NAME:-}" ] || return 0
-  set -- "${SHELLSPEC_SYNTAX_NAME#shellspec_}"
-  set -- "${1#*_}_${1%%_*}_" "" ""
-  while [ "$1" ] && set -- "${1#*_}" "${1%%_*}" "$3"; do
-    set -- "$1" "$2" "$3${3:+ }$2"
-  done
-  shellspec_putsn "$3"
-}
-
-shellspec_output_subject() {
-  if [ ${SHELLSPEC_SUBJECT+x} ]; then
-    if  shellspec_is_number "${SHELLSPEC_SUBJECT}"; then
-      shellspec_puts "${SHELLSPEC_SUBJECT}"
-    else
-      shellspec_puts "\"${SHELLSPEC_SUBJECT}\""
-    fi
-  else
-    shellspec_puts "<unset>"
-  fi
-}
-
-shellspec_output_expect() {
-  if [ ${SHELLSPEC_EXPECT+x} ]; then
-    if  shellspec_is_number "${SHELLSPEC_EXPECT}"; then
-      shellspec_puts "${SHELLSPEC_EXPECT}"
-    else
-      shellspec_puts "\"${SHELLSPEC_EXPECT}\""
-    fi
-  else
-    shellspec_puts "<unset>"
-  fi
-}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/outputs.sh new/lib/core/outputs.sh
--- old/lib/core/outputs.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/outputs.sh	2025-12-23 15:20:28.000000000 +0100
@@ -58,7 +58,14 @@
     "temporary:" "message:$SHELLSPEC_PENDING_REASON"
 }
 
-shellspec_output_EXPECTATION() {
+shellspec_output_TIMEOUT() {
+  shellspec_output_statement "tag:timeout" "note:TIMEOUT" "fail:y" \
+    "timeout:$1" \
+    "failure_message:${SHELLSPEC_LINENO:+<$SHELLSPEC_LINENO>}Test exceeded timeout" \
+    "message:Test exceeded timeout of $1 seconds"
+}
+
+shellspec_output_NO_EXPECTATION() {
   shellspec_output_statement "tag:warn" "note:WARNING" \
     "fail:${SHELLSPEC_WARNING_AS_FAILURE:+y}" \
     "message:Not found any expectation" "failure_message:"
@@ -68,165 +75,161 @@
   SHELLSPEC_LINENO=$SHELLSPEC_LINENO_BEGIN-$SHELLSPEC_LINENO_END
   shellspec_output_statement "tag:warn" "note:WARNING" \
     "fail:${SHELLSPEC_WARNING_AS_FAILURE:+y}" \
-    "message:It exits with status non-zero but not found expectation"
-  shellspec_output_raw_append "failure_message:status:" "$SHELLSPEC_STATUS"
+    "message:It exits with status non-zero but not found expectation" \
+    "failure_message:status:${SHELLSPEC_STATUS}${SHELLSPEC_LF}"
 }
 
 shellspec_output_UNHANDLED_STDOUT() {
   SHELLSPEC_LINENO=$SHELLSPEC_LINENO_BEGIN-$SHELLSPEC_LINENO_END
+  unset UNHANDLED_STDOUT || :
+  if [ -e "$SHELLSPEC_STDOUT_FILE" ]; then
+    shellspec_head UNHANDLED_STDOUT < "$SHELLSPEC_STDOUT_FILE"
+  fi
   shellspec_output_statement "tag:warn" "note:WARNING" \
     "fail:${SHELLSPEC_WARNING_AS_FAILURE:+y}" \
-    "message:There was output to stdout but not found expectation"
-  shellspec_chomp SHELLSPEC_STDOUT
-  shellspec_output_raw_append "failure_message:stdout:" "$SHELLSPEC_STDOUT"
+    "message:There was output to stdout but not found expectation" \
+    "failure_message:stdout:${UNHANDLED_STDOUT- <none>}${SHELLSPEC_LF}"
 }
 
 shellspec_output_UNHANDLED_STDERR() {
   SHELLSPEC_LINENO=$SHELLSPEC_LINENO_BEGIN-$SHELLSPEC_LINENO_END
+  unset UNHANDLED_STDERR || :
+  if [ -e "$SHELLSPEC_STDERR_FILE" ]; then
+    shellspec_head UNHANDLED_STDERR < "$SHELLSPEC_STDERR_FILE"
+  fi
   shellspec_output_statement "tag:warn" "note:WARNING" \
     "fail:${SHELLSPEC_WARNING_AS_FAILURE:+y}" \
-    "message:There was output to stderr but not found expectation"
-  shellspec_chomp SHELLSPEC_STDERR
-  shellspec_output_raw_append "failure_message:stderr:" "$SHELLSPEC_STDERR"
+    "message:There was output to stderr but not found expectation" \
+    "failure_message:stderr:${UNHANDLED_STDERR- <none>}${SHELLSPEC_LF}"
 }
 
 shellspec_output_ASSERT_WARN() {
-  shellspec_output_statement "tag:warn" "note:WARNING" \
-    "fail:${SHELLSPEC_WARNING_AS_FAILURE:+y}" \
-    "message:$SHELLSPEC_EXPECTATION"
+  shellspec_capturefile SHELLSPEC_ASSERT_STDERR "$2"
   set -- "Unexpected output to stderr occurred (exit status: $1)"
-  shellspec_output_raw_append "failure_message:$1"
+  if [ "$SHELLSPEC_ASSERT_STDERR" ]; then
+    set -- "$1${SHELLSPEC_LF}${SHELLSPEC_ASSERT_STDERR}${SHELLSPEC_LF}"
+  fi
+  shellspec_output_statement tag:warn note:WARNING \
+    "fail:${SHELLSPEC_WARNING_AS_FAILURE:+y}" \
+    "message:$SHELLSPEC_EXPECTATION" "failure_message:$1"
 }
 
 shellspec_output_ASSERT_ERROR() {
-  shellspec_output_statement "tag:bad" "note:" "fail:y" \
-    "message:$SHELLSPEC_EXPECTATION"
-  shellspec_output_raw_append "failure_message:assertion failure" \
-    "(exit status: $1)"
+  shellspec_capturefile SHELLSPEC_ASSERT_STDERR "$2"
+  set -- "assertion failure (exit status: $1)"
+  if [ "$SHELLSPEC_ASSERT_STDERR" ]; then
+    set -- "$1${SHELLSPEC_LF}${SHELLSPEC_ASSERT_STDERR}${SHELLSPEC_LF}"
+  fi
+  shellspec_output_statement tag:bad note: fail:y \
+    "message:$SHELLSPEC_EXPECTATION" "failure_message:$1"
 }
 
 shellspec_output_BEFORE_ALL_ERROR() {
-  shellspec_capturefile SHELLSPEC_BEFORE_ALL_ERROR "$SHELLSPEC_ERROR_FILE"
-  set -- "$SHELLSPEC_HOOK" "$SHELLSPEC_BEFORE_ALL_ERROR" \
-    "$SHELLSPEC_HOOK_LINENO" "$SHELLSPEC_HOOK_STATUS"
-  shellspec_output_error "note:ERROR" "lineno:$SHELLSPEC_HOOK_LINENO" \
-    "message:An error occurred in before all hook '$1' (exit status: $4)"
-  shellspec_output_raw_append "failure_message:${2:-<no error>}"
+  shellspec_capturefile SHELLSPEC_ERROR "$SHELLSPEC_ERROR_FILE"
+  set -- "$SHELLSPEC_HOOK" "$SHELLSPEC_HOOK_STATUS"
+  shellspec_output_error note:ERROR "lineno:$SHELLSPEC_HOOK_LINENO" \
+    "message:An error occurred in before all hook '$1' (exit status: $2)" \
+    "failure_message:${SHELLSPEC_ERROR:-<no error>}${SHELLSPEC_LF}"
 }
 
 shellspec_output_AFTER_ALL_ERROR() {
-  shellspec_capturefile SHELLSPEC_AFTER_ALL_ERROR "$SHELLSPEC_ERROR_FILE"
-  set -- "$SHELLSPEC_HOOK" "$SHELLSPEC_AFTER_ALL_ERROR" \
-    "$SHELLSPEC_HOOK_LINENO" "$SHELLSPEC_HOOK_STATUS"
-  shellspec_output_error "note:ERROR" "lineno:$SHELLSPEC_HOOK_LINENO" \
-    "message:An error occurred in after hook '$1' (exit status: $4)"
-  shellspec_output_raw_append "failure_message:${2:-<no error>}"
+  shellspec_capturefile SHELLSPEC_ERROR "$SHELLSPEC_ERROR_FILE"
+  set -- "$SHELLSPEC_HOOK" "$SHELLSPEC_HOOK_STATUS"
+  shellspec_output_error note:ERROR "lineno:$SHELLSPEC_HOOK_LINENO" \
+    "message:An error occurred in after hook '$1' (exit status: $2)" \
+    "failure_message:${SHELLSPEC_ERROR:-<no error>}${SHELLSPEC_LF}"
 }
 
 shellspec_output_BEFORE_EACH_ERROR() {
-  shellspec_capturefile SHELLSPEC_BEFORE_EACH_ERROR "$SHELLSPEC_ERROR_FILE"
-  set -- "$SHELLSPEC_HOOK" "$SHELLSPEC_BEFORE_EACH_ERROR" \
-    "$SHELLSPEC_HOOK_LINENO" "$SHELLSPEC_HOOK_STATUS"
-  SHELLSPEC_LINENO=$SHELLSPEC_LINENO_BEGIN-$SHELLSPEC_LINENO_END
-  shellspec_output_statement "tag:bad" "note:" "fail:y" "evaluation:" \
-    "message:An error occurred in before hook '$1' (line: $3, exit status: $4)"
-  shellspec_output_raw_append "failure_message:${2:-<no error>}"
+  shellspec_capturefile SHELLSPEC_ERROR "$SHELLSPEC_ERROR_FILE"
+  set -- "$SHELLSPEC_HOOK" "$SHELLSPEC_HOOK_LINENO" "$SHELLSPEC_HOOK_STATUS"
+  SHELLSPEC_LINENO=$SHELLSPEC_LINENO_BEGIN-$SHELLSPEC_LINENO_END
+  shellspec_output_statement tag:bad note: fail:y evaluation: \
+    "message:An error occurred in before hook '$1' (line: $2, exit status: $3)" \
+    "failure_message:${SHELLSPEC_ERROR:-<no error>}${SHELLSPEC_LF}"
 }
 
 shellspec_output_AFTER_EACH_ERROR() {
-  shellspec_capturefile SHELLSPEC_AFTER_EACH_ERROR "$SHELLSPEC_ERROR_FILE"
-  set -- "$SHELLSPEC_HOOK" "$SHELLSPEC_AFTER_EACH_ERROR" \
-    "$SHELLSPEC_HOOK_LINENO" "$SHELLSPEC_HOOK_STATUS"
-  SHELLSPEC_LINENO=$SHELLSPEC_LINENO_BEGIN-$SHELLSPEC_LINENO_END
-  shellspec_output_statement "tag:bad" "note:" "fail:y" "evaluation:" \
-    "message:An error occurred in after hook '$1' (line: $3, exit status: $4)"
-  shellspec_output_raw_append "failure_message:${2:-<no error>}"
+  shellspec_capturefile SHELLSPEC_ERROR "$SHELLSPEC_ERROR_FILE"
+  set -- "$SHELLSPEC_HOOK" "$SHELLSPEC_HOOK_LINENO" "$SHELLSPEC_HOOK_STATUS"
+  SHELLSPEC_LINENO=$SHELLSPEC_LINENO_BEGIN-$SHELLSPEC_LINENO_END
+  shellspec_output_statement tag:bad note: fail:y evaluation: \
+    "message:An error occurred in after hook '$1' (line: $2, exit status: $3)" \
+    "failure_message:${SHELLSPEC_ERROR:-<no error>}${SHELLSPEC_LF}"
 }
 
 shellspec_output_HOOK_ERROR() {
-  shellspec_output_statement "tag:bad" "note:" "fail:y" "failure_message:" \
+  shellspec_output_statement tag:bad note: fail:y failure_message: \
     "message:Treat as a failure due to a preceding hook error"
 }
 
 shellspec_output_MATCHED() {
   shellspec_if PENDING && shellspec_output_MATCHED_FIXED && return 0
-  shellspec_output_statement "tag:good" "note:" "fail:" \
+  shellspec_output_statement tag:good note: fail: \
     "message:$SHELLSPEC_EXPECTATION"
 }
 
 shellspec_output_MATCHED_FIXED() {
-  shellspec_output_statement "tag:good" "note:FIXED" "fail:" \
+  shellspec_output_statement tag:good note:FIXED fail: \
     "message:$SHELLSPEC_EXPECTATION"
 }
 
 shellspec_output_UNMATCHED() {
   shellspec_output_statement "tag:bad" "note:" "fail:y" \
-    "message:$SHELLSPEC_EXPECTATION"
+    "message:$SHELLSPEC_EXPECTATION" "failure_message:$1${SHELLSPEC_LF}"
 }
 
 shellspec_output_SYNTAX_ERROR() {
-  shellspec_output_statement "tag:bad" "note:SYNTAX ERROR" "fail:y" \
-    "message:$SHELLSPEC_EXPECTATION"
-  shellspec_output_raw_append "failure_message:${1:-unknown syntax error}"
+  shellspec_output_statement tag:bad note:SYNTAX ERROR fail:y \
+    "message:$SHELLSPEC_EXPECTATION" \
+    "failure_message:${1:-unknown syntax error}${SHELLSPEC_LF}"
 }
 
 shellspec_output_SYNTAX_ERROR_EVALUATION() {
-  shellspec_output_statement "tag:bad" "note:" "fail:y" \
-    "message:$SHELLSPEC_EVALUATION"
-  shellspec_output_raw_append "failure_message:${1:-unknown syntax error}"
+  shellspec_output_statement tag:bad note: fail:y \
+    "message:$SHELLSPEC_EVALUATION" \
+    "failure_message:${1:-unknown syntax error}${SHELLSPEC_LF}"
 }
 
 shellspec_output_SYNTAX_ERROR_EXPECTATION() {
-  shellspec_output_statement "tag:bad" "note:" "fail:y" \
-    "message:$SHELLSPEC_EXPECTATION"
-  shellspec_output_raw_append "failure_message:${1:-unknown syntax error}"
+  shellspec_output_statement tag:bad note: fail:y \
+    "message:$SHELLSPEC_EXPECTATION" \
+    "failure_message:${1:-unknown syntax error}${SHELLSPEC_LF}"
 }
 
 shellspec_output_SYNTAX_ERROR_MATCHER_REQUIRED() {
-  shellspec_output_statement "tag:bad" "note:" "fail:y" \
-    "message:$SHELLSPEC_EXPECTATION"
-  shellspec_output_raw_append "failure_message:A word is required after" \
-    "$(shellspec_output_syntax_name)." \
-    "The correct word is one of the following."
-  shellspec_output_following_words "shellspec_matcher"
+  set -- "A word is required after $(shellspec_syntax_name)" \
+    "The correct word is one of the following" \
+    "$(shellspec_syntax_following_words "shellspec_matcher")"
+  shellspec_output_statement tag:bad note: fail:y \
+    "message:$SHELLSPEC_EXPECTATION" \
+    "failure_message:$1. $2. ${SHELLSPEC_LF}${SHELLSPEC_LF}$3${SHELLSPEC_LF}"
 }
 
 shellspec_output_SYNTAX_ERROR_DISPATCH_FAILED() {
-  shellspec_output_statement "tag:bad" "note:" "fail:y" \
-    "message:$SHELLSPEC_EXPECTATION"
   [ "$1" = modifier ] && set -- "$1/verb" "${2:-}"
-  if [ "${2:-}" ]; then
-    shellspec_output_raw_append "failure_message:Unknown word '$2' after" \
-      "$(shellspec_output_syntax_name)." \
-      "The correct word is one of the following."
-  else
-    shellspec_output_raw_append "failure_message:A word is required after" \
-      "$(shellspec_output_syntax_name)." \
-      "The correct word is one of the following."
-  fi
-  shellspec_output_following_words "shellspec_${1%/verb}"
-}
-
-shellspec_output_SYNTAX_ERROR_COMPOUND_WORD() {
-  shellspec_output_statement "tag:bad" "note:" "fail:y" \
-    "message:$SHELLSPEC_EXPECTATION"
-  shellspec_output_raw_append "failure_message:The next word of" \
-    "'${1##*_}' should be one of the following."
-  shellspec_output_following_words "$1"
+  case ${2:-} in
+    '') set -- "$1" "Unknown word '$2' after" ;;
+    *) set -- "$1" "A word is required after" ;;
+  esac
+  set -- "$2 $(shellspec_syntax_name)." \
+    "The correct word is one of the following." \
+    "$(shellspec_syntax_following_words "shellspec_${1%/verb}")"
+  shellspec_output_statement tag:bad note: fail:y \
+    "message:$SHELLSPEC_EXPECTATION" \
+    "failure_message:$1$2${SHELLSPEC_LF}${SHELLSPEC_LF}$3${SHELLSPEC_LF}"
 }
 
 shellspec_output_SYNTAX_ERROR_WRONG_PARAMETER_COUNT() {
+  set -- "Wrong parameter $1 of $(shellspec_syntax_name)"
   shellspec_output_statement "tag:bad" "note:" "fail:y" \
-    "message:$SHELLSPEC_EXPECTATION"
-  shellspec_output_raw_append "failure_message:Wrong parameter $1 of" \
-    "$(shellspec_output_syntax_name)"
+    "message:$SHELLSPEC_EXPECTATION" "failure_message:$1${SHELLSPEC_LF}"
 }
 
 shellspec_output_SYNTAX_ERROR_PARAM_TYPE() {
-  shellspec_output_raw statement "tag:bad" "note:" "fail:y" \
-    "message:$SHELLSPEC_EXPECTATION"
-  shellspec_output_raw_append "failure_message:The parameter #$1 of" \
-    "$(shellspec_output_syntax_name) is not a $2"
+  set -- "The parameter #$1 of $(shellspec_syntax_name) is not a $2"
+  shellspec_output_statement "tag:bad" "note:" "fail:y" \
+    "message:$SHELLSPEC_EXPECTATION" "failure_message:$1${SHELLSPEC_LF}"
 }
 
 shellspec_output_RESULT_WARN() {
@@ -275,6 +278,10 @@
   shellspec_output_result tag:failed note:FAILED fail:y quick:y
 }
 
+shellspec_output_ERROR() {
+  shellspec_output_result tag:error note:ERROR fail:y quick:y
+}
+
 shellspec_output_WARNED() {
   shellspec_output_result tag:warned note:WARNED \
     fail:${SHELLSPEC_WARNING_AS_FAILURE:+y} \
@@ -304,3 +311,8 @@
     shellspec_output_result tag:skipped note:SKIPPED fail: quick: temporary:
   fi
 }
+
+shellspec_output_DSL_ERROR() {
+  shellspec_output_statement "tag:bad" "note:ERROR" "fail:y" "failure_message:" \
+    "message:$1"
+}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/statement.sh new/lib/core/statement.sh
--- old/lib/core/statement.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/statement.sh	2025-12-23 15:20:28.000000000 +0100
@@ -12,7 +12,7 @@
 #     C c1 c2 of B b1 b2 of A a1 a2 should equal abc
 #  => A a1 a2 B b1 b2 C c1 c2 should equal abc
 shellspec_statement_preposition() {
-  shellspec_work='' shellspec_i=0 shellspec_v=''
+  shellspec_work='' shellspec_i=0 shellspec_j=0 shellspec_k=0 shellspec_v=''
 
   until [ "$shellspec_v" = should ]; do
     shellspec_i=$(($shellspec_i + 1)) && shellspec_j=$shellspec_i
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/subjects/fd.sh new/lib/core/subjects/fd.sh
--- old/lib/core/subjects/fd.sh	1970-01-01 01:00:00.000000000 +0100
+++ new/lib/core/subjects/fd.sh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,44 @@
+#shellcheck shell=sh
+
+shellspec_syntax 'shellspec_subject_fd'
+shellspec_syntax 'shellspec_subject_entire_fd'
+
+shellspec_subject_fd() {
+  shellspec_syntax_param count [ $# -ge 1 ] || return 0
+
+  # shellcheck disable=SC2034
+  SHELLSPEC_META='text'
+  SHELLSPEC_SUBJECT="$SHELLSPEC_STDIO_FILE_BASE.fd-${1}"
+  if [ -e "$SHELLSPEC_SUBJECT" ]; then
+    # shellcheck disable=SC2034
+    shellspec_capturefile SHELLSPEC_SUBJECT "$SHELLSPEC_SUBJECT"
+  else
+    unset SHELLSPEC_SUBJECT ||:
+  fi
+  shift
+
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
+}
+
+shellspec_subject_entire_fd() {
+  shellspec_syntax_param count [ $# -ge 1 ] || return 0
+
+  # shellcheck disable=SC2034
+  SHELLSPEC_META='text'
+  SHELLSPEC_SUBJECT="$SHELLSPEC_STDIO_FILE_BASE.fd-${1}"
+  if [ -e "$SHELLSPEC_SUBJECT" ]; then
+    # shellcheck disable=SC2034
+    shellspec_readfile SHELLSPEC_SUBJECT "$SHELLSPEC_SUBJECT"
+  else
+    unset SHELLSPEC_SUBJECT ||:
+  fi
+  shift
+
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
+}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/subjects/line.sh new/lib/core/subjects/line.sh
--- old/lib/core/subjects/line.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/subjects/line.sh	2025-12-23 15:20:28.000000000 +0100
@@ -8,6 +8,7 @@
 
   # shellcheck disable=SC2034
   SHELLSPEC_META="text"
+  shellspec_readfile_once SHELLSPEC_STDOUT "$SHELLSPEC_STDOUT_FILE"
   if [ ${SHELLSPEC_STDOUT+x} ]; then
     # shellcheck disable=SC2034
     SHELLSPEC_SUBJECT=$SHELLSPEC_STDOUT
@@ -17,5 +18,8 @@
   fi
   shellspec_off UNHANDLED_STDOUT
 
-  eval shellspec_syntax_dispatch modifier line ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier line ;;
+    *) shellspec_syntax_dispatch modifier line "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/subjects/path.sh new/lib/core/subjects/path.sh
--- old/lib/core/subjects/path.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/subjects/path.sh	2025-12-23 15:20:28.000000000 +0100
@@ -19,5 +19,8 @@
 
   shift
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/subjects/status.sh new/lib/core/subjects/status.sh
--- old/lib/core/subjects/status.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/subjects/status.sh	2025-12-23 15:20:28.000000000 +0100
@@ -14,5 +14,8 @@
 
   shellspec_off UNHANDLED_STATUS
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/subjects/stderr.sh new/lib/core/subjects/stderr.sh
--- old/lib/core/subjects/stderr.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/subjects/stderr.sh	2025-12-23 15:20:28.000000000 +0100
@@ -8,6 +8,7 @@
 shellspec_subject_stderr() {
   # shellcheck disable=SC2034
   SHELLSPEC_META='text'
+  shellspec_readfile_once SHELLSPEC_STDERR "$SHELLSPEC_STDERR_FILE"
   if [ ${SHELLSPEC_STDERR+x} ]; then
     # shellcheck disable=SC2034
     SHELLSPEC_SUBJECT=$SHELLSPEC_STDERR
@@ -18,12 +19,16 @@
 
   shellspec_off UNHANDLED_STDERR
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
 
 shellspec_subject_entire_stderr() {
   # shellcheck disable=SC2034
   SHELLSPEC_META='text'
+  shellspec_readfile_once SHELLSPEC_STDERR "$SHELLSPEC_STDERR_FILE"
   if [ ${SHELLSPEC_STDERR+x} ]; then
     # shellcheck disable=SC2034
     SHELLSPEC_SUBJECT=$SHELLSPEC_STDERR
@@ -33,5 +38,8 @@
 
   shellspec_off UNHANDLED_STDERR
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/subjects/stdout.sh new/lib/core/subjects/stdout.sh
--- old/lib/core/subjects/stdout.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/subjects/stdout.sh	2025-12-23 15:20:28.000000000 +0100
@@ -8,6 +8,7 @@
 shellspec_subject_stdout() {
   # shellcheck disable=SC2034
   SHELLSPEC_META='text'
+  shellspec_readfile_once SHELLSPEC_STDOUT "$SHELLSPEC_STDOUT_FILE"
   if [ ${SHELLSPEC_STDOUT+x} ]; then
     # shellcheck disable=SC2034
     SHELLSPEC_SUBJECT=$SHELLSPEC_STDOUT
@@ -18,12 +19,16 @@
 
   shellspec_off UNHANDLED_STDOUT
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
 
 shellspec_subject_entire_stdout() {
   # shellcheck disable=SC2034
   SHELLSPEC_META='text'
+  shellspec_readfile_once SHELLSPEC_STDOUT "$SHELLSPEC_STDOUT_FILE"
   if [ ${SHELLSPEC_STDOUT+x} ]; then
     # shellcheck disable=SC2034
     SHELLSPEC_SUBJECT=$SHELLSPEC_STDOUT
@@ -33,5 +38,8 @@
 
   shellspec_off UNHANDLED_STDOUT
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/subjects/value.sh new/lib/core/subjects/value.sh
--- old/lib/core/subjects/value.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/subjects/value.sh	2025-12-23 15:20:28.000000000 +0100
@@ -12,5 +12,8 @@
   SHELLSPEC_SUBJECT=$1
   shift
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/subjects/variable.sh new/lib/core/subjects/variable.sh
--- old/lib/core/subjects/variable.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/subjects/variable.sh	2025-12-23 15:20:28.000000000 +0100
@@ -14,5 +14,8 @@
   fi
   shift
 
-  eval shellspec_syntax_dispatch modifier ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier ;;
+    *) shellspec_syntax_dispatch modifier "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/subjects/word.sh new/lib/core/subjects/word.sh
--- old/lib/core/subjects/word.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/subjects/word.sh	2025-12-23 15:20:28.000000000 +0100
@@ -8,6 +8,7 @@
 
   # shellcheck disable=SC2034
   SHELLSPEC_META="text"
+  shellspec_readfile_once SHELLSPEC_STDOUT "$SHELLSPEC_STDOUT_FILE"
   if [ ${SHELLSPEC_STDOUT+x} ]; then
     # shellcheck disable=SC2034
     SHELLSPEC_SUBJECT=$SHELLSPEC_STDOUT
@@ -17,5 +18,8 @@
   fi
   shellspec_off UNHANDLED_STDOUT
 
-  eval shellspec_syntax_dispatch modifier word ${1+'"$@"'}
+  case $# in
+    0) shellspec_syntax_dispatch modifier word ;;
+    *) shellspec_syntax_dispatch modifier word "$@" ;;
+  esac
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/subjects.sh new/lib/core/subjects.sh
--- old/lib/core/subjects.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/subjects.sh	2025-12-23 15:20:28.000000000 +0100
@@ -3,6 +3,7 @@
 shellspec_proxy 'shellspec_subject' 'shellspec_syntax_dispatch subject'
 shellspec_syntax_compound 'shellspec_subject_entire'
 
+shellspec_import 'core/subjects/fd'
 shellspec_import 'core/subjects/line'
 shellspec_import 'core/subjects/path'
 shellspec_import 'core/subjects/status'
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/syntax.sh new/lib/core/syntax.sh
--- old/lib/core/syntax.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/syntax.sh	2025-12-23 15:20:28.000000000 +0100
@@ -95,3 +95,32 @@
   done
   eval "${SHELLSPEC_EVAL}${SHELLSPEC_LF}}"
 }
+
+shellspec_syntax_following_words() {
+  set -- "$1" "${SHELLSPEC_SYNTAXES#:}" "" ""
+
+  while [ "$2" ] && set -- "$1" "${2#*:}" "${2%%:*}" "$4"; do
+    eval "set -- \"\$@\" \${3#${1}_}"
+    case $5 in (*_*) continue; esac
+    set -- "$1" "$2" "$3" "$4${4:+ }$5"
+  done
+  eval "set -- $4"
+
+  shellspec_syntax_following_words_callback() {
+    [ $(( ($2 - 1) % 8)) -eq 0 ] && shellspec_puts '  '
+    shellspec_puts "$1"
+    [ "$2" -eq "$3" ] || shellspec_puts ', '
+    [ $(( $2 % 8)) -ne 0 ] || shellspec_puts "$SHELLSPEC_LF"
+  }
+  shellspec_each shellspec_syntax_following_words_callback "$@"
+}
+
+shellspec_syntax_name() {
+  [ "${SHELLSPEC_SYNTAX_NAME:-}" ] || return 0
+  set -- "${SHELLSPEC_SYNTAX_NAME#shellspec_}"
+  set -- "${1#*_}_${1%%_*}_" "" ""
+  while [ "$1" ] && set -- "${1#*_}" "${1%%_*}" "$3"; do
+    set -- "$1" "$2" "$3${3:+ }$2"
+  done
+  shellspec_putsn "$3"
+}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/utils.sh new/lib/core/utils.sh
--- old/lib/core/utils.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/utils.sh	2025-12-23 15:20:28.000000000 +0100
@@ -55,7 +55,7 @@
 }
 
 shellspec_shopt() {
-  #shellcheck disable=SC2039
+  #shellcheck disable=SC3044
   case $1 in
     -o) shopt -s "$2" 2>/dev/null || set -o "$2" ;;
     +o) shopt -u "$2" 2>/dev/null || set +o "$2" ;;
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/core/verb.sh new/lib/core/verb.sh
--- old/lib/core/verb.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/core/verb.sh	2025-12-23 15:20:28.000000000 +0100
@@ -25,8 +25,7 @@
   shellspec_output_if MATCHED && return 0
 
   shellspec_on FAILED
-  shellspec_output UNMATCHED
-  shellspec_output_failure_message
+  shellspec_output UNMATCHED "$(shellspec_get_failure_message positive)"
 }
 
 shellspec_verb_should_not() {
@@ -46,6 +45,5 @@
   shellspec_output_unless MATCHED && return 0
 
   shellspec_on FAILED
-  shellspec_output UNMATCHED
-  shellspec_output_failure_message_when_negated
+  shellspec_output UNMATCHED "$(shellspec_get_failure_message negative)"
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/general.sh new/lib/general.sh
--- old/lib/general.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/general.sh	2025-12-23 15:20:28.000000000 +0100
@@ -1,4 +1,11 @@
-#shellcheck shell=sh disable=SC2016
+#shellcheck shell=sh disable=SC2004,SC2016
+
+# Workaround for ksh 2020: Heisenbug
+case "${KSH_VERSION:-}" in (*2020*)
+  ( exec 3>/dev/null 4>&3 5>&3 6>&3 7>&3 8>&3 9>&3
+    eval "dummy() { $(printf %8192s :); }"
+  ) 3>&- 4>&- 5>&- 6>&- 7>&- 8>&- 9>&-
+esac
 
 : "${SHELLSPEC_SHELL_TYPE:=}" "${SHELLSPEC_SHELL_VERSION:=}"
 SHELLSPEC_SH_VERSION=$(eval 'echo "${.sh.version}"' 2>/dev/null) ||:
@@ -11,6 +18,7 @@
   shellspec_shell_version zsh  ZSH_VERSION  && return 0
   shellspec_shell_version yash YASH_VERSION && return 0
   shellspec_shell_version posh POSH_VERSION && return 0
+  shellspec_shell_version oil OIL_VERSION && return 0
   if shellspec_shell_version ksh KSH_VERSION; then
     case $SHELLSPEC_SHELL_VERSION in
       *MIRBSD* ) SHELLSPEC_SHELL_TYPE=mksh ;;
@@ -88,6 +96,7 @@
   shellspec_find_module "$SHELLSPEC_LOAD_PATH" "$2" "$1"
 }
 
+# shellcheck disable=SC2295
 shellspec_module_exists() {
   set -- "$1" "${2:-$SHELLSPEC_LOAD_PATH}"
   [ -e "${2%%$SHELLSPEC_PATHSEP*}/$1.sh" ] && return 0
@@ -99,6 +108,7 @@
   return 1
 }
 
+# shellcheck disable=SC2295
 shellspec_find_module() {
   if [ -e "${1%%$SHELLSPEC_PATHSEP*}/$2.sh" ]; then
     eval "$3=\${1%%\$SHELLSPEC_PATHSEP*}/\$2.sh"
@@ -267,6 +277,7 @@
   shellspec_loop "$1" $(($2 - 1))
 }
 
+# shellcheck disable=SC2295
 shellspec_get_line() {
   [ "$2" -le 0 ] && set -- "$1" "$2" ""
   while [ "$2" -gt 1 ]; do
@@ -279,6 +290,7 @@
   unset "$1" ||:
 }
 
+# shellcheck disable=SC2295
 shellspec_count_lines() {
   set -- "$1" "$2" 0
   while [ "$2" ]; do
@@ -301,6 +313,7 @@
   shellspec_padding_ "$1" "$2" $(($3 - 1))
 }
 
+# shellcheck disable=SC2295
 shellspec_wrap() {
   [ ! "$2" ] && eval "$1=" && return 0
   case $2 in
@@ -315,13 +328,130 @@
   eval "$1=\$5"
 }
 
-shellspec_readfile() {
-  set -- "$1" "$2" ""
-  eval "$1="
-  while IFS= read -r "$1"; do
-    eval "set -- \"\$1\" \"\$2\" \"\$3\${$1}\$SHELLSPEC_LF\""
-  done < "$2" &&:
-  eval "$1=\"\$3\${$1}\""
+if [ "$SHELLSPEC_BUILTIN_READARRAY" ]; then
+  shellspec_readfile() { shellspec_readfile_bash_readarray "$@"; }
+elif [ "$SHELLSPEC_SEEKABLE" ]; then
+  shellspec_readfile() { shellspec_readfile_ksh_readall "$@"; }
+elif [ "${ZSH_VERSION:-}" ]; then
+  # shellcheck disable=SC2039
+  shellspec_readfile() {
+    if zmodload -e zsh/mapfile; then
+      shellspec_readfile_zsh_mapfile "$@"
+    elif [ "$SHELLSPEC_READ_DELIM" ]; then
+      shellspec_readfile_read_delim "$@"
+    elif [ "$SHELLSPEC_STRING_CONCAT" ]; then
+      shellspec_readfile_zsh_concat "$@"
+    else
+      shellspec_readfile_zsh_array "$@"
+    fi
+  }
+elif [ "$SHELLSPEC_READ_DELIM" ]; then
+  shellspec_readfile() { shellspec_readfile_read_delim "$@"; }
+elif [ "$SHELLSPEC_YASH_ARRAY" ]; then
+  shellspec_readfile() { shellspec_readfile_yash_array "$@"; }
+else
+  shellspec_readfile() { shellspec_readfile_posix "$@"; }
+fi
+
+# shellcheck disable=SC3043,SC3044
+shellspec_readfile_bash_readarray() {
+  [ -e "$2" ] || { unset "$1" ||:; return 0; }
+  [ -s "$2" ] || { eval "$1=''"; return 0; }
+  local IFS=""
+  readarray "$1" < "$2"
+  eval "$1=\"\${$1[*]}\""
+}
+
+# shellcheck disable=SC2039
+shellspec_readfile_ksh_readall() {
+  [ -e "$2" ] || { unset "$1" ||:; return 0; }
+  [ -s "$2" ] || { eval "$1=''"; return 0; }
+  set -- "$1" "$2" "${LC_ALL:-}" "${LC_ALL+x}"
+  LC_ALL=C
+  eval '{ read -N "$(<#((EOF)))" "$1" <#((0)); } < "$2"'
+  unset LC_ALL
+  [ "$4" ] && LC_ALL="$3"
+  return 0
+}
+
+# shellcheck disable=SC3045
+shellspec_readfile_read_delim() {
+  [ -e "$2" ] || { unset "$1" ||:; return 0; }
+  [ -s "$2" ] || { eval "$1=''"; return 0; }
+  IFS= read -r -d "" "$1" < "$2" ||:
+}
+
+# shellcheck disable=SC3044
+shellspec_readfile_yash_array() {
+  [ -e "$2" ] || { unset "$1" ||:; return 0; }
+  [ -s "$2" ] || { eval "$1=''"; return 0; }
+  typeset IFS="" shellspec_readfile_line=""
+  array -- "$1"
+  while read -r shellspec_readfile_line; do
+    array -i -- "$1" -1 "${shellspec_readfile_line}${SHELLSPEC_LF}"
+  done < "$2"
+  array -i -- "$1" -1 "$shellspec_readfile_line"
+  eval "$1=\"\${$1[*]}\""
+}
+
+shellspec_readfile_zsh_mapfile() {
+  [ -e "$2" ] || { unset "$1" ||:; return 0; }
+  [ -s "$2" ] || { eval "$1=''"; return 0; }
+  eval "$1=\"\${mapfile[\$2]}\""
+}
+
+shellspec_readfile_zsh_concat() {
+  [ -e "$2" ] || { unset "$1" ||:; return 0; }
+  [ -s "$2" ] || { eval "$1=''"; return 0; }
+  # shellcheck disable=SC3043
+  local shellspec_readfile_line='' shellspec_readfile_data=''
+  while IFS= read -r shellspec_readfile_line; do
+    # shellcheck disable=SC3024
+    shellspec_readfile_data+="${shellspec_readfile_line}${SHELLSPEC_LF}"
+  done < "$2"
+  # shellcheck disable=SC3024
+  shellspec_readfile_data+="$shellspec_readfile_line"
+  eval "$1=\"\$shellspec_readfile_data\""
+}
+
+# shellcheck disable=SC3043
+shellspec_readfile_zsh_array() {
+  [ -e "$2" ] || { unset "$1" ||:; return 0; }
+  [ -s "$2" ] || { eval "$1=''"; return 0; }
+  local shellspec_readfile_i=1 IFS="$SHELLSPEC_LF"
+  local -a shellspec_readfile_line
+  while IFS= read -r "shellspec_readfile_line[$shellspec_readfile_i]"; do
+    shellspec_readfile_i=$(($shellspec_readfile_i+1))
+  done < "$2"
+  eval "$1=\"\${shellspec_readfile_line[*]}\""
+}
+
+shellspec_readfile_posix() {
+  [ -e "$2" ] || { unset "$1" ||:; return 0; }
+  [ -s "$2" ] || { eval "$1=''"; return 0; }
+  shellspec_readfile_var=$1 shellspec_readfile_data='' shellspec_readfile_i=1
+  while IFS= read -r "shellspec_readfile_line_$shellspec_readfile_i"; do
+    shellspec_readfile_data="$shellspec_readfile_data\$1_$shellspec_readfile_i\$2"
+    shellspec_readfile_i=$(($shellspec_readfile_i+1))
+  done < "$2"
+  shellspec_readfile_data="$shellspec_readfile_data\$1_$shellspec_readfile_i"
+  set -- '$shellspec_readfile_line' "$SHELLSPEC_LF" "$IFS"
+  eval "shellspec_readfile_data=\"$shellspec_readfile_data\""
+
+  IFS="\$$SHELLSPEC_LF "
+  set -- "$3" $shellspec_readfile_data
+  IFS="$1"
+  shift 2
+
+  eval "$shellspec_readfile_var=\"$shellspec_readfile_data\""
+  IFS=" $IFS"
+  eval "unset $* shellspec_readfile_var shellspec_readfile_data shellspec_readfile_i"
+  IFS=${IFS#?}
+}
+
+shellspec_readfile_once() {
+  eval "[ \${$1+x} ] &&:" && return 0
+  shellspec_readfile "$@"
 }
 
 shellspec_capturefile() {
@@ -329,6 +459,19 @@
   shellspec_chomp "$@"
 }
 
+shellspec_head() {
+  set -- "$1" "${2:-3}" ""
+  eval "$1=''"
+  while IFS= read -r "$1" && [ "$2" -gt 0 ]; do
+    eval "set -- \"\$1\" \$((\$2 - 1)) \"\$3\${$1}\$SHELLSPEC_LF\""
+  done &&:
+  if eval "[ \"\${$1}\" ] &&:" && [ "$2" -eq 0 ]; then
+    eval "$1=\"\$3...\""
+  else
+    eval "$1=\"\$3\${$1}\""
+  fi
+}
+
 shellspec_trim() {
   SHELLSPEC_EVAL="
     $1=\${2:-}; [ \"\$$1\" ] || return 0; \
@@ -356,9 +499,13 @@
   else
     set -- "$1" "$2" "$3" "$4" ""
   fi
-  until [ _"$2" = _"${2#*"$3"}" ] && eval "$1=\$5\$2"; do
-    set -- "$1" "${2#*"$3"}" "$3" "$4" "$5${2%%"$3"*}$4"
+  while :; do
+    case $2 in
+      *"$3"*) set -- "$1" "${2#*"$3"}" "$3" "$4" "$5${2%%"$3"*}$4" ;;
+      *) break ;;
+    esac
   done
+  eval "$1=\$5\$2"
 }
 
 # $1: ret, $2: from, $3: to
@@ -372,6 +519,30 @@
   done
 }
 
+shellspec_replace_all_multiline_() {
+  [ $# -lt 5 ] && eval "set -- \"\$1\" \"\$2\" \"\${$2}\" \"\$3\" \"\$4\""
+  shellspec_replace_all_multiline_check "$4"
+  eval "$2=\$(shellspec_replace_all_multiline_lines \"\$@\"); $2=\${$2%_}"
+}
+
+shellspec_replace_all_multiline_check() {
+  case $1 in (*$SHELLSPEC_LF*)
+    echo "shellspec_replace_all_multiline: newline replacement is not supported" >&2
+    exit 1
+  esac
+}
+
+shellspec_replace_all_multiline_lines() {
+  shellspec_puts "$3" | {
+    while IFS= read -r line; do
+      "$1" line "$line" "$4" "$5"
+      shellspec_putsn "$line"
+    done
+    "$1" line "$line" "$4" "$5"
+    shellspec_puts "${line}_"
+  }
+}
+
 shellspec_includes_posix() {
   case $1 in (*"$2"*) ;; (*) false ;; esac
 }
@@ -446,6 +617,11 @@
     shellspec_includes() { shellspec_includes_posix "$@"; }
     shellspec_starts_with() { shellspec_starts_with_posix "$@"; }
     shellspec_ends_with() { shellspec_ends_with_posix "$@"; }
+    shellspec_replace_all_multiline() {
+      [ $# -lt 4 ] && eval "set -- \"\$1\" \"\${$1}\" \"\$2\" \"\$3\""
+      shellspec_replace_all_multiline_check "$3"
+      shellspec_replace_all_fast "$@"
+    }
     ;;
   1)
     # POSIX version (POSIX compliant)
@@ -455,6 +631,9 @@
     shellspec_includes() { shellspec_includes_posix "$@"; }
     shellspec_starts_with() { shellspec_starts_with_posix "$@"; }
     shellspec_ends_with() { shellspec_ends_with_posix "$@"; }
+    shellspec_replace_all_multiline() {
+      shellspec_replace_all_multiline_ shellspec_replace_all_posix "$@"
+    }
     ;;
   2)
     # Fallback version
@@ -462,6 +641,9 @@
     shellspec_includes() { shellspec_includes_fallback "$@"; }
     shellspec_starts_with() { shellspec_starts_with_fallback "$@"; }
     shellspec_ends_with() { shellspec_ends_with_fallback "$@"; }
+    shellspec_replace_all_multiline() {
+      shellspec_replace_all_multiline_ shellspec_replace_all_fallback "$@"
+    }
 esac
 
 # $2: pattern should be escaped
@@ -477,11 +659,13 @@
 shellspec_pack() {
   SHELLSPEC_EVAL="
     $1=''; shift; \
-    for $1; do \
-      shellspec_escape_quote $1 \"\${$1}\"; \
-      set -- \"\$@\" \"'\${$1}'\"; \
-      shift; \
-    done; \
+    if [ \$# -gt 0 ]; then \
+      for $1 in \"\$@\"; do \
+        shellspec_escape_quote $1 \"\${$1}\"; \
+        set -- \"\$@\" \"'\${$1}'\"; \
+        shift; \
+      done; \
+    fi; \
     IFS=\" \$IFS\"; set -- \"\${*:-}\"; IFS=\${IFS#?}; unset $1; $1=\$1
   "
   eval "$SHELLSPEC_EVAL"
@@ -563,11 +747,12 @@
 
 if [ "${ZSH_VERSION:-}" ]; then
   shellspec_get_nth() {
-    set -- "$1" "$2" "${3#"${3%%[1-9]*}"}" "${4:-}" "$IFS"
+    set -f -- "$1" "$2" "${3#"${3%%[1-9]*}"}" "${4:-}" "$IFS" "$-"
     IFS=${4:-$SHELLSPEC_IFS}
     eval "set -- \"\$@\" \${=2}"
     IFS=$5
-    [ $# -ge $(($3 + 5)) ] && eval "$1=\${$(($3 + 5))}"
+    [ "${6#*f}" = "$6" ] && set +f
+    [ $# -ge $(($3 + 6)) ] && eval "$1=\${$(($3 + 6))}"
   }
 else
   shellspec_get_nth() {
@@ -583,6 +768,7 @@
   }
 fi
 
+# shellcheck disable=SC2295
 shellspec_which() {
   set -- "$1" "${PATH%$SHELLSPEC_PATHSEP}${SHELLSPEC_PATHSEP}"
   while [ "${2%$SHELLSPEC_PATHSEP}" ]; do
@@ -609,7 +795,7 @@
 
     # workaround for posh 0.10.2: glob does not expand when set -u
     set +o noglob +u
-    # shellcheck disable=SC2039
+    # shellcheck disable=SC3044
     [ "${SHELLSPEC_FAILGLOB_AVAILABLE:-}" ] && shopt -u failglob
     [ "${SHELLSPEC_NOMATCH_AVAILABLE:-}" ] && setopt NO_NOMATCH
 
@@ -644,7 +830,7 @@
     return 0
   fi
   if [ "$SHELLSPEC_BUILTIN_TYPESETF" ]; then
-    # shellcheck disable=SC2039
+    # shellcheck disable=SC3044
     typeset -f "$1" >/dev/null 2>&1 || return 0
   elif [ "${POSH_VERSION:-}" ]; then
     ( unset -f "$1" 2>/dev/null ) || return 0
@@ -664,12 +850,10 @@
   eval "$2_callback() { $1 \"\$@\"; }; $(shellspec_exportp | "$2_rework")" &&:
 }
 shellspec_list_envkeys_rework() {
-  set -- printf '%s\n'
   while IFS= read -r line; do
     shellspec_list_envkeys_sanitize line "$line"
-    set -- "$@" "shellspec_list_envkeys_parse $line || return \$?"
+    shellspec_putsn "shellspec_list_envkeys_parse $line || return \$?"
   done
-  "$@"
 }
 shellspec_list_envkeys_parse() {
   while [ $# -gt 2 ]; do
@@ -763,3 +947,5 @@
 shellspec_rm() { "$SHELLSPEC_RM" "$@"; }
 shellspec_chmod() { "$SHELLSPEC_CHMOD" "$@"; }
 shellspec_sleep() { "$SHELLSPEC_SLEEP" "$@"; }
+shellspec_od() { "$SHELLSPEC_OD" "$@"; }
+shellspec_hexdump() { "$SHELLSPEC_HEXDUMP" "$@"; }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/getoptions_abbr.sh new/lib/getoptions_abbr.sh
--- old/lib/getoptions_abbr.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/getoptions_abbr.sh	2025-12-23 15:20:28.000000000 +0100
@@ -1,16 +1,17 @@
-# shellcheck shell=sh disable=SC2016,SC2154
+# shellcheck shell=sh disable=SC2016,SC2317
 # [getoptions_abbr] License: Creative Commons Zero v1.0 Universal
 getoptions_abbr() {
 	abbr() {
 		_3 "case '$1' in"
 		_4 '"$1") OPTARG=; break ;;'
 		_4 '$1*) OPTARG="$OPTARG '"$1"'"'
-		_3 'esac'
+		_3 "esac"
 	}
 	args() {
 		abbr=1
 		shift
-		for i; do
+		[ $# -gt 0 ] || return 0
+		for i in "$@"; do
 			case $i in
 				--) break ;;
 				[!-+]*) eval "${i%%:*}=\${i#*:}"
@@ -18,7 +19,7 @@
 		done
 		[ "$abbr" ] || return 0
 
-		for i; do
+		for i in "$@"; do
 			case $i in
 				--) break ;;
 				--\{no-\}*) abbr "--${i#--\{no-\}}"; abbr "--no-${i#--\{no-\}}" ;;
@@ -36,20 +37,20 @@
 	_2 'while [ ${#1} -gt 2 ]; do'
 	_3 'case $1 in (*[!a-zA-Z0-9_-]*) break; esac'
 	"$@"
-	_3 'break'
-	_2 'done'
+	_3 "break"
+	_2 "done"
 	_2 'case ${OPTARG# } in'
-	_3 '*\ *)'
+	_3 "*\ *)"
 	_4 'eval "set -- $OPTARG $1 $OPTARG"'
 	_4 'OPTIND=$((($#+1)/2)) OPTARG=$1; shift'
 	_4 'while [ $# -gt "$OPTIND" ]; do OPTARG="$OPTARG, $1"; shift; done'
 	_4 'set "Ambiguous option: $1 (could be $OPTARG)" ambiguous "$@"'
 	[ "$_error" ] && _4 "$_error" '"$@" >&2 || exit $?'
 	_4 'echo "$1" >&2'
-	_4 'exit 1 ;;'
-	_3 '?*)'
+	_4 "exit 1 ;;"
+	_3 "?*)"
 	_4 '[ "$2" = "$3" ] || OPTARG="$OPTARG=$2"'
 	_4 "shift 3; eval 'set -- \"\${OPTARG# }\"' \${1+'\"\$@\"'}; OPTARG= ;;"
-	_3 '*) shift 2'
-	_2 'esac'
+	_3 "*) shift 2"
+	_2 "esac"
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/getoptions_base.sh new/lib/getoptions_base.sh
--- old/lib/getoptions_base.sh	1970-01-01 01:00:00.000000000 +0100
+++ new/lib/getoptions_base.sh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,200 @@
+# shellcheck shell=sh disable=SC2016,SC2317
+# [getoptions] License: Creative Commons Zero v1.0 Universal
+getoptions() {
+	_error="" _on=1 _no="" _export="" _plus="" _mode="" _alt="" _rest="" _def=""
+	_flags="" _nflags="" _opts="" _help="" _abbr="" _cmds="" _init=@empty IFS=" "
+	[ $# -lt 2 ] && set -- "${1:?No parser definition}" -
+	[ "$2" = - ] && _def=getoptions_parse
+
+	i="					"
+	while eval "_${#i}() { echo \"$i\$@\"; }" && [ "$i" ]; do i=${i#?}; done
+
+	quote() {
+		q="$2'" r=""
+		while [ "$q" ]; do r="$r${q%%\'*}'\''" && q=${q#*\'}; done
+		q="'${r%????}'" && q=${q#\'\'} && q=${q%\'\'}
+		eval "$1=\${q:-\"''\"}"
+	}
+	code() {
+		[ "${1#:}" = "$1" ] && c=3 || c=4
+		eval "[ ! \${$c:+x} ] || $2 \"\$$c\""
+	}
+	sw() { sw="$sw${sw:+|}$1"; }
+	kv() { eval "${2-}${1%%:*}=\${1#*:}"; }
+	loop() { [ $# -gt 1 ] && [ "$2" != -- ]; }
+
+	invoke() { eval '"_$@"'; }
+	prehook() { invoke "$@"; }
+	for i in setup flag param option disp msg; do
+		eval "$i() { prehook $i \"\$@\"; }"
+	done
+
+	args() {
+		on=$_on no=$_no export=$_export init=$_init _hasarg=$1 && shift
+		while loop "$@" && shift; do
+			case $1 in
+				-?) [ "$_hasarg" ] && _opts="$_opts${1#-}" || _flags="$_flags${1#-}" ;;
+				+?) _plus=1 _nflags="$_nflags${1#+}" ;;
+				[!-+]*) kv "$1"
+			esac
+		done
+	}
+	defvar() {
+		case $init in
+			@none) : ;;
+			@export) code "$1" _0 "export $1" ;;
+			@empty) code "$1" _0 "${export:+export }$1=''" ;;
+			@unset) code "$1" _0 "unset $1 ||:" "unset OPTARG ||:; ${1#:}" ;;
+			*)
+				case $init in @*) eval "init=\"=\${${init#@}}\""; esac
+				case $init in [!=]*) _0 "$init"; return 0; esac
+				quote init "${init#=}"
+				code "$1" _0 "${export:+export }$1=$init" "OPTARG=$init; ${1#:}"
+		esac
+	}
+	_setup() {
+		[ "${1#-}" ] && _rest=$1
+		while loop "$@" && shift; do kv "$1" _; done
+	}
+	_flag() { args "" "$@"; defvar "$@"; }
+	_param() { args 1 "$@"; defvar "$@"; }
+	_option() { args 1 "$@"; defvar "$@"; }
+	_disp() { args "" "$@"; }
+	_msg() { args "" _ "$@"; }
+
+	cmd() { _mode=@ _cmds="$_cmds${_cmds:+|}'$1'"; }
+	"$@"
+	cmd() { :; }
+	_0 "${_rest:?}=''"
+
+	_0 "${_def:-$2}() {"
+	_1 'OPTIND=$(($#+1))'
+	_1 "while OPTARG= && [ \"\${$_rest}\" != x ] && [ \$# -gt 0 ]; do"
+	[ "$_abbr" ] && getoptions_abbr "$@"
+
+	args() {
+		sw="" validate="" pattern="" counter="" on=$_on no=$_no export=$_export
+		while loop "$@" && shift; do
+			case $1 in
+				--\{no-\}*) i=${1#--?no-?}; sw "'--$i'|'--no-$i'" ;;
+				--with\{out\}-*) i=${1#--*-}; sw "'--with-$i'|'--without-$i'" ;;
+				[-+]? | --*) sw "'$1'" ;;
+				*) kv "$1"
+			esac
+		done
+		quote on "$on"
+		quote no "$no"
+	}
+	setup() { :; }
+	_flag() {
+		args "$@"
+		[ "$counter" ] && on=1 no=-1 v="\$((\${$1:-0}+\$OPTARG))" || v=""
+		_3 "$sw)"
+		_4 '[ "${OPTARG:-}" ] && OPTARG=${OPTARG#*\=} && set "noarg" "$1" && break'
+		_4 "eval '[ \${OPTARG+x} ] &&:' && OPTARG=$on || OPTARG=$no"
+		valid "$1" "${v:-\$OPTARG}"
+		_4 ";;"
+	}
+	_param() {
+		args "$@"
+		_3 "$sw)"
+		_4 '[ $# -le 1 ] && set "required" "$1" && break'
+		_4 'OPTARG=$2'
+		valid "$1" '$OPTARG'
+		_4 "shift ;;"
+	}
+	_option() {
+		args "$@"
+		_3 "$sw)"
+		_4 'set -- "$1" "$@"'
+		_4 '[ ${OPTARG+x} ] && {'
+		_5 'case $1 in --no-*|--without-*) set "noarg" "${1%%\=*}"; break; esac'
+		_5 '[ "${OPTARG:-}" ] && { shift; OPTARG=$2; } ||' "OPTARG=$on"
+		_4 "} || OPTARG=$no"
+		valid "$1" '$OPTARG'
+		_4 "shift ;;"
+	}
+	valid() {
+		set -- "$validate" "$pattern" "$1" "$2"
+		[ "$1" ] && _4 "$1 || { set -- ${1%% *}:\$? \"\$1\" $1; break; }"
+		[ "$2" ] && {
+			_4 "case \$OPTARG in $2) ;;"
+			_5 '*) set "pattern:'"$2"'" "$1"; break'
+			_4 "esac"
+		}
+		code "$3" _4 "${export:+export }$3=\"$4\"" "${3#:}"
+	}
+	_disp() {
+		args "$@"
+		_3 "$sw)"
+		code "$1" _4 "echo \"\${$1}\"" "${1#:}"
+		_4 "exit 0 ;;"
+	}
+	_msg() { :; }
+
+	[ "$_alt" ] && _2 'case $1 in -[!-]?*) set -- "-$@"; esac'
+	_2 'case $1 in'
+	_wa() { _4 "eval 'set -- $1' \${1+'\"\$@\"'}"; }
+	_op() {
+		_3 "$1) OPTARG=\$1; shift"
+		_wa '"${OPTARG%"${OPTARG#??}"}" '"$2"'"${OPTARG#??}"'
+		_4 "${4:-}$3"
+	}
+	_3 '--?*=*) OPTARG=$1; shift'
+	_wa '"${OPTARG%%\=*}" "${OPTARG#*\=}"'
+	_4 ";;"
+	_3 "--no-*|--without-*) unset OPTARG ;;"
+	[ "$_alt" ] || {
+		[ "$_opts" ] && _op "-[$_opts]?*" "" ";;"
+		[ ! "$_flags" ] || _op "-[$_flags]?*" - "OPTARG= ;;" \
+			'case $2 in --*) set -- "$1" unknown "$2" && '"$_rest=x; esac;"
+	}
+	[ "$_plus" ] && {
+		[ "$_nflags" ] && _op "+[$_nflags]?*" + "unset OPTARG ;;"
+		_3 "+*) unset OPTARG ;;"
+	}
+	_2 "esac"
+	_2 'case $1 in'
+	"$@"
+	rest() {
+		_4 'while [ $# -gt 0 ]; do'
+		_5 "$_rest=\"\${$_rest}" '\"\${$(($OPTIND-$#))}\""'
+		_5 "shift"
+		_4 "done"
+		_4 "break ;;"
+	}
+	_3 "--)"
+	[ "$_mode" = @ ] || _4 "shift"
+	rest
+	_3 "[-${_plus:++}]?*)" 'set "unknown" "$1"; break ;;'
+	_3 "*)"
+	case $_mode in
+		@)
+			_4 "case \$1 in ${_cmds:-*}) ;;"
+			_5 '*) set "notcmd" "$1"; break'
+			_4 "esac"
+			rest ;;
+		+) rest ;;
+		*) _4 "$_rest=\"\${$_rest}" '\"\${$(($OPTIND-$#))}\""'
+	esac
+	_2 "esac"
+	_2 "shift"
+	_1 "done"
+	_1 '[ $# -eq 0 ] && { OPTIND=1; unset OPTARG; return 0; }'
+	_1 'case $1 in'
+	_2 'unknown) set "Unrecognized option: $2" "$@" ;;'
+	_2 'noarg) set "Does not allow an argument: $2" "$@" ;;'
+	_2 'required) set "Requires an argument: $2" "$@" ;;'
+	_2 'pattern:*) set "Does not match the pattern (${1#*:}): $2" "$@" ;;'
+	_2 'notcmd) set "Not a command: $2" "$@" ;;'
+	_2 '*) set "Validation error ($1): $2" "$@"'
+	_1 "esac"
+	[ "$_error" ] && _1 "$_error" '"$@" >&2 || exit $?'
+	_1 'echo "$1" >&2'
+	_1 "exit 1"
+	_0 "}"
+
+	[ "$_help" ] && eval "shift 2; getoptions_help $1 $_help" ${3+'"$@"'}
+	[ "$_def" ] && _0 "eval $_def \${1+'\"\$@\"'}; eval set -- \"\${$_rest}\""
+	_0 "# Do not execute" # exit 1
+}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/getoptions_help.sh new/lib/getoptions_help.sh
--- old/lib/getoptions_help.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/getoptions_help.sh	2025-12-23 15:20:28.000000000 +0100
@@ -1,14 +1,14 @@
-# shellcheck shell=sh
+# shellcheck shell=sh disable=SC2016,SC2317
 # [getoptions_help] License: Creative Commons Zero v1.0 Universal
 getoptions_help() {
-	_width='30,12' _plus='' _leading='  '
+	_width="30,12" _plus="" _leading="  "
 
 	pad() { p=$2; while [ ${#p} -lt "$3" ]; do p="$p "; done; eval "$1=\$p"; }
 	kv() { eval "${2-}${1%%:*}=\${1#*:}"; }
 	sw() { pad sw "$sw${sw:+, }" "$1"; sw="$sw$2"; }
 
 	args() {
-		_type=$1 var=${2%% *} sw='' label='' hidden='' && shift 2
+		_type=$1 var=${2%% *} sw="" label="" hidden="" && shift 2
 		while [ $# -gt 0 ] && i=$1 && shift && [ "$i" != -- ]; do
 			case $i in
 				--*) sw $((${_plus:+4}+4)) "$i" ;;
@@ -20,7 +20,7 @@
 		[ "$hidden" ] && return 0 || len=${_width%,*}
 
 		[ "$label" ] || case $_type in
-			setup | msg) label='' len=0 ;;
+			setup | msg) label="" len=0 ;;
 			flag | disp) label="$sw " ;;
 			param) label="$sw $var " ;;
 			option) label="${sw}[=$var] "
@@ -29,11 +29,12 @@
 		pad label "${label:+$_leading}$label" "$len"
 		[ ${#label} -le "$len" ] && [ $# -gt 0 ] && label="$label$1" && shift
 		echo "$label"
-		pad label '' "$len"
-		for i; do echo "$label$i"; done
+		pad label "" "$len"
+		[ $# -gt 0 ] || return 0
+		for i in "$@"; do echo "$label$i"; done
 	}
 
-	for i in setup flag param option disp 'msg -' cmd; do
+	for i in setup flag param option disp "msg -" cmd; do
 		eval "${i% *}() { args $i \"\$@\"; }"
 	done
 
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/getoptions.sh new/lib/getoptions.sh
--- old/lib/getoptions.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/getoptions.sh	1970-01-01 01:00:00.000000000 +0100
@@ -1,194 +0,0 @@
-# shellcheck shell=sh disable=SC2016
-# [getoptions] License: Creative Commons Zero v1.0 Universal
-getoptions() {
-	_error='' _on=1 _off='' _export='' _plus='' _mode='' _alt='' _rest=''
-	_flags='' _nflags='' _opts='' _help='' _abbr='' _cmds='' _init=@empty IFS=' '
-
-	_0() { echo "$@"; }
-	for i in 1 2 3 4 5; do eval "_$i() { _$((${i-}-1)) \"	\$@\"; }"; done
-
-	quote() {
-		q="$2'" r=''
-		while [ "$q" ]; do r="$r${q%%\'*}'\''" && q=${q#*\'}; done
-		q="'${r%????}'" && q=${q#\'\'} && q=${q%\'\'}
-		eval "$1=\${q:-\"''\"}"
-	}
-	code() {
-		[ "${1#:}" = "$1" ] && c=3 || c=4
-		eval "[ ! \${$c:+x} ] || $2 \"\$$c\""
-	}
-	kv() { eval "${2-}${1%%:*}=\${1#*:}"; }
-	loop() { [ $# -gt 1 ] && [ "$2" != -- ]; }
-
-	invoke() { eval '"_$@"'; }
-	prehook() { invoke "$@"; }
-	for i in setup flag param option disp msg; do
-		eval "$i() { prehook $i \"\$@\"; }"
-	done
-
-	args() {
-		on=$_on off=$_off export=$_export init=$_init _hasarg=$1 && shift
-		while loop "$@" && shift; do
-			case $1 in
-				-?) [ "$_hasarg" ] && _opts="$_opts${1#-}" || _flags="$_flags${1#-}" ;;
-				+?) _plus=1 _nflags="$_nflags${1#+}" ;;
-				[!-+]*) kv "$1"
-			esac
-		done
-	}
-	defvar() {
-		case $init in
-			@none) : ;;
-			@export) code "$1" _0 "export $1" ;;
-			@empty) code "$1" _0 "${export:+export }$1=''" ;;
-			@unset) code "$1" _0 "unset $1 ||:" "unset OPTARG ||:; ${1#:}" ;;
-			*)
-				case $init in @*) eval "init=\"=\${${init#@}}\""; esac
-				case $init in [!=]*) _0 "$init"; return 0; esac
-				quote init "${init#=}"
-				code "$1" _0 "${export:+export }$1=$init" "OPTARG=$init; ${1#:}"
-		esac
-	}
-	_setup() {
-		[ "${1#-}" ] && _rest=$1
-		while loop "$@" && shift; do kv "$1" _; done
-	}
-	_flag() { args '' "$@"; defvar "$@"; }
-	_param() { args 1 "$@"; defvar "$@"; }
-	_option() { args 1 "$@"; defvar "$@"; }
-	_disp() { args '' "$@"; }
-	_msg() { args '' _ "$@"; }
-
-	cmd() { _mode=@ _cmds="$_cmds${_cmds:+|}'$1'"; }
-	"$@"
-	cmd() { :; }
-	_0 "${_rest:?}=''"
-
-	_0 "$2() {"
-	_1 'OPTIND=$(($#+1))'
-	_1 'while OPTARG= && [ $# -gt 0 ]; do'
-	[ "$_abbr" ] && getoptions_abbr "$@"
-
-	args() {
-		sw='' validate='' pattern='' counter='' on=$_on off=$_off export=$_export
-		while loop "$@" && shift; do
-			case $1 in
-				--\{no-\}*) i=${1#--?no-?}; sw="$sw${sw:+|}'--$i'|'--no-$i'" ;;
-				[-+]? | --*) sw="$sw${sw:+|}'$1'" ;;
-				*) kv "$1"
-			esac
-		done
-		quote on "$on"
-		quote off "$off"
-	}
-	setup() { :; }
-	_flag() {
-		args "$@"
-		[ "$counter" ] && on=1 off=-1 v="\$((\${$1:-0}+\$OPTARG))" || v=''
-		_3 "$sw)"
-		_4 '[ "${OPTARG:-}" ] && OPTARG=${OPTARG#*\=} && set "noarg" "$1" && break'
-		_4 "eval '[ \${OPTARG+x} ] &&:' && OPTARG=$on || OPTARG=$off"
-		valid "$1" "${v:-\$OPTARG}"
-		_4 ';;'
-	}
-	_param() {
-		args "$@"
-		_3 "$sw)"
-		_4 '[ $# -le 1 ] && set "required" "$1" && break'
-		_4 'OPTARG=$2'
-		valid "$1" '$OPTARG'
-		_4 'shift ;;'
-	}
-	_option() {
-		args "$@"
-		_3 "$sw)"
-		_4 'set -- "$1" "$@"'
-		_4 '[ ${OPTARG+x} ] && {'
-		_5 'case $1 in --no-*) set "noarg" "${1%%\=*}"; break; esac'
-		_5 '[ "${OPTARG:-}" ] && { shift; OPTARG=$2; } ||' "OPTARG=$on"
-		_4 "} || OPTARG=$off"
-		valid "$1" '$OPTARG'
-		_4 'shift ;;'
-	}
-	valid() {
-		set -- "$validate" "$pattern" "$1" "$2"
-		[ "$1" ] && _4 "$1 || { set -- ${1%% *}:\$? \"\$1\" $1; break; }"
-		[ "$2" ] && {
-			_4 "case \$OPTARG in $2) ;;"
-			_5 '*) set "pattern:'"$2"'" "$1"; break'
-			_4 "esac"
-		}
-		code "$3" _4 "${export:+export }$3=\"$4\"" "${3#:}"
-	}
-	_disp() {
-		args "$@"
-		_3 "$sw)"
-		code "$1" _4 "echo \"\${$1}\"" "${1#:}"
-		_4 'exit 0 ;;'
-	}
-	_msg() { :; }
-
-	[ "$_alt" ] && _2 'case $1 in -[!-]?*) set -- "-$@"; esac'
-	_2 'case $1 in'
-	_wa() { _4 "eval 'set -- $1' \${1+'\"\$@\"'}"; }
-	_op() {
-		_3 "$1) OPTARG=\$1; shift"
-		_wa '"${OPTARG%"${OPTARG#??}"}" '"$2"'"${OPTARG#??}"'
-		_4 "$3"
-	}
-	_3 '--?*=*) OPTARG=$1; shift'
-	_wa '"${OPTARG%%\=*}" "${OPTARG#*\=}"'
-	_4 ';;'
-	_3 '--no-*) unset OPTARG ;;'
-	[ "$_alt" ] || {
-		[ "$_opts" ] && _op "-[$_opts]?*" '' ';;'
-		[ ! "$_flags" ] || _op "-[$_flags]?*" - 'OPTARG= ;;'
-	}
-	[ "$_plus" ] && {
-		[ "$_nflags" ] && _op "+[$_nflags]?*" + 'unset OPTARG ;;'
-		_3 '+*) unset OPTARG ;;'
-	}
-	_2 'esac'
-	_2 'case $1 in'
-	"$@"
-	rest() {
-		_4 'while [ $# -gt 0 ]; do'
-		_5 "$_rest=\"\${$_rest}" '\"\${$(($OPTIND-$#))}\""'
-		_5 'shift'
-		_4 'done'
-		_4 'break ;;'
-	}
-	_3 '--)'
-	[ "$_mode" = @ ] || _4 'shift'
-	rest
-	_3 "[-${_plus:++}]?*)"
-	case $_mode in [=#]) rest ;; *) _4 'set "unknown" "$1"; break ;;'; esac
-	_3 '*)'
-	case $_mode in
-		@)
-			_4 "case \$1 in ${_cmds:-*}) ;;"
-			_5 '*) set "notcmd" "$1"; break'
-			_4 'esac'
-			rest ;;
-		[+#]) rest ;;
-		*) _4 "$_rest=\"\${$_rest}" '\"\${$(($OPTIND-$#))}\""'
-	esac
-	_2 'esac'
-	_2 'shift'
-	_1 'done'
-	_1 '[ $# -eq 0 ] && { OPTIND=1; unset OPTARG; return 0; }'
-	_1 'case $1 in'
-	_2 'unknown) set "Unrecognized option: $2" "$@" ;;'
-	_2 'noarg) set "Does not allow an argument: $2" "$@" ;;'
-	_2 'required) set "Requires an argument: $2" "$@" ;;'
-	_2 'pattern:*) set "Does not match the pattern (${1#*:}): $2" "$@" ;;'
-	_2 'notcmd) set "Not a command: $2" "$@" ;;'
-	_2 '*) set "Validation error ($1): $2" "$@"'
-	_1 'esac'
-	[ "$_error" ] && _1 "$_error" '"$@" >&2 || exit $?'
-	_1 'echo "$1" >&2'
-	_1 'exit 1'
-	_0 '}'
-
-	[ ! "$_help" ] || eval "shift 2; getoptions_help $1 $_help" ${3+'"$@"'}
-}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/binary.sh new/lib/libexec/binary.sh
--- old/lib/libexec/binary.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/binary.sh	2025-12-23 15:20:28.000000000 +0100
@@ -3,9 +3,9 @@
 # busybox 1.1.3: `-A n`, `-t o1` not supported
 # busybox 1.10.2: `od -b` not working properly
 od_command() {
-  od -t o1 -v 2>/dev/null && return 0
-  [ $? -eq 127 ] && hexdump -b -v 2>/dev/null && return 0
-  od -b -v
+  shellspec_od -t o1 -v 2>/dev/null && return 0
+  [ $? -eq 127 ] && shellspec_hexdump -b -v 2>/dev/null && return 0
+  shellspec_od -b -v
 }
 
 octal_dump() {
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/grammar/directives new/lib/libexec/grammar/directives
--- old/lib/libexec/grammar/directives	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/grammar/directives	2025-12-23 15:20:28.000000000 +0100
@@ -8,3 +8,4 @@
 %text        => text_begin raw
 %text:raw    => text_begin raw
 %text:expand => text_begin expand
+%timeout     => timeout_metadata
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/grammar/dsls new/lib/libexec/grammar/dsls
--- old/lib/libexec/grammar/dsls	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/grammar/dsls	2025-12-23 15:20:28.000000000 +0100
@@ -31,3 +31,4 @@
 Include                               =>   include
 Dump                                  =>   control dump
 Mock                                  =>   mock
+UseFD                                 =>   control usefd
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/kcov-executor.sh new/lib/libexec/kcov-executor.sh
--- old/lib/libexec/kcov-executor.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/kcov-executor.sh	2025-12-23 15:20:28.000000000 +0100
@@ -33,7 +33,7 @@
     --bash-parse-files-in-dir=. \
     --configure=command-name="shellspec $*" \
     "$SHELLSPEC_COVERAGEDIR" "$SHELLSPEC_KCOV_IN_FILE"
-  )
+  ) 8>&1
 
   eval "kcov_postprocess; return $?"
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/optparser/optparser.sh new/lib/libexec/optparser/optparser.sh
--- old/lib/libexec/optparser/optparser.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/optparser/optparser.sh	2025-12-23 15:20:28.000000000 +0100
@@ -23,7 +23,7 @@
   eval "export $1=\"\${$1}\${$1:+$2}\$OPTARG\""
 }
 
-array() {
+path_list() {
   set -- "$1" "$OPTARG'" ""
   while [ "$2" ]; do
     set -- "$1" "${2#*\'}" "$3${2%%\'*}'\''"
@@ -135,6 +135,15 @@
   return 0
 }
 
+check_timeout_format() {
+  case $OPTARG in
+    0) return 0 ;;
+    *[!0-9smSM]*) return 1 ;;
+    *[0-9]|*[sSmM]) return 0 ;;
+    *) return 1 ;;
+  esac
+}
+
 check_formatter() {
   case $OPTARG in (*[!a-z0-9_]*) return 1; esac
   set -- progress documentation tap junit failures
@@ -166,6 +175,7 @@
     directory_not_available:*)
       set -- "$1" "The $4 option must be specified before other options and cannot be specified in an options file" ;;
     check_number:*) set -- "$1" "Not a number: $4" ;;
+    check_timeout_format:*) set -- "$1" "Invalid timeout format (use NUMBER[s|m], e.g., 30, 30s, 1m): $4" ;;
     check_module_name:*) set -- "$1" "Invalid module name: $4" ;;
     check_formatter:*) set -- "$1" "Invalid formatter name: $4" ;;
     check_env_name:*) set -- "$1" "Invalid environment name: $4" ;;
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/optparser/parser_definition_generated.sh new/lib/libexec/optparser/parser_definition_generated.sh
--- old/lib/libexec/optparser/parser_definition_generated.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/optparser/parser_definition_generated.sh	2025-12-23 15:20:28.000000000 +0100
@@ -1,6 +1,6 @@
 # shellcheck shell=sh
 # Generated by getoptions (BEGIN)
-# URL: https://github.com/ko1nksm/getoptions (v2.5.1)
+# URL: https://github.com/ko1nksm/getoptions (v3.3.1)
 export SHELLSPEC_SHELL=''
 export SHELLSPEC_REQUIRES=''
 export SHELLSPEC_OPTIONS=''
@@ -18,8 +18,9 @@
 export SHELLSPEC_ERROR_EXIT_CODE='102'
 export SHELLSPEC_PROFILER=''
 export SHELLSPEC_PROFILER_LIMIT='10'
+export SHELLSPEC_TIMEOUT='60'
 export SHELLSPEC_LOGFILE='/dev/tty'
-export SHELLSPEC_TMPDIR=${TMPDIR:-${TMP:-/tmp}}
+export SHELLSPEC_TMPDIR="${TMPDIR:-${TMP:-/tmp}}"
 export SHELLSPEC_KEEP_TMPDIR=''
 export SHELLSPEC_QUICK=''
 export SHELLSPEC_WORKERS='0'
@@ -50,7 +51,7 @@
 # shellcheck disable=SC2004,SC2034,SC2145,SC2194
 optparser_parse() {
   OPTIND=$(($#+1))
-  while OPTARG= && [ $# -gt 0 ]; do
+  while OPTARG= && [ "${params}" != x ] && [ $# -gt 0 ]; do
     set -- "${1%%\=*}" "${1#*\=}" "$@"
     while [ ${#1} -gt 2 ]; do
       case $1 in (*[!a-zA-Z0-9_-]*) break; esac
@@ -162,6 +163,14 @@
         "$1") OPTARG=; break ;;
         $1*) OPTARG="$OPTARG --no-boost"
       esac
+      case '--timeout' in
+        "$1") OPTARG=; break ;;
+        $1*) OPTARG="$OPTARG --timeout"
+      esac
+      case '--no-timeout' in
+        "$1") OPTARG=; break ;;
+        $1*) OPTARG="$OPTARG --no-timeout"
+      esac
       case '--log-file' in
         "$1") OPTARG=; break ;;
         $1*) OPTARG="$OPTARG --log-file"
@@ -374,13 +383,13 @@
       --?*=*) OPTARG=$1; shift
         eval 'set -- "${OPTARG%%\=*}" "${OPTARG#*\=}"' ${1+'"$@"'}
         ;;
-      --no-*) unset OPTARG ;;
+      --no-*|--without-*) unset OPTARG ;;
       -[sOIeCjfoPETD]?*) OPTARG=$1; shift
         eval 'set -- "${OPTARG%"${OPTARG#??}"}" "${OPTARG#??}"' ${1+'"$@"'}
         ;;
       -[wpcqrnxXFLvh]?*) OPTARG=$1; shift
         eval 'set -- "${OPTARG%"${OPTARG#??}"}" -"${OPTARG#??}"' ${1+'"$@"'}
-        OPTARG= ;;
+        case $2 in --*) set -- "$1" unknown "$2" && params=x; esac;OPTARG= ;;
       +[wpq]?*) OPTARG=$1; shift
         eval 'set -- "${OPTARG%"${OPTARG#??}"}" +"${OPTARG#??}"' ${1+'"$@"'}
         unset OPTARG ;;
@@ -406,7 +415,7 @@
       '-I'|'--load-path')
         [ $# -le 1 ] && set "required" "$1" && break
         OPTARG=$2
-        array SHELLSPEC_LOAD_PATH SHELLSPEC
+        path_list SHELLSPEC_LOAD_PATH SHELLSPEC
         shift ;;
       '--helperdir')
         [ $# -le 1 ] && set "required" "$1" && break
@@ -457,7 +466,7 @@
       '--fail-fast'|'--no-fail-fast')
         set -- "$1" "$@"
         [ ${OPTARG+x} ] && {
-          case $1 in --no-*) set "noarg" "${1%%\=*}"; break; esac
+          case $1 in --no-*|--without-*) set "noarg" "${1%%\=*}"; break; esac
           [ "${OPTARG:-}" ] && { shift; OPTARG=$2; } || OPTARG='1'
         } || OPTARG=''
         check_number || { set -- check_number:$? "$1" check_number; break; }
@@ -501,6 +510,17 @@
         eval '[ ${OPTARG+x} ] &&:' && OPTARG='1' || OPTARG=''
         boost SHELLSPEC
         ;;
+      '--timeout')
+        [ $# -le 1 ] && set "required" "$1" && break
+        OPTARG=$2
+        check_timeout_format || { set -- check_timeout_format:$? "$1" check_timeout_format; break; }
+        export SHELLSPEC_TIMEOUT="$OPTARG"
+        shift ;;
+      '--no-timeout')
+        [ "${OPTARG:-}" ] && OPTARG=${OPTARG#*\=} && set "noarg" "$1" && break
+        eval '[ ${OPTARG+x} ] &&:' && OPTARG='0' || OPTARG=''
+        export SHELLSPEC_TIMEOUT="$OPTARG"
+        ;;
       '--log-file')
         [ $# -le 1 ] && set "required" "$1" && break
         OPTARG=$2
@@ -756,8 +776,7 @@
           shift
         done
         break ;;
-      [-+]?*)
-        set "unknown" "$1"; break ;;
+      [-+]?*) set "unknown" "$1"; break ;;
       *)
         params="${params} \"\${$(($OPTIND-$#))}\""
     esac
@@ -815,6 +834,10 @@
         --{no-}boost                Increase the CPU frequency to boost up testing speed [default: disabled]
                                       Equivalent of --profile --profile-limit 0
                                       (Don't worry, this is not overclocking. This is joke option but works.)
+        --timeout SECONDS           Specify the default timeout for each test [default: 60]
+                                      Format: NUMBER[s|m] (e.g., 30, 30s, 1m, 90s)
+                                      Set to 0 to disable timeout
+        --no-timeout                Disable timeout for all tests
         --log-file LOGFILE          Log file for %logger directive and trace [default: "/dev/tty"]
         --tmpdir TMPDIR             Specify temporary directory [default: $TMPDIR, $TMP or "/tmp"]
         --keep-tmpdir               Do not cleanup temporary directory [default: disabled]
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/optparser/parser_definition.sh new/lib/libexec/optparser/parser_definition.sh
--- old/lib/libexec/optparser/parser_definition.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/optparser/parser_definition.sh	2025-12-23 15:20:28.000000000 +0100
@@ -29,7 +29,7 @@
   param OPTIONS -O --options var:PATH -- \
     'Specify the path to an additional options file'
 
-  array LOAD_PATH -I --load-path var:PATH -- \
+  path_list LOAD_PATH -I --load-path var:PATH -- \
     'Specify PATH to add to $SHELLSPEC_LOAD_PATH (may be used more than once)'
 
   param HELPERDIR --helperdir init:="spec" var:DIRECTORY -- \
@@ -94,10 +94,18 @@
     '  Equivalent of --profile --profile-limit 0' \
     "  (Don't worry, this is not overclocking. This is joke option but works.)"
 
+  param TIMEOUT --timeout validate:check_timeout_format init:=60 var:SECONDS -- \
+    'Specify the default timeout for each test [default: 60]' \
+    '  Format: NUMBER[s|m] (e.g., 30, 30s, 1m, 90s)' \
+    '  Set to 0 to disable timeout'
+
+  flag TIMEOUT --no-timeout on:0 -- \
+    'Disable timeout for all tests'
+
   param LOGFILE --log-file init:='/dev/tty' -- \
     'Log file for %logger directive and trace [default: "/dev/tty"]'
 
-  param TMPDIR --tmpdir init:"export $2_TMPDIR="'${TMPDIR:-${TMP:-/tmp}}' -- \
+  param TMPDIR --tmpdir init:"export $2_TMPDIR="'"${TMPDIR:-${TMP:-/tmp}}"' -- \
     'Specify temporary directory [default: $TMPDIR, $TMP or "/tmp"]'
 
   flag KEEP_TMPDIR --keep-tmpdir -- \
@@ -303,10 +311,10 @@
     shift 2
     param ":multiple $name '$separator'" "init:export $name=''" "$@"
   }
-  array() {
+  path_list() {
     name=${prefix}_$1
     shift
-    param ":array $name" "init:export $name=''" "$@"
+    param ":path_list $name" "init:export $name=''" "$@"
   }
   prehook() {
     helper=$1 name=$2
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/parallel-executor.sh new/lib/libexec/parallel-executor.sh
--- old/lib/libexec/parallel-executor.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/parallel-executor.sh	2025-12-23 15:20:28.000000000 +0100
@@ -7,14 +7,13 @@
 worker() {
   job() {
     # posh 0.10.2 workaround: uses mkdir instead of set -C
-    (mkdir "$SHELLSPEC_JOBDIR/$1.lock") 2>/dev/null || return 0
-    IFS= read -r specfile < "$SHELLSPEC_JOBDIR/$1.job"
+    jobfile="$SHELLSPEC_JOBDIR/$1"
+    ( mkdir "$jobfile.lock" ) 2>/dev/null || return 0
+    IFS= read -r specfile < "$jobfile.job"
     translator --no-metadata --no-finished --spec-no="$1" "$specfile" \
-      | eval "\$SHELLSPEC_SHELL" \
-        "$SHELLSPEC_OUTPUT_FD> \"\$SHELLSPEC_JOBDIR/\$1.stdout\"" \
-        "2> \"\$SHELLSPEC_JOBDIR/\$1.stderr\" &&:" &&:
-    echo "$?" > "$SHELLSPEC_JOBDIR/$1.status"
-    : > "$SHELLSPEC_JOBDIR/$1.done"
+      | $SHELLSPEC_SHELL >|"$jobfile.stdout" 2>|"$jobfile.stderr" &&:
+    echo "$?" >| "$jobfile.status"
+    : >| "$jobfile.done"
   }
   sequence job 1 "$2"
 }
@@ -22,11 +21,12 @@
 reduce() {
   i=0
   while [ $i -lt "$1" ] && i=$(($i + 1)); do
-    sleep_wait_until [ -e "$SHELLSPEC_JOBDIR/$i.done" ]
+    jobfile="$SHELLSPEC_JOBDIR/$i"
+    sleep_wait_until [ -e "$jobfile.done" ]
     # shellcheck disable=SC2039,SC3021
-    cat "$SHELLSPEC_JOBDIR/$i.stdout" >&"$SHELLSPEC_OUTPUT_FD"
-    cat "$SHELLSPEC_JOBDIR/$i.stderr" >&2
-    read -r exit_status < "$SHELLSPEC_JOBDIR/$i.status"
+    cat "$jobfile.stdout"
+    cat "$jobfile.stderr" >&2
+    read -r exit_status < "$jobfile.status"
     [ "$exit_status" -eq 0 ] || exit "$exit_status"
   done
 }
@@ -41,20 +41,16 @@
 
   specfile() {
     jobs=$(($jobs + 1))
-    putsn "$1" > "$SHELLSPEC_JOBDIR/$jobs.job"
+    putsn "$1" >| "$SHELLSPEC_JOBDIR/$jobs.job"
   }
   eval find_specfiles specfile ${1+'"$@"'}
   create_workdirs "$jobs"
 
   translator --no-finished | $SHELLSPEC_SHELL # output only metadata
-  # Workaround for osh: Use FD3 to avoid display "Started PID"
-  callback() {
-    { worker "$1" "$jobs" 2>&3 & } 3>&2 2>/dev/null
-    workers="$workers $!"
-  }
+  callback() { worker "$1" "$jobs" & nap; workers="$workers $!"; }
   sequence callback 1 "$SHELLSPEC_WORKERS"
-  (reduce "$jobs") &&:
-  eval "[ $? -ne 0 ] && return $?"
+  ( reduce "$jobs" ) &&:
+  eval "[ $? -eq 0 ] || return $?"
   translator --no-metadata | $SHELLSPEC_SHELL # output only finished
 }
 
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/prechecker.sh new/lib/libexec/prechecker.sh
--- old/lib/libexec/prechecker.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/prechecker.sh	2025-12-23 15:20:28.000000000 +0100
@@ -31,29 +31,26 @@
 
 minimum_version() {
   if [ $# -eq 0 ]; then
-    error "minimum_version: The minimum version is not specified"
-    return 1
+    abort "minimum_version: The minimum version is not specified"
   fi
 
   if ! check_semver "$1"; then
-    error "minimum_version: Invalid version format (major.minor.patch[-pre][+build]): $1"
-    return 1
+    abort "minimum_version: Invalid version format (major.minor.patch[-pre][+build]): $1"
   fi
 
-  semver "$1" -le "$VERSION" && return 0
-  error "ShellSpec version $1 or higher is required"
-  return 1
+  if ! semver "$1" -le "$VERSION"; then
+    abort "ShellSpec version $1 or higher is required"
+  fi
 }
 
 setenv() {
   while [ $# -gt 0 ]; do
     if ! ( export "${1%%\=*}=" ) 2>/dev/null; then
-      error "setenv: Invalid environment variable name: ${1%%\=*}"
-      return 1
+      abort "setenv: Invalid environment variable name: ${1%%\=*}"
     fi
     case $1 in
-      *=*) setenv_ "${1%%\=*}" "${1#*\=}" || return $? ;;
-      *) error "setenv: No value for environment variable: $1"; return 1
+      *=*) setenv_ "${1%%\=*}" "${1#*\=}" ;;
+      *) abort "setenv: No value for environment variable: $1"
     esac
     shift
   done
@@ -71,10 +68,51 @@
 unsetenv() {
   while [ $# -gt 0 ]; do
     if ! ( export "$1=" ) 2>/dev/null; then
-      error "unsetenv: Invalid environment variable name: $1"
-      return 1
+      abort "unsetenv: Invalid environment variable name: $1"
     fi
     echo "unset $1 ||:" >&9
     shift
   done
 }
+
+shell_mode() {
+  if [ "${ZSH_VERSION:-}" ]; then
+    echo "$(emulate 2>/dev/null || echo '(unknown)') emulation"
+  else
+    COLUMNS=10 set -o | {
+      mode='standard'
+      while read -r name value; do
+        value=${value##*[!a-zA-Z]}
+        case $name in
+          posix) name="POSIX" ;;
+          posixlycorrect) name="POSIXly-correct" ;;
+          *) continue ;;
+        esac
+        mode="$name mode ($value)"
+        break
+      done
+      echo "$mode"
+    }
+  fi
+}
+
+shellspec_precheck_run() {
+  unset "$1" ||:
+  set +e -- "$1" "$2" "$SHELLSPEC_TMPBASE/.shellspec-prechecker-exit-status"
+  if [ "$SHELLSPEC_DEFECT_BOSHEXIT" ] || [ "$SHELLSPEC_DEFECT_DEBUGXS" ]; then
+    [ -s "$3" ] && : > "$3"
+    ( set -e; eval "$2"; eval "[ $? -eq 0 ] || exit $?"; echo 1 >"$3" )
+    eval "[ -s \"\$3\" ] && $1='' || $1=$?"
+  elif [ "$SHELLSPEC_DEFECT_ZSHEXIT" ]; then
+    [ -s "$3" ] && : > "$3"
+    eval "$1"'=$( sf=$(printf "%q" "$3")
+      eval "exit() { echo \"\$1\" > \"$sf\"; { unset status; } 2>/dev/null; }"
+      set -e; '"$2"'; eval "[ $? -eq 0 ] || exit $?"; echo 1)'
+    eval "[ \"\${$1}\" ] && $1='' || $1=$?"
+    [ -s "$3" ] && read -r "$1" < "$3"
+  else
+    eval "$1"='$(eval "set -e; '"$2"'"; eval "[ $? -eq 0 ] || exit $?"; echo 1)'
+    eval "[ \"\${$1}\" ] && $1='' || $1=$?"
+  fi
+  set -e
+}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/reporter/color_schema.sh new/lib/libexec/reporter/color_schema.sh
--- old/lib/libexec/reporter/color_schema.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/reporter/color_schema.sh	2025-12-23 15:20:28.000000000 +0100
@@ -46,6 +46,7 @@
         todo     ) field_color=${BOLD}${YELLOW} ;;
         fixed    ) field_color=${BOLD}${GREEN} ;;
         skipped  ) field_color=${BOLD}${MAGENTA} ;;
+        error    ) field_color=${BOLD}${RED} ;;
       esac ;;
     error        )
       # shellcheck disable=SC2034
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/reporter/documentation_formatter.sh new/lib/libexec/reporter/documentation_formatter.sh
--- old/lib/libexec/reporter/documentation_formatter.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/reporter/documentation_formatter.sh	2025-12-23 15:20:28.000000000 +0100
@@ -7,6 +7,7 @@
 require_formatters methods conclusion finished summary references profiler
 [ "$SHELLSPEC_KCOV" ] && require_formatters kcov
 
+# shellcheck disable=SC2295
 documentation_each() {
   _id='' _current_id='' _description='' _indent=''
   _last_id=$documentation_last_id
@@ -35,7 +36,11 @@
       fi
 
       set -- "${_indent}${field_color}${_description}"
-      [ "$example_index" ] && set -- "$@" "($field_note - $example_index)"
+      case "${field_note:+x}:${example_index:+x}" in
+        x:x) set -- "$@" "($field_note - $example_index)" ;;
+        x:) set -- "$@" "($field_note)" ;;
+        :x) set -- "$@" "($example_index)" ;;
+      esac
       documentation '+=' "${*:-}${RESET}${LF}"
   esac
 
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/reporter/finished_formatter.sh new/lib/libexec/reporter/finished_formatter.sh
--- old/lib/libexec/reporter/finished_formatter.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/reporter/finished_formatter.sh	2025-12-23 15:20:28.000000000 +0100
@@ -4,7 +4,9 @@
 
 finished_end() {
   finished '=' "Finished in ${time_real:-?} seconds" \
-    "(user ${time_user:-?} seconds, sys ${time_sys:-?} seconds)${LF}"
+    "(user: ${time_user:-n/a}${time_user:+s}," \
+    "sys: ${time_sys:-n/a}${time_sys:+s})" \
+    "[time: ${time_type:-not-available}]${LF}"
 }
 
 finished_output() {
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/reporter/formatter.sh new/lib/libexec/reporter/formatter.sh
--- old/lib/libexec/reporter/formatter.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/reporter/formatter.sh	2025-12-23 15:20:28.000000000 +0100
@@ -15,7 +15,7 @@
   import_formatter "$1"
 
   # move main formatter to first
-  #shellcheck disable=SC2086
+  #shellcheck disable=SC2086,SC2295
   set -- "$1" ${formatters%$1*} ${formatters#*$1}
   formatters="$*"
 }
@@ -44,14 +44,14 @@
   eval "
     ${1}_output='results.${1}'
     ${1}_prepare() {
-      : > \"\$SHELLSPEC_TMPBASE/\$${1}_output\"
+      : >| \"\$SHELLSPEC_TMPBASE/\$${1}_output\"
     }
     ${1}_generate() {
       \"${1}_output\" \"\$@\" >> \"\$SHELLSPEC_TMPBASE/\$${1}_output\"
     }
     ${1}_cleanup() {
       remove_escape_sequence < \"\$SHELLSPEC_TMPBASE/\$${1}_output\" \
-        > \"\$SHELLSPEC_REPORTDIR/\$${1}_output\"
+        >| \"\$SHELLSPEC_REPORTDIR/\$${1}_output\"
     }
   "
   import_formatter "$1"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/reporter/junit_formatter.sh new/lib/libexec/reporter/junit_formatter.sh
--- old/lib/libexec/reporter/junit_formatter.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/reporter/junit_formatter.sh	2025-12-23 15:20:28.000000000 +0100
@@ -13,6 +13,7 @@
   xmlattrs _attrs "name=$SHELLSPEC_PROJECT_NAME"
   junit '=' '<?xml version="1.0" encoding="UTF-8"?>'
   junit '+=' "${LF}<testsuites $_attrs>${LF}"
+  : <> "$SHELLSPEC_TMPBASE/${junit_output}.work"
   junit '>>>' >> "$SHELLSPEC_TMPBASE/${junit_output}.work"
 }
 
@@ -82,7 +83,7 @@
       inc _errors _errors_total
       _message="${field_note}${field_note:+: }${field_message}"
       _failure=$field_failure_message _address="$field_specfile:$field_lineno"
-      wrap _failure "${_failure%${LF}}${LF}" "  "
+      wrap _failure "${_failure%"$LF"}${LF}" "  "
       _system_error="${_system_error}${_message}${LF}${_failure}"
       _system_error="${_system_error}# ${_address}${LF}${LF}"
       ;;
@@ -107,13 +108,13 @@
     while IFS= read -r _line; do
       case $_line in
         *\<testsuites\ *)
-          _before=${_line%%<testsuites\ *} _after=${_line#*<testsuites\ }
+          _before=${_line%%\<testsuites\ *} _after=${_line#*\<testsuites\ }
           xmlattrs _attrs "tests=$junit_tests_total" "time=$time_real" \
             "errors=$junit_errors_total" "failures=$junit_failures_total"
           putsn "$_before<testsuites $_attrs $_after"
           ;;
         *\<testsuite\ *)
-          _before=${_line%%<testsuite\ *} _after=${_line#*<testsuite\ }
+          _before=${_line%%\<testsuite\ *} _after=${_line#*\<testsuite\ }
           eval "xmlattrs _attrs id=$_id tests=\$junit_tests_${_id} \
             errors=\$junit_errors_${_id} failures=\$junit_failures_${_id} \
             skipped=\$junit_skipped_${_id}"
@@ -121,7 +122,7 @@
           inc _id
           ;;
         *\<testcase\ *)
-          _before=${_line%%<testcase\ *} _after=${_line#*<testcase\ }
+          _before=${_line%%\<testcase\ *} _after=${_line#*\<testcase\ }
           _time=0
           [ "$SHELLSPEC_PROFILER" ] && eval "_time=\$profiler_time$_cid"
           xmlattrs _attrs "time=$_time"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/reporter/profiler_formatter.sh new/lib/libexec/reporter/profiler_formatter.sh
--- old/lib/libexec/reporter/profiler_formatter.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/reporter/profiler_formatter.sh	2025-12-23 15:20:28.000000000 +0100
@@ -15,7 +15,7 @@
   # shellcheck disable=SC2031
   read_profiler callback "$profiler_tick_total" "$time_real" \
     < "$SHELLSPEC_PROFILER_LOG" \
-    > "$SHELLSPEC_PROFILER_REPORT"
+    >| "$SHELLSPEC_PROFILER_REPORT"
 }
 
 profiler_output() {
@@ -52,5 +52,5 @@
 
 profiler_reverse_sort() {
   # Retry if sort is Windows version
-  ( export LC_ALL=C; sort -k 1 -n -r 2>/dev/null || command -p sort -k 1 -n -r )
+  ( export LC_ALL=C; sort -nr 2>/dev/null || command -p sort -nr )
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/reporter/progress_formatter.sh new/lib/libexec/reporter/progress_formatter.sh
--- old/lib/libexec/reporter/progress_formatter.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/reporter/progress_formatter.sh	2025-12-23 15:20:28.000000000 +0100
@@ -13,6 +13,7 @@
       warned   ) _mark="W" ;;
       skipped  ) [ "$field_temporary" ] && _mark="S" || _mark="s" ;;
       failed   ) _mark="F" ;;
+      error    ) _mark="E" ;;
       todo     ) [ "$field_temporary" ] && _mark="P" || _mark="p" ;;
       fixed    ) [ "$field_temporary" ] && _mark="=" || _mark="-" ;;
     esac
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/reporter.sh new/lib/libexec/reporter.sh
--- old/lib/libexec/reporter.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/reporter.sh	2025-12-23 15:20:28.000000000 +0100
@@ -2,8 +2,8 @@
 
 # shellcheck source=lib/libexec.sh
 . "${SHELLSPEC_LIB:-./lib}/libexec.sh"
-use import constants sequence replace_all each padding trim wrap
-use is_empty_file pluralize exists_file readfile
+use import constants sequence replace_all replace_all_multiline each
+use padding trim wrap is_empty_file pluralize exists_file readfile
 
 notice() { warn "$@" 2>&1; }
 
@@ -15,17 +15,18 @@
 }
 
 # $1: prefix, $2: filename
+# shellcheck disable=SC2295
 read_time_log() {
-  eval "$1_real='' $1_user='' $1_sys=''"
-  [ -r "$2" ] || return 1
-  # shellcheck disable=SC2034
-  while IFS= read -r line; do
-    case $line in (real[\ $TAB]*|user[\ $TAB]*|sys[\ $TAB]*)
-      case ${line##*[ $TAB]} in (*[!0-9.]*) continue; esac
-      eval "$1_${line%%[ $TAB]*}=\"\${line##*[ \$TAB]}\""
-    esac
-  done < "$2" &&:
-  eval "[ \"\$$1_real\" ] && [ \"\$$1_user\" ] && [ \"\$$1_sys\" ]"
+  eval "$1_real='' $1_user='' $1_sys='' $1_type=''"
+  [ -s "$2" ] || return 1
+  {
+    set -- "$1_real" "$1_user" "$1_sys" "$1_type"
+    IFS=" " read -r "$@" || return 1
+    while [ $# -gt 0 ]; do
+      eval "$1=\${$1#${1#*_}:}"
+      shift
+    done
+  } < "$2"
 }
 
 field_description() {
@@ -84,11 +85,12 @@
 xmlcdata() {
   eval "$1=\$2"
   if [ "$2" ]; then
-    replace_all "$1" ']]>' ']]]]><![CDATA[>'
+    replace_all_multiline "$1" ']]>' ']]]]><![CDATA[>'
     eval "$1=\"<![CDATA[\${$1}]]>\""
   fi
 }
 
+# shellcheck disable=SC2295
 remove_escape_sequence() {
   while IFS= read -r line || [ "$line" ]; do
     text=''
@@ -196,23 +198,26 @@
   tssv_buf=''
   while IFS= read -r tssv_line || [ "$tssv_line" ]; do
     case $tssv_line in
-      $RS*)
+      $RS*) tssv_buf=${tssv_line#?} ;;
+      *)
         if [ "$tssv_buf" ]; then
-          tssv_fields "$@" "$tssv_buf" || return $?
+          tssv_buf="${tssv_buf}${LF}${tssv_line}"
+        else
+          putsn "$tssv_line"
         fi
-        tssv_buf=${tssv_line#?}
-        ;;
-      *) tssv_buf="$tssv_buf${tssv_buf:+$LF}${tssv_line}"
+    esac
+    case $tssv_line in (*$ETB)
+      tssv_fields "$@" "${tssv_buf%?}" || return $?
+      tssv_buf=''
     esac
   done
-  [ ! "$tssv_buf" ] || tssv_fields "$@" "$tssv_buf"
 }
 
 tssv_fields() {
   tssv_prefix=$1 tssv_callback=$2
   tssv_oldifs=$IFS && IFS=$3 && eval "set -- \$4" && IFS=$tssv_oldifs
 
-  for tssv_field; do
+  for tssv_field in "$@"; do
     eval "${tssv_prefix}_${tssv_field%%:*}=\${tssv_field#*:}"
     set -- "$@" "${tssv_field%%:*}"
     shift
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/shellspec.sh new/lib/libexec/shellspec.sh
--- old/lib/libexec/shellspec.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/shellspec.sh	2025-12-23 15:20:28.000000000 +0100
@@ -115,15 +115,21 @@
   cmdline=$(read_cmdline "/proc/$2/cmdline")
   [ "$cmdline" ] || cmdline=$(read_ps "$2")
 
-  echo "${cmdline%% $self*}"
+  # shellcheck disable=SC2295
+  cmdline=${cmdline%% $self*}
+  # workaround for OpenBSD >= 7.2 (ps -f)
+  case $cmdline in ([\`\|]--\ * | -\ *) cmdline=${cmdline##*\ }; esac
+  echo "$cmdline"
 }
 
+# shellcheck disable=SC2295
 command_path() {
-  if [ $# -lt 2 ]; then
-    set -- "" "$1" "${PATH}${SHELLSPEC_PATHSEP}"
-  else
-    set -- "$1" "$2" "${PATH}${SHELLSPEC_PATHSEP}"
-  fi
+  case $# in
+    0 | 1) set -- "" "$1" ;;
+    *) set -- "$1" "$2" ;;
+  esac
+  set -- "$1" "$2" "$PATH" "$SHELLSPEC_POSIX_PATH" "$SHELLSPEC_PATHSEP"
+  set -- "$1" "$2" "${3}${4:+"$5"}${4}${5}"
 
   case $2 in (*/*)
     [ -x "$2" ] || return 1
@@ -148,7 +154,7 @@
     SHELLSPEC_LOAD_PATH="${1}${SHELLSPEC_PATHSEP}${SHELLSPEC_LOAD_PATH}"
     shift
   done
-  SHELLSPEC_LOAD_PATH=${SHELLSPEC_LOAD_PATH%$SHELLSPEC_PATHSEP}
+  SHELLSPEC_LOAD_PATH=${SHELLSPEC_LOAD_PATH%"$SHELLSPEC_PATHSEP"}
 }
 
 finddirs() {
@@ -177,8 +183,9 @@
       cd "$pwd" || exit
       set -- *
       cd "$oldpwd" || exit
-      for i; do set -- "$@" "$pwd/$i"; shift; done
-      for i; do
+      [ $# -gt 0 ] || return 0
+      for i in "$@"; do set -- "$@" "$pwd/$i"; shift; done
+      for i in "$@"; do
         check "$i" && continue
         i=${i#"$PWD"}
         echo "$i"
@@ -279,32 +286,34 @@
 
 expand_pathstar_create_matcher() {
   echo "expand_pathstar_matcher() {"
-  for arg; do
-    pattern='' doublestar=''
-    while :; do
-      if starts_with "$arg" '**/'; then
-        arg=${arg#*/} doublestar=1
-      elif starts_with "$arg" '*/'; then
-        arg=${arg#*/} pattern="${pattern}*/"
+  if [ $# -gt 0 ]; then
+    for arg in "$@"; do
+      pattern='' doublestar=''
+      while :; do
+        if starts_with "$arg" '**/'; then
+          arg=${arg#*/} doublestar=1
+        elif starts_with "$arg" '*/'; then
+          arg=${arg#*/} pattern="${pattern}*/"
+        else
+          break
+        fi
+      done
+
+      escape_quote arg "$arg"
+      if [ "$doublestar" ]; then
+        echo "  case \$1 in (${pattern}*)"
+        echo "    [ \"\${1##*/}\" = '$arg' ] && return 0"
+        echo "  esac"
+      elif [ "$pattern" ]; then
+        echo "  case \$1 in (${pattern}*)"
+        echo "    [ \"\${1#$pattern}\" = '$arg' ] && return 0"
+        echo "  esac"
       else
-        break
+        echo "  [ \"\$1\" = '$arg' ] && return 0"
       fi
+      echo ""
     done
-
-    escape_quote arg "$arg"
-    if [ "$doublestar" ]; then
-      echo "  case \$1 in (${pattern}*)"
-      echo "    [ \"\${1##*/}\" = '$arg' ] && return 0"
-      echo "  esac"
-    elif [ "$pattern" ]; then
-      echo "  case \$1 in (${pattern}*)"
-      echo "    [ \"\${1#$pattern}\" = '$arg' ] && return 0"
-      echo "  esac"
-    else
-      echo "  [ \"\$1\" = '$arg' ] && return 0"
-    fi
-    echo ""
-  done
+  fi
   echo "  return 1"
   echo "}"
 }
@@ -314,25 +323,29 @@
     sep=$1 dir=${2%"${2##*[!/]}"}
     [ "$dir" = "." ] && dir="" || dir="$dir/"
     shift 2
-    for i; do
-      pattern=$i
-      if starts_with "$i" "*/" || starts_with "$i" "**/"; then
-        while i=${i#*/}; do
-          starts_with "$i" "*/" && continue
-          starts_with "$i" "**/" && continue
-          break
-        done
-        set -- "$@" "${i}${sep}${pattern}"
-      else
-        echo "${i}${sep}"
-      fi
-      shift
-    done
+    if [ $# -gt 0 ]; then
+      for i in "$@"; do
+        pattern=$i
+        if starts_with "$i" "*/" || starts_with "$i" "**/"; then
+          while i=${i#*/}; do
+            starts_with "$i" "*/" && continue
+            starts_with "$i" "**/" && continue
+            break
+          done
+          set -- "$@" "${i}${sep}${pattern}"
+        else
+          echo "${i}${sep}"
+        fi
+        shift
+      done
+    fi
     while IFS= read -r line; do
       [ "$line" = "." ] && line="$dir" || line="${dir}${line#./}/"
-      for i; do
-        echo "${line}${i}"
-      done
+      if [ $# -gt 0 ]; then
+        for i in "$@"; do
+          echo "${line}${i}"
+        done
+      fi
     done
   ) | "$SHELLSPEC_SORT"
 }
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/timeout-parser.sh new/lib/libexec/timeout-parser.sh
--- old/lib/libexec/timeout-parser.sh	1970-01-01 01:00:00.000000000 +0100
+++ new/lib/libexec/timeout-parser.sh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,42 @@
+#!/bin/sh
+#shellcheck disable=SC2004
+
+# Parse timeout format: 30, 30s, 1m, 1m30s  seconds
+# Returns timeout in seconds
+shellspec_parse_timeout() {
+  timeout_value="$1"
+  timeout_seconds=0
+
+  # Handle special cases
+  case $timeout_value in
+    0) echo 0; return 0 ;;
+    "") echo "${SHELLSPEC_TIMEOUT:-60}"; return 0 ;;
+  esac
+
+  # Parse minutes if present
+  case $timeout_value in
+    *[mM]*)
+      timeout_minutes="${timeout_value%%[mM]*}"
+      # Extract just the number before 'm'/'M'
+      timeout_minutes="${timeout_minutes##*[^0-9]}"
+      timeout_seconds=$((${timeout_minutes:-0} * 60))
+      # Remove everything up to and including the 'm'/'M'
+      timeout_value="${timeout_value#*[mM]}"
+      ;;
+  esac
+
+  # Parse seconds if present
+  case $timeout_value in
+    *[sS]*) timeout_value="${timeout_value%%[sS]*}" ;;
+  esac
+
+  # Extract remaining number
+  case $timeout_value in
+    *[0-9]*)
+      timeout_value="${timeout_value##*[^0-9]}"
+      timeout_seconds=$((timeout_seconds + ${timeout_value:-0}))
+      ;;
+  esac
+
+  echo "$timeout_seconds"
+}
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec/translator.sh new/lib/libexec/translator.sh
--- old/lib/libexec/translator.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec/translator.sh	2025-12-23 15:20:28.000000000 +0100
@@ -35,6 +35,7 @@
 
 check_filter() {
   check_filter="$1"
+  shellspec_timeout_override=""
   replace_all check_filter '$' "$DC1"
   replace_all check_filter '`' "$DC2"
   eval "set -- $check_filter"
@@ -46,6 +47,15 @@
     shift
   fi
   [ $# -gt 0 ] || return 1
+
+  # Extract timeout metadata
+  while [ $# -gt 0 ]; do
+    case $1 in
+      timeout:*) shellspec_timeout_override="${1#timeout:}" ;;
+    esac
+    shift
+  done
+
   check_tag_filter "$@"
 }
 
@@ -452,6 +462,13 @@
   fi
 }
 
+timeout_metadata() {
+  # Timeout metadata is extracted in check_filter()
+  # This function is called when %timeout directive is encountered
+  # but the actual handling is done during metadata parsing
+  :
+}
+
 include() {
   if [ "$inside_of_example" ]; then
     syntax_error "Include cannot be defined inside of Example"
@@ -505,10 +522,12 @@
 translate() {
   work=''
   while read_specfile line; do
-    while ends_with "$line" "\\"; do
-      read_specfile work ||:
-      line="${line}${LF}${work}"
-    done
+    if [ ! "$inside_of_text" ]; then
+      while ends_with "$line" "\\"; do
+        read_specfile work ||:
+        line="${line}${LF}${work}"
+      done
+    fi
     trim work "$line"
     dsl=${work%% *} rest=''
 
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/libexec.sh new/lib/libexec.sh
--- old/lib/libexec.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/libexec.sh	2025-12-23 15:20:28.000000000 +0100
@@ -1,6 +1,9 @@
 #shellcheck shell=sh disable=SC2004
 
-[ "${ZSH_VERSION:-}" ] && setopt shwordsplit
+if [ "${ZSH_VERSION:-}" ]; then
+  setopt shwordsplit
+  zmodload zsh/mapfile 2>/dev/null ||:
+fi
 
 # shellcheck source=lib/general.sh
 . "${SHELLSPEC_LIB:-./lib}/general.sh"
@@ -66,9 +69,9 @@
 }
 
 edit_in_place() {
-  if [ -e "$1" ]; then
-    eval 'shift; putsn "$("$@" < "'"$1"'")" > "'"$1"'"'
-  fi
+  [ -e "$1" ] || return 0
+  set -- "$1" "$(eval 'shift; "$@"' < "$1")"
+  putsn "$2" >| "$1"
 }
 
 info() {
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/semver.sh new/lib/semver.sh
--- old/lib/semver.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/semver.sh	2025-12-23 15:20:28.000000000 +0100
@@ -12,17 +12,18 @@
   return 0
 }
 
-# shellcheck disable=SC2181
 semver() {
   case $2 in
-    -lt) cmp_semver "$1" "$3" &&:; [ $? -eq 1 ] ;;
-    -le) cmp_semver "$1" "$3" &&:; [ $? -ne 2 ] ;;
-    -eq) cmp_semver "$1" "$3" &&:; [ $? -eq 0 ] ;;
-    -ne) cmp_semver "$1" "$3" &&:; [ $? -ne 0 ] ;;
-    -gt) cmp_semver "$1" "$3" &&:; [ $? -eq 2 ] ;;
-    -ge) cmp_semver "$1" "$3" &&:; [ $? -ne 1 ] ;;
+    -lt) set -- "$1" "$2" "$3" -eq 1 ;;
+    -le) set -- "$1" "$2" "$3" -ne 2 ;;
+    -eq) set -- "$1" "$2" "$3" -eq 0 ;;
+    -ne) set -- "$1" "$2" "$3" -ne 0 ;;
+    -gt) set -- "$1" "$2" "$3" -eq 2 ;;
+    -ge) set -- "$1" "$2" "$3" -ne 1 ;;
     *) echo "Unexpected operator: $2" >&2; exit 1 ;;
   esac
+  cmp_semver "$1" "$3" &&:
+  test $? "$4" "$5"
 }
 
 cmp_semver() {
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/lib/support-bin.sh new/lib/support-bin.sh
--- old/lib/support-bin.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/lib/support-bin.sh	2025-12-23 15:20:28.000000000 +0100
@@ -10,7 +10,7 @@
     # shellcheck disable=SC2086
     exec $SHELLSPEC_SHELL "$0" "$@"
   fi
-  # shellcheck disable=SC2039
+  # shellcheck disable=SC3044
   typeset +x PATH
   exec "$SHELLSPEC_ENV" PATH="$PATH" SHELLSPEC_PATH_IS_READONLY="" "$0" "$@"
 fi
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-executor.sh new/libexec/shellspec-executor.sh
--- old/libexec/shellspec-executor.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-executor.sh	2025-12-23 15:20:28.000000000 +0100
@@ -6,7 +6,7 @@
 # shellcheck source=lib/libexec/executor.sh
 . "${SHELLSPEC_LIB:-./lib}/libexec/executor.sh"
 
-if [ "$SHELLSPEC_KCOV" -gt 0 ]; then
+if [ "$SHELLSPEC_KCOV" ]; then
   # shellcheck source=lib/libexec/kcov-executor.sh
   . "${SHELLSPEC_LIB:-./lib}/libexec/kcov-executor.sh"
 elif [ "$SHELLSPEC_WORKERS" -gt 0 ]; then
@@ -25,6 +25,8 @@
 }
 
 error_handler() {
+  "$SHELLSPEC_TRAP" 'show_break_point' INT
+
   specfile='' lineno='' errors='' error_handler_status=0
 
   while IFS= read -r line; do
@@ -34,7 +36,7 @@
           detect_unexpected_error "$specfile" "$lineno" "$errors"
           errors=''
         fi
-        line=${line#${SYN}shellspec_marker:}
+        line=${line#"$SYN"shellspec_marker:}
         specfile=${line% *} lineno=${line##* }
         ;;
       Syntax\ error:*) putsn "${LF}${line}"; error_handler_status=1 ;;
@@ -42,8 +44,10 @@
       *internal\ error:\ j_async:\ bad\ nzombie*) ;;
       # Workaround for loksh <= 6.7.2 when executed as a background process
       *internal\ error:\ j_set_async:\ bad\ nzombie*) ;;
-      # Workaround for ksh with coverage
+      # Workaround for ksh with kcov
       *version*sh*AT\&T\ Research*) ;;
+      # Workaround for ksh 2020 with kcov
+      kcov:\ error:\ *is\ not\ an\ integer*) ;;
       *) errors="${errors}${line}${LF}" error_handler_status=1
     esac
   done
@@ -54,6 +58,10 @@
   return $error_handler_status
 }
 
+show_break_point() {
+  abort "${LF}Break at ${specfile:-}:${lineno:-}" 2>&4
+}
+
 detect_unexpected_error() {
   puts "$3"
 
@@ -95,11 +103,22 @@
   echo "${lineno_begin}-${lineno_end:-$lineno}"
 }
 
-( ( ( ( set +e; executor "$@" 2>&1 >&4; echo $? >&5 ) 2>&1 \
-  | error_handler >&3; echo $? >&5) 5>&1) \
-  | (
-      read -r xs1 && [ "$xs1" -ne 0 ] && exit "$xs1"
-      read -r xs2 && [ "$xs2" -ne 0 ] && exit "$xs2"
-      exit 0
-    )
-) 4>&1
+xs1=0 xs2=0
+set +e
+{
+  xs=$(
+    (
+      (
+        ( set -e; executor "$@" ) 2>&1 >&3 3>&- 4>&- 5>&-
+        echo "xs1=$?" >&5
+      ) | (
+        ( set -e; error_handler ) >&4 3>&- 4>&- 5>&-
+        echo "xs2=$?" >&5
+      )
+    ) 5>&1
+  )
+} 3>&1 4>&2
+eval "$xs"
+[ "$xs1" -ne 0 ] && exit "$xs1"
+[ "$xs2" -ne 0 ] && exit "$xs2"
+exit 0
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-gen-bin.sh new/libexec/shellspec-gen-bin.sh
--- old/libexec/shellspec-gen-bin.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-gen-bin.sh	2025-12-23 15:20:28.000000000 +0100
@@ -22,7 +22,8 @@
 
 mkdir -p "$SHELLSPEC_SUPPORT_BINDIR"
 
-for cmd; do
+[ $# -gt 0 ] || return 0
+for cmd in "$@"; do
   bin="$SHELLSPEC_SUPPORT_BINDIR/$cmd"
   if [ -e "$bin" ]; then
     warn "Skip, $cmd already exist (${SHELLSPEC_SUPPORT_BINDIR#"$PWD/"}/$cmd)"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-init.sh new/libexec/shellspec-init.sh
--- old/libexec/shellspec-init.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-init.sh	2025-12-23 15:20:28.000000000 +0100
@@ -13,7 +13,7 @@
       mkdir -p "${file%/*}"
     esac
     [ $# -eq 0 ] && set -- "$(cat)"
-    "$SHELLSPEC_PRINTF" '%s\n' "$@" > "$file"
+    "$SHELLSPEC_PRINTF" '%s\n' "$@" >| "$file"
     set -- create "$file"
   fi
   relpath=${2#"$SHELLSPEC_CWD"}
@@ -40,7 +40,7 @@
   fi
 }
 
-${__SOURCED__:+return}
+${__SOURCED__:+false} : || return 0
 
 __ main __
 
@@ -103,11 +103,13 @@
 End
 DATA
 
-for template; do
-  case $template in
-    spec) generate "$specfile" "$example" ;;
-    git ) generate ".gitignore" "$(ignore_file "/")" ;;
-    hg  ) generate ".hgignore" "$(ignore_file "^" "syntax: regexp")" ;;
-    svn ) generate ".svnignore" "$(ignore_file "/")" ;;
-  esac
-done
+if [ $# -gt 0 ]; then
+  for template in "$@"; do
+    case $template in
+      spec) generate "$specfile" "$example" ;;
+      git ) generate ".gitignore" "$(ignore_file "/")" ;;
+      hg  ) generate ".hgignore" "$(ignore_file "^" "syntax: regexp")" ;;
+      svn ) generate ".svnignore" "$(ignore_file "/")" ;;
+    esac
+  done
+fi
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-inspection.sh new/libexec/shellspec-inspection.sh
--- old/libexec/shellspec-inspection.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-inspection.sh	2025-12-23 15:20:28.000000000 +0100
@@ -1,6 +1,8 @@
 #!/bin/sh
 
-set -eu
+set -euf
+
+[ "${ZSH_VERSION:-}" ] && setopt shwordsplit
 
 # gosh: https://github.com/mvdan/sh v3.0.2 fails
 umask >/dev/null
@@ -47,6 +49,15 @@
   echo "SHELLSPEC_DEFECT_ZSHEXIT=1"
 fi
 
+set +e
+(set -e; false; :) 2>/dev/null
+# shellcheck disable=SC2181
+if [ $? -eq 0 ] && [ ! "${POSH_VERSION:-}" ]; then
+  # bosh <= 2020/03/25
+  echo "SHELLSPEC_DEFECT_BOSHEXIT=1"
+fi
+set -e
+
 # Workaround for posh 0.8.5
 if [ ! "$(kill -l 2 2>/dev/null)" = "INT" ]; then
   # Workaround for procps-ng kill
@@ -71,12 +82,15 @@
 set -e
 
 SHELLSPEC_CLONE_TYPE="posix"
-# shellcheck disable=SC2039
+# shellcheck disable=SC3044
 if typeset >/dev/null 2>&1; then
-  # shellcheck disable=SC2034
   set -- "$(var=data; typeset -p var 2>/dev/null ||:)" ||:
   if [ ! "${1#*data}" = "$1" ]; then
-    [ "${BASH_VERSION:-}" ] && SHELLSPEC_CLONE_TYPE=bash
+    if [ "${BASH_VERSION:-}" ]; then
+      SHELLSPEC_CLONE_TYPE=bash OLDIFS=$IFS
+      eval "$(typeset -p IFS)"
+      [ "$OLDIFS" = "$IFS" ] || SHELLSPEC_CLONE_TYPE=old_bash IFS=$OLDIFS
+    fi
     [ "${ZSH_VERSION:-}" ] && SHELLSPEC_CLONE_TYPE=zsh
     [ "${YASH_VERSION:-}" ] && SHELLSPEC_CLONE_TYPE=yash
     [ "${KSH_VERSION:-}" ] && SHELLSPEC_CLONE_TYPE=ksh
@@ -102,11 +116,26 @@
   echo "SHELLSPEC_SHEBANG_MULTIARG=1"
 fi
 
-# shellcheck disable=SC2039,SC3047
-if (trap '' DEBUG) 2>/dev/null; then
+set +e
+(
+  # shellcheck disable=SC3045
+  ulimit -t unlimited || exit 1
+
+  # shellcheck disable=SC3047
+  trap '' DEBUG || exit 1
   echo "SHELLSPEC_DEBUG_TRAP=1"
   echo "SHELLSPEC_KCOV_COMPATIBLE_SHELL=1"
-fi
+
+  # Workaround for ksh93u+ and ksh2020 (fixed in ksh93u+m)
+  # shellcheck disable=SC3047
+  trap ':' DEBUG
+  # shellcheck disable=SC2034
+  r=$(exit 123)
+  if [ $? -ne 123 ]; then
+    echo "SHELLSPEC_DEFECT_DEBUGXS=1"
+  fi
+) 2>/dev/null
+set -e
 
 case $PWD in ([a-zA-Z]:* | //*)
   echo "SHELLSPEC_BUSYBOX_W32=1"
@@ -120,39 +149,87 @@
   PATH="$1"
 }
 
-# shellcheck disable=SC2123
-set_path /
-if [ "$SHELLSPEC_SANDBOX" ] && ! $SHELLSPEC_SHELL -c ":" 2>/dev/null; then
-  # busybox ash on cygwin
-  echo "SHELLSPEC_DEFECT_SANDBOX=1"
+run_with_path() {
+  current_path=$PATH xs=0
+  set_path "$1"
+  shift
+  "$@" || xs=$?
+  PATH=$current_path
+  return $xs
+}
+
+run_builtin() {
+  run_with_path /dev/null "$@"
+}
+
+if [ "$SHELLSPEC_SANDBOX" ]; then
+  # shellcheck disable=SC2086
+  if ! run_with_path / $SHELLSPEC_SHELL -c ":" 2>/dev/null; then
+    # busybox ash on cygwin
+    echo "SHELLSPEC_DEFECT_SANDBOX=1"
+  fi
 fi
 
-set_path ""
-if printf '' 2>/dev/null; then
+if run_builtin printf '' 2>/dev/null; then
   echo "SHELLSPEC_BUILTIN_PRINTF=1"
 fi
-if print -nr -- '' 2>/dev/null; then
+if run_builtin print -nr -- '' 2>/dev/null; then
   echo "SHELLSPEC_BUILTIN_PRINT=1"
 fi
 
 typesetf_check() { :; }
-# shellcheck disable=SC2034,SC2039
-if typeset -f typesetf_check >/dev/null 2>&1; then
+# shellcheck disable=SC3044
+if run_builtin typeset -f typesetf_check >/dev/null 2>&1; then
   echo "SHELLSPEC_BUILTIN_TYPESETF=1"
 fi
 
-if type shopt >/dev/null 2>&1; then
+if run_builtin shopt >/dev/null 2>&1; then
   echo "SHELLSPEC_SHOPT_AVAILABLE=1"
-  # shellcheck disable=SC2039
+  # shellcheck disable=SC3044
   if shopt -s failglob 2>/dev/null; then
     echo "SHELLSPEC_FAILGLOB_AVAILABLE=1"
   fi
 fi
 
-if setopt NO_NOMATCH >/dev/null 2>&1; then
+if run_builtin setopt NO_NOMATCH >/dev/null 2>&1; then
   echo "SHELLSPEC_NOMATCH_AVAILABLE=1"
 fi
 
+# shellcheck disable=SC2034,SC3022
+if ( exec {fd}>/dev/null ) 2>/dev/null; then
+  echo "SHELLSPEC_FDVAR_AVAILABLE=1"
+fi
+
+# shellcheck disable=SC3044
+if run_builtin readarray </dev/null 2>/dev/null; then
+  echo "SHELLSPEC_BUILTIN_READARRAY=1"
+fi
+
+string=''
+# shellcheck disable=SC3024
+if string+="concat" 2>/dev/null; then
+  echo "SHELLSPEC_STRING_CONCAT=1"
+fi
+
+if ( eval '{ : <#((0)); } <<<:' ) 2>/dev/null; then
+  echo "SHELLSPEC_SEEKABLE=1"
+fi
+
+line=''
+# shellcheck disable=SC3045
+read -r -d "" line <<'HERE' 2>/dev/null ||:
+a\b
+HERE
+if [ "$line" = 'a\b' ]; then
+  echo "SHELLSPEC_READ_DELIM=1"
+fi
+
+if [ "${YASH_VERSION:-}" ]; then
+  if run_builtin array >/dev/null 2>&1; then
+    echo "SHELLSPEC_YASH_ARRAY=1"
+  fi
+fi
+
 #shellcheck disable=SC2034
 {
   if [ "$({ BASH_XTRACEFD=3; set -x; :; } 2>/dev/null 3>&1)" ]; then
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-list.sh new/libexec/shellspec-list.sh
--- old/libexec/shellspec-list.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-list.sh	2025-12-23 15:20:28.000000000 +0100
@@ -88,5 +88,5 @@
 [ "$SHELLSPEC_LIST" ] || echo "$specfiles ${examples:-0}"
 
 if [ "${SHELLSPEC_COUNT_FILE:-}" ]; then
-  echo "$specfiles${examples:+ }$examples" > "$SHELLSPEC_COUNT_FILE"
+  echo "$specfiles${examples:+ }$examples" >| "$SHELLSPEC_COUNT_FILE"
 fi
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-prechecker.sh new/libexec/shellspec-prechecker.sh
--- old/libexec/shellspec-prechecker.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-prechecker.sh	2025-12-23 15:20:28.000000000 +0100
@@ -1,9 +1,12 @@
 #!/bin/sh
 # shellcheck disable=SC1090,SC2016,SC2034,SC2064
 
+set -e
+
+# shellcheck source=lib/libexec/prechecker.sh
 . "${SHELLSPEC_LIB:-./lib}/libexec/prechecker.sh"
 
-warn_fd=2 status_file=""
+warn_fd=2 status_file="" xs=''
 while [ $# -gt 0 ]; do
   case ${1:-} in
     --warn-fd=*) warn_fd=${1#*\=} ;;
@@ -13,48 +16,47 @@
   shift
 done
 
-: > "$status_file"
-
-work="$status_file'" && status_file=''
-while [ "$work" ]; do
-  status_file="$status_file${work%%\'*}'\''"
-  work=${work#*\'}
-done
-status_file=${status_file%????}
+[ -s "$status_file" ] && : >| "$status_file"
 
-code='xs=${xs:-$?} mod=${1:-"<module>"};'
-code="${code}if [ \"\${loaded:-}\" ]; then"
-code="${code}  echo \"\$xs\" > '${status_file:-/dev/null}';"
-code="${code}else"
-code="${code}  \"\${SHELLSPEC_SLEEP:-sleep}\" 0;"
-code="${code}  echo \"Skip precheck because an error (\$xs) occurred when loading the module '\$mod'\";"
-code="${code}  echo \"Since ShellSpec 0.28.0, modules are loaded earlier, so it is no longer possible\";"
-code="${code}  echo \"to call shellspec's internal functions from the top level of the module.\";"
-code="${code}  echo \"If the module worked in an earlier ShellSpec version, move those codes to\";"
-code="${code}  echo \"the function \${mod}_loaded or \${mod}_configure (recommended).\";"
-code="${code}  echo \"The process will continue for compatibility, but will abort here in the future.\";"
-# TODO abort here in the future
-# code="${code}  echo \"\$xs\" > '${status_file:-/dev/null}';"
-code="${code}fi >&$warn_fd"
-trap "$code" EXIT
-unset code warn_fd status_file work
-
-{
-  while [ $# -gt 0 ] && [ "${xs:-0}" -eq 0 ]; do
-    set -- "${1##*/}" "$@"
-    set -- "${1%%.*}" "$@"
-    unset success xs loaded ||:
-    eval "$1_precheck() { :; }"
-    . "$3"
-    unset success xs loaded ||:
-    set +e
-    { success=$( set -eu; eval "$1_precheck" >&7; xs=$?; [ "$xs" -eq 0 ] || exit "$xs"; echo 1 ); } 7>&1
-    xs=$? loaded=1
-    unset -f "$1_precheck"
-    [ "$success" ] || break
-    [ "$xs" -eq 0 ] || break
-    shift 3
+if [ $# -gt 0 ]; then
+  for i in "$@"; do
+    i=${i##*/} && i=${i%%.*}
+    set -- "$@" "$i" "$1" "$status_file" "$warn_fd"
+    shift
   done
-  [ "$success" ] && trap - EXIT
-  exit "$xs"
+fi
+unset i status_file warn_fd
+
+shellspec_precheck_loading_error() {
+  "${SHELLSPEC_SLEEP:-sleep}" 0
+  echo "Skip precheck because an error ($2) occurred when loading the module '$1'"
+  echo "Since ShellSpec 0.28.0, modules are loaded earlier, so it is no longer possible"
+  echo "to call shellspec's internal functions from the top level of the module."
+  echo "If the module worked in an earlier ShellSpec version, move those codes to"
+  echo "the function ${1}_loaded or ${1}_configure (recommended)."
+  echo "The process will continue for compatibility, but will abort here in the future."
+  # TODO abort here in the future
+  # [ "$3" ] && echo "$2" >| "$3"
+  # exec $SHELLSPEC_SHELL -c "exit $2"
+  if [ "${ZSH_VERSION:-}" ]; then
+    eval "exec \${=SHELLSPEC_SHELL} -c 'exit 0'"
+  else
+    # shellcheck disable=SC2086
+    exec $SHELLSPEC_SHELL -c 'exit 0'
+  fi
 }
+
+until [ $# -eq 0 ] || [ "$xs" ]; do
+  unset xs
+  eval "$1_precheck() { :; }"
+  trap "shellspec_precheck_loading_error \"\$1\" \$? \"\$3\" >&$4" EXIT
+  set -e
+  . "$2"
+  trap - EXIT
+  { shellspec_precheck_run xs "$1_precheck >&7"; } 7>&1
+  unset -f "$1_precheck"
+  shift 4
+done
+
+[ "$xs" ] && [ "$3" ] && echo "$xs" >| "$3"
+exit "${xs:-0}"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-profiler.sh new/libexec/shellspec-profiler.sh
--- old/libexec/shellspec-profiler.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-profiler.sh	2025-12-23 15:20:28.000000000 +0100
@@ -3,16 +3,16 @@
 
 set -eu
 
-: > "$SHELLSPEC_PROFILER_LOG"
+: >| "$SHELLSPEC_PROFILER_LOG"
 
 index=0 counter=0
 
-: > "$SHELLSPEC_PROFILER_SIGNAL"
+: >| "$SHELLSPEC_PROFILER_SIGNAL"
 
 while [ -e "$SHELLSPEC_PROFILER_SIGNAL" ]; do
   if [ -s "$SHELLSPEC_PROFILER_SIGNAL" ]; then
     eval "counter${index}=$counter index=$(($index + 1))"
-    : > "$SHELLSPEC_PROFILER_SIGNAL"
+    : >| "$SHELLSPEC_PROFILER_SIGNAL"
   fi
   counter=$(($counter + 1))
 done
@@ -24,5 +24,5 @@
   echo "$(($end - $start))" >> "$SHELLSPEC_PROFILER_LOG"
   i=$(($i + 2))
 done
-echo "$counter" > "$SHELLSPEC_PROFILER_LOG.total"
-: > "$SHELLSPEC_TMPBASE/profiler.done"
+echo "$counter" >| "$SHELLSPEC_PROFILER_LOG.total"
+: >| "$SHELLSPEC_TMPBASE/profiler.done"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-reporter.sh new/libexec/shellspec-reporter.sh
--- old/libexec/shellspec-reporter.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-reporter.sh	2025-12-23 15:20:28.000000000 +0100
@@ -4,10 +4,10 @@
 set -euf
 
 interrupt=''
-"$SHELLSPEC_TRAP" 'interrupt=1' INT
+"$SHELLSPEC_TRAP" '[ "$interrupt" ] && exit 130; interrupt=1' INT
 "$SHELLSPEC_TRAP" '' TERM
 
-echo $$ > "$SHELLSPEC_REPORTER_PID"
+echo $$ >| "$SHELLSPEC_REPORTER_PID"
 
 # shellcheck source=lib/libexec/reporter.sh
 . "${SHELLSPEC_LIB:-./lib}/libexec/reporter.sh"
@@ -177,7 +177,7 @@
   if [ -s "$quick_file" ] && [ ! "$quick_file_data" ]; then
     notice "All examples have been passed. Rerun to prevent regression.$LF"
   fi
-  puts "$quick_file_data${quick_file_data:+"$LF"}" | sort > "$quick_file"
+  puts "$quick_file_data${quick_file_data:+"$LF"}" | sort >| "$quick_file"
 fi
 
 if [ -e "$SHELLSPEC_DEPRECATION_LOGFILE" ]; then
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-runner.sh new/libexec/shellspec-runner.sh
--- old/libexec/shellspec-runner.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-runner.sh	2025-12-23 15:20:28.000000000 +0100
@@ -1,7 +1,8 @@
 #!/bin/sh
-#shellcheck disable=SC2004
 
 set -eu
+# shellcheck disable=SC3044
+shopt -u verbose_errexit 2>/dev/null ||:
 
 # shellcheck source=lib/libexec/runner.sh
 . "${SHELLSPEC_LIB:-./lib}/libexec/runner.sh"
@@ -46,17 +47,18 @@
   [ $# -gt 0 ] || return 0
 
   status_file=$SHELLSPEC_PRECHECKER_STATUS
-  echo "-" > "$status_file"
-  for module; do
-    import_path=''
-    resolve_module_path import_path "$module"
-    if [ ! -r "$import_path" ]; then
-      echo "Unable to load the required module '$module': $import_path" >&2
-      exit 1
-    fi
-    set -- "$@" "$import_path"
-    shift
-  done
+  if [ $# -gt 0 ]; then
+    for module in "$@"; do
+      import_path=''
+      resolve_module_path import_path "$module"
+      if [ ! -r "$import_path" ]; then
+        echo "Unable to load the required module '$module': $import_path" >&2
+        exit 1
+      fi
+      set -- "$@" "$import_path"
+      shift
+    done
+  fi
   prechecker="$SHELLSPEC_LIBEXEC/shellspec-prechecker.sh"
   # shellcheck disable=SC2086
   $SHELLSPEC_SHELL "$prechecker" --warn-fd=3 --status-file="$status_file" "$@"
@@ -66,7 +68,7 @@
   start_profiler
   executor="$SHELLSPEC_LIBEXEC/shellspec-executor.sh"
   # shellcheck disable=SC2086
-  $SHELLSPEC_TIME $SHELLSPEC_SHELL "$executor" "$@" 3>&2 2>"$SHELLSPEC_TIME_LOG"
+  $SHELLSPEC_SHELL "$SHELLSPEC_TIME" $SHELLSPEC_SHELL "$executor" "$@"
   eval "stop_profiler; return $?"
 }
 
@@ -78,6 +80,7 @@
   error_count=0
 
   while IFS= read -r line; do
+    # shellcheck disable=SC2004
     error_count=$(($error_count + 1))
     error "$line"
   done
@@ -91,18 +94,22 @@
 
 check_formatters() {
   eval "set -- $1"
-  for module; do
-    module_exists "${module}_formatter" && continue
-    abort "The specified formatter '$module' is not found."
-  done
+  if [ $# -gt 0 ]; then
+    for module in "$@"; do
+      module_exists "${module}_formatter" && continue
+      abort "The specified formatter '$module' is not found."
+    done
+  fi
 }
 check_formatters "$SHELLSPEC_FORMATTER $SHELLSPEC_GENERATORS"
 
-for p; do
-  [ -f "$p" ] || continue
-  is_specfile "$p" && continue
-  abort "File '$p' cannot be executed because it does not match the pattern '$SHELLSPEC_PATTERN'."
-done
+if [ $# -gt 0 ]; then
+  for p in "$@"; do
+    [ -f "$p" ] || continue
+    is_specfile "$p" && continue
+    abort "File '$p' cannot be executed because it does not match the pattern '$SHELLSPEC_PATTERN'."
+  done
+fi
 
 if [ "$SHELLSPEC_REPAIR" ]; then
   if [ -e "$SHELLSPEC_QUICK_FILE" ]; then
@@ -115,7 +122,7 @@
 
 if [ "$SHELLSPEC_QUICK" ]; then
   if ! [ -e "$SHELLSPEC_QUICK_FILE" ]; then
-    if ( : > "$SHELLSPEC_QUICK_FILE" ) 2>/dev/null; then
+    if ( : >| "$SHELLSPEC_QUICK_FILE" ) 2>/dev/null; then
       warn "Quick Mode is automatically enabled." \
         "If you want disable it, delete '$SHELLSPEC_QUICK_FILE'."
     else
@@ -162,7 +169,7 @@
 fi
 
 noexec_check="$SHELLSPEC_TMPBASE/.shellspec-check-executable"
-echo '#!/bin/sh' > "$noexec_check"
+echo '#!/bin/sh' >| "$noexec_check"
 "$SHELLSPEC_CHMOD" +x "$noexec_check"
 if ! "$noexec_check" 2>/dev/null; then
   export SHELLSPEC_NOEXEC_TMPDIR=1
@@ -179,54 +186,69 @@
 fi
 
 if [ "${SHELLSPEC_RANDOM:-}" ]; then
-  export SHELLSPEC_LIST=$SHELLSPEC_RANDOM
+  export SHELLSPEC_LIST="$SHELLSPEC_RANDOM"
   exec="$SHELLSPEC_LIBEXEC/shellspec-list.sh"
-  eval "$SHELLSPEC_SHELL" "\"$exec\"" ${1+'"$@"'} >"$SHELLSPEC_INFILE"
+  eval "$SHELLSPEC_SHELL" "\"$exec\"" ${1+'"$@"'} >|"$SHELLSPEC_INFILE"
   set -- -
 fi
 
+xs=0
 {
-  env=$( ( ( ( (
-    ( ( precheck "$SHELLSPEC_REQUIRES" ) &&:; echo "exit_status=$?" >&9; ) >&8
+  # precheck outputs code such as environment variable settings via FD9
+  env=$( ( ( ( ( set -- "$SHELLSPEC_REQUIRES"
+    set +e; (set -e; precheck "$@") >&8 8>&-; echo "xs=$?" >&9
     ) 2>&1 | while IFS= read -r line; do error "$line"; done >&2
     ) 3>&1 | while IFS= read -r line; do warn "$line"; done >&2
     ) 4>&1 | while IFS= read -r line; do info "$line"; done >&8
   ) 9>&1 )
   eval "$env"
 } 8>&1
-[ -s "$SHELLSPEC_PRECHECKER_STATUS" ] && exit "$exit_status"
+if [ "$xs" -ne 0 ] || [ -s "$SHELLSPEC_PRECHECKER_STATUS" ]; then
+  exit "$xs"
+fi
 
-# I want to process with non-blocking output
-# and the stdout of runner streams to the reporter
-# and capture stderr both of the runner and the reporter
-# and the stderr streams to error hander
-# and also handle both exit status. As a result of
-( ( ( ( set -e; { executor "$@"; } 9>&1 >&8; echo $? >&5 ) \
-  | reporter "$@" >&3; echo $? >&5 ) 2>&1 \
-  | error_handler >&4; echo $? >&5 ) 5>&1 \
-  | (
-      read -r xs1; read -r xs2; read -r xs3
-      xs='' error='' msg="Aborted with status code"
-      for i in "$xs1" "$xs2" "$xs3"; do
-        case $i in
-          0) continue ;;
-          "$SHELLSPEC_FAILURE_EXIT_CODE") [ "$xs" ] || xs=$i ;;
-          "$SHELLSPEC_ERROR_EXIT_CODE") xs=$i error=1 && break ;;
-          *) [ "${xs#$SHELLSPEC_FAILURE_EXIT_CODE}" ] || xs=$i; error=1
-        esac
-      done
-      if [ "$error" ]; then
-        error "$msg [executor: $xs1] [reporter: $xs2] [error handler: $xs3]"
-      fi
-      set_exit_status "${xs:-0}"
-    )
-) 3>&1 4>&2 8>&1 &&:
-exit_status=$?
+xs1='' xs2='' xs3=''
+set +e
+{
+  xs=$(
+    (
+      (
+        (
+          ( set -e; executor "$@" ) 3>&- 4>&- 5>&-
+	  echo "xs1=$?" >&5
+        ) | (
+          ( set -e; reporter "$@" ) >&3 3>&- 4>&- 5>&-
+          echo "xs2=$?" >&5
+        )
+      ) 2>&1 | (
+        ( set -e; error_handler ) >&4 3>&- 4>&- 5>&-
+        echo "xs3=$?" >&5
+      )
+    ) 5>&1
+  )
+} 3>&1 4>&2
+
+eval "$xs"
+xs='' error=''
+for i in "$xs1" "$xs2" "$xs3"; do
+  case $i in
+    0) continue ;;
+    "$SHELLSPEC_FAILURE_EXIT_CODE") [ "$xs" ] || xs=$i ;;
+    "$SHELLSPEC_ERROR_EXIT_CODE") xs=$i error=1 && break ;;
+    *) [ "${xs#"$SHELLSPEC_FAILURE_EXIT_CODE"}" ] || xs=$i; error=1
+  esac
+done
+xs=${xs:-0}
+
+if [ "$error" ]; then
+  msg="Aborted with status code"
+  error "$msg [executor: $xs1] [reporter: $xs2] [error handler: $xs3]"
+fi
 
-case $exit_status in
+case $xs in
   0) ;; # Running specs exit with successfully.
   "$SHELLSPEC_FAILURE_EXIT_CODE") ;; # Running specs exit with failure.
-  *) error "Fatal error occurred, terminated with exit status $exit_status."
+  *) error "Fatal error occurred, terminated with exit status $xs."
 esac
 
-exit "$exit_status"
+exit "$xs"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-timeout-watchdog.sh new/libexec/shellspec-timeout-watchdog.sh
--- old/libexec/shellspec-timeout-watchdog.sh	1970-01-01 01:00:00.000000000 +0100
+++ new/libexec/shellspec-timeout-watchdog.sh	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1,63 @@
+#!/bin/sh
+#shellcheck disable=SC2016,SC2004
+
+set -eu
+
+# Restore original PATH to access system utilities like sleep, rm
+# SHELLSPEC_PATH contains the original PATH before shellspec modified it
+if [ "${SHELLSPEC_PATH:-}" ]; then
+  PATH="$SHELLSPEC_PATH"
+  export PATH
+fi
+
+# Timeout watchdog process
+# Arguments:
+#   $1 = timeout_seconds
+#   $2 = test_pid
+#   $3 = signal_file
+#   $4 = result_file
+
+timeout_seconds="$1"
+test_pid="$2"
+signal_file="$3"
+result_file="$4"
+
+# Start sleep for the timeout duration in background
+sleep "$timeout_seconds" &
+sleep_pid=$!
+
+# Wait for either timeout or early termination signal
+while kill -0 "$sleep_pid" 2>/dev/null; do
+  # Check if test process is still running
+  if ! kill -0 "$test_pid" 2>/dev/null; then
+    # Test completed before timeout
+    kill "$sleep_pid" 2>/dev/null || :
+    exit 0
+  fi
+
+  # Check for early termination signal (signal file removed)
+  if [ ! -e "$signal_file" ]; then
+    # Test completed, signal received
+    kill "$sleep_pid" 2>/dev/null || :
+    exit 0
+  fi
+
+  # Short nap to avoid busy-waiting
+  # Try fractional sleep first, fall back to 1s
+  sleep 0.1 2>/dev/null || sleep 1
+done
+
+# Timeout occurred - kill the test process
+if kill -0 "$test_pid" 2>/dev/null; then
+  # Write timeout marker to result file
+  echo "TIMEOUT" > "$result_file"
+
+  # Kill test process tree
+  # First try graceful TERM, then forceful KILL
+  kill -TERM "$test_pid" 2>/dev/null || :
+  sleep 1
+  kill -KILL "$test_pid" 2>/dev/null || :
+fi
+
+# Cleanup signal file
+rm -f "$signal_file" || :
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-time.sh new/libexec/shellspec-time.sh
--- old/libexec/shellspec-time.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-time.sh	2025-12-23 15:20:28.000000000 +0100
@@ -1,46 +1,184 @@
 #!/bin/sh
-#shellcheck disable=SC2004
+# shellcheck disable=SC2004
 
-"$SHELLSPEC_TRAP" : INT
-
-if [ "$BASH_VERSION" ] || [ "$KSH_VERSION" ]; then
-  time -p "$@"
-  exit $?
+if [ -z "$PPID" ]; then
+  echo 'Bourne Shell is not supported.' \
+    'Run in a specific POSIX shell as follows.' >&2
+  echo '$ ksh shellspec-time sleep 1' >&2
+  exit 1
 fi
 
-set -eu
-
-read -r sec_start millisec_start <<HERE
-$(date +"%s %2N")
-HERE
+set -f
 
-case $millisec_start in (*[!0-9]*)
-  millisec_start=0
-esac
+: "${SHELLSPEC_TRAP:=trap}"
+: "${SHELLSPEC_TIME_TYPE:=auto}"
+LF='
+'
 
-status=0
-
-if [ $# -gt 0 ]; then
-  "$@" &&:
-  status=$?
-fi
-
-read -r sec_end millisec_end <<HERE
-$(date +"%s %2N")
-HERE
-
-case $millisec_end in (*[!0-9]*)
-  millisec_end=0
-esac
-
-sec=$(($sec_end - $sec_start))
-millisec=$((1$millisec_end - 1$millisec_start))
-if [ $millisec -lt 0 ]; then
-  millisec=$(($millisec + 100))
-  sec=$(($sec - 1))
-fi
-[ $millisec -lt 10 ] && millisec="0$millisec"
-
-echo "real $sec.$millisec" >&2
+"$SHELLSPEC_TRAP" : INT
 
-exit $status
+datetime2unixtime() {
+  set -- "$1" "${2%%-*}" "${2%%T*}" "${2##*T}"
+  set -- "$1" "${2#"${2%%[!0]*}"}" "${3#*-}" "${4%%:*}" "${4#*:}"
+  set -- "$1" "$2" "${3%%-*}" "${3#*-}" "$4" "${5%%:*}" "${5#*:}"
+  set -- "$1" "${2:-0}" "${3#0}" "${4#0}" "${5#0}" "${6#0}" "${7#0}"
+  [ "$3" -lt 3 ] && set -- "$1" $(($2-1)) $(($3+12)) "$4" "$5" "$6" "$7"
+  set -- "$1" $((365*$2+$2/4-$2/100+$2/400)) "$3" "$4" "$5" "$6" "$7"
+  set -- "$1" "$2" $(((306*($3+1)/10)-428)) "$4" "$5" "$6" "${7%.*}" "${7#*.}"
+  eval "$1=$((($2+$3+$4-719163)*86400+$5*3600+$6*60+$7))${8:+.}${8}"
+}
+
+time_using_date() {
+  date +'start %Y-%m-%dT%H:%M:%S.%N'
+  "$@"
+  set -- $?
+  date +'end %Y-%m-%dT%H:%M:%S.%N'
+  return "$1"
+}
+
+detect_time_type() {
+  [ "$SHELLSPEC_TIME_TYPE" = auto ] || return 0
+
+  if ! { time true; } >/dev/null 2>&1; then
+    SHELLSPEC_TIME_TYPE=external-date && return 0
+  fi
+
+  if [ ! "${KSH_VERSION:-}" ]; then
+    KSH_VERSION=$(eval 'echo ${.sh.version}')
+  fi 2>/dev/null
+
+  if [ "${BASH_VERSION:-}" ]; then
+    SHELLSPEC_TIME_TYPE=bash-builtin && return 0
+  fi
+
+  if [ "${KSH_VERSION:-}" ]; then
+    case $KSH_VERSION in
+      *PD\ KSH*) SHELLSPEC_TIME_TYPE=pdksh-builtin ;;
+      *MIRBSD\ KSH*) SHELLSPEC_TIME_TYPE=mksh-builtin ;;
+      *LEGACY\ KSH*) SHELLSPEC_TIME_TYPE=lksh-builtin ;;
+      *) SHELLSPEC_TIME_TYPE=ksh93-builtin ;;
+    esac
+    return 0
+  fi
+
+  if [ "${ZSH_VERSION:-}" ]; then
+    SHELLSPEC_TIME_TYPE=zsh-builtin && return 0
+  fi
+
+  if { time -p true; } >/dev/null 2>&1; then
+    SHELLSPEC_TIME_TYPE=external-time
+  else
+    SHELLSPEC_TIME_TYPE=legacy-time
+  fi
+}
+
+detect_time_type
+
+{
+  (
+    "$SHELLSPEC_TRAP" : INT
+
+    set -- -- "$@"
+
+    case ${LC_ALL+x} in
+      ?) set -- -s LC_ALL "$LC_ALL" "$@" ;;
+      *) set -- -u LC_ALL "$@" ;;
+    esac
+    export LC_ALL=C
+
+    # bash or ksh93
+    case ${TIMEFORMAT+x} in
+      ?) set -- -s TIMEFORMAT "$TIMEFORMAT" "$@" ;;
+      *) set -- -u TIMEFORMAT "$@" ;;
+    esac
+    TIMEFORMAT="real %R${LF}user %U${LF}sys %S"
+
+    # zsh
+    case ${TIMEFMT+x} in
+      ?) set -- -s TIMEFMT "$TIMEFMT" "$@" ;;
+      *) set -- -u TIMEFMT "$@" ;;
+    esac
+    TIMEFMT="real %*E${LF}user %*U${LF}sys %*S"
+
+    # GNU time
+    case ${TIME+x} in
+      ?) set -- -s TIME "$TIME" "$@" ;;
+      *) set -- -u TIME "$@" ;;
+    esac
+    export TIME="real %e${LF}user %U${LF}sys %S"
+
+    # shellcheck disable=SC2016
+    set -- sh -c '
+      # Use Bourne shell syntax as sh may be a Bourne shell
+      while [ $# -gt 0 ]; do
+        case $1 in
+          -s) eval "$2=\"\$3\""; export "$2"; shift 2 ;;
+          -u) unset "$2"; shift ;;
+          --) shift; break ;;
+           *) break ;;
+        esac
+        shift
+      done
+      exec "$@" 2>&3 >&4 3>&- 4>&-
+    ' "$0" "$@"
+
+    case $SHELLSPEC_TIME_TYPE in
+      external-date)
+	time_using_date "$@"
+        ;;
+      external-bash)
+        bash -c 'TIMEFORMAT=$1; shift; time "$@"' "$0" "$TIMEFORMAT" "$@"
+        ;;
+      external-ksh)
+        ksh -c 'TIMEFORMAT=$1; shift; time "$@"' "$0" "$TIMEFORMAT" "$@"
+        ;;
+      external-zsh)
+        zsh -c 'TIMEFMT=$1; shift; time "$@"' "$0" "$TIMEFMT" "$@"
+        ;;
+      bash-builtin | ksh93-builtin | zsh-builtin | legacy-time)
+        time "$@"
+        ;;
+      mksh-builtin | lksh-builtin | pdksh-builtin | external-time | *)
+        time -p "$@"
+        ;;
+    esac
+    echo "ex $?" >&2
+  ) 2>&1 | (
+    "$SHELLSPEC_TRAP" '' INT
+
+    real='' user='' sys='' type=$SHELLSPEC_TIME_TYPE ex=''
+
+    while read -r name time; do
+      # ksh88: 1m2.34s
+      case $time in *m*s)
+        type=ksh88-builtin
+        min=${time%m*} && time=${time#*m}
+        sec=${time%.*} && time=${time#*.} && time=${time%s}
+        time="$(($min * 60 + $sec)).$time"
+      esac
+
+      case $name in (real | user | sys | start | end | ex)
+        eval "$name=\$time"
+      esac
+    done
+
+    if [ ! "$real" ]; then
+      datetime2unixtime start "$start"
+      datetime2unixtime end "$end"
+      real=$((${end%.*} - ${start%.*}))
+      case $start in
+        *[!0-9.]*) ;;
+        *)
+          start="${start#*.}00" end="${end#*.}00"
+          start="1${start%"${start#??}"}" end="3${end%"${end#??}"}"
+          diff=$(($end - $start))
+          real="$(( $real - ($diff < 200) )).${diff#[12]}"
+      esac
+    fi
+    if [ "${SHELLSPEC_TIME_LOG:+x}" ]; then
+      exec 2>|"$SHELLSPEC_TIME_LOG"
+    fi
+    echo "real:${real:-0} user:$user sys:$sys type:$type" >&2
+    exit "${ex:-1}"
+  )
+} 3>&2 4>&1
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-translate.sh new/libexec/shellspec-translate.sh
--- old/libexec/shellspec-translate.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-translate.sh	2025-12-23 15:20:28.000000000 +0100
@@ -28,8 +28,17 @@
 
 trans_block_example() {
   putsn "("
+  # Workaround for ksh93t on AIX 7.2
+  case ${KSH_VERSION:-} in (*93t*)
+    putsn 'ulimit -t $(ulimit -t)'
+  esac
   [ "$skipped" ] && trans_skip ""
   putsn "shellspec_example_id $block_id $example_no $block_no"
+  if [ "${shellspec_timeout_override:-}" ]; then
+    putsn "SHELLSPEC_EXAMPLE_TIMEOUT='$shellspec_timeout_override'"
+  else
+    putsn "SHELLSPEC_EXAMPLE_TIMEOUT=''"
+  fi
   putsn "SHELLSPEC_LINENO_BEGIN=$lineno_begin"
   putsn "shellspec_marker \"$specfile\" $lineno"
   putsn "shellspec_block${block_no}() { "
@@ -196,7 +205,7 @@
 
 syntax_error() {
   set -- "Syntax error: $1 in $specfile line $lineno" "${2:-}"
-  putsn "shellspec_abort $SHELLSPEC_ERROR_EXIT_CODE \"$1\" \"$2\" 2>&3"
+  putsn "shellspec_abort $SHELLSPEC_ERROR_EXIT_CODE \"$1\" \"$2\""
 }
 
 metadata=1 finished=1 coverage='' fd='' spec_no=1 progress=''
@@ -239,7 +248,9 @@
 [ "$fd" ] && putsn "exec 1>&$fd"
 putsn ". \"\$SHELLSPEC_LIB/bootstrap.sh\""
 putsn "shellspec_coverage_setup \"\$SHELLSPEC_SHELL_TYPE\""
-putsn "shellspec_metadata $metadata"
+if [ "$metadata" ]; then
+  putsn "shellspec_metadata"
+fi
 
 specfile_count=0
 progress() { :; }
@@ -276,4 +287,6 @@
 eval find_specfiles specfile ${1+'"$@"'}
 progress "${CR}${ESC}[2K"
 
-putsn "shellspec_finished $finished"
+if [ "$finished" ]; then
+  putsn "shellspec_finished"
+fi
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/libexec/shellspec-unreadonly-path.sh new/libexec/shellspec-unreadonly-path.sh
--- old/libexec/shellspec-unreadonly-path.sh	2021-01-11 06:25:23.000000000 +0100
+++ new/libexec/shellspec-unreadonly-path.sh	2025-12-23 15:20:28.000000000 +0100
@@ -1,4 +1,4 @@
 #!/bin/sh -eu
-# shellcheck disable=SC2039
+# shellcheck disable=SC3044
 typeset +x PATH
 exec "$SHELLSPEC_ENV" PATH="$PATH" SHELLSPEC_PATH_IS_READONLY='' "$SHELLSPEC_SHELL" "$@"
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/Makefile new/Makefile
--- old/Makefile	2021-01-11 06:25:23.000000000 +0100
+++ new/Makefile	2025-12-23 15:20:28.000000000 +0100
@@ -2,7 +2,7 @@
 BINDIR := $(PREFIX)/bin
 LIBDIR := $(PREFIX)/lib
 
-GETOPTIONSCLI := getoptions-cli --indent=2 --shellcheck
+GENGETOPTIONS := gengetoptions
 OPTPARSERDIR := lib/libexec/optparser
 
 .PHONY: coverage test dist build release
@@ -25,11 +25,17 @@
 package:
 	contrib/make_package_json.sh > package.json
 
+# Take in to retest getoptions in various shells
+takein_getoptions:
+	cp ../getoptions/lib/getoptions_*.sh lib
+	cp ../getoptions/spec/getoptions_*_spec.sh spec
+
 optparser:
 	@printf "getoptions: "
-	@$(GETOPTIONSCLI) --version
-	$(GETOPTIONSCLI) $(OPTPARSERDIR)/parser_definition.sh \
-		optparser_parse SHELLSPEC optparser_error \
+	@$(GENGETOPTIONS) --version
+	$(GENGETOPTIONS) parser --indent=2 --shellcheck \
+		-f $(OPTPARSERDIR)/parser_definition.sh \
+	        parser_definition optparser_parse SHELLSPEC optparser_error \
 		> $(OPTPARSERDIR)/parser_definition_generated.sh
 
 demo:
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/package.json new/package.json
--- old/package.json	2021-01-11 06:25:23.000000000 +0100
+++ new/package.json	2025-12-23 15:20:28.000000000 +0100
@@ -1,6 +1,6 @@
 {
   "name": "ShellSpec",
-  "version": "0.28.1",
+  "version": "0.29.0-dev",
   "description": "BDD style unit testing framework for POSIX compliant shell script",
   "homepage": "https://shellspec.info",
   "scripts": ["shellspec"],
@@ -12,6 +12,7 @@
     "lib/core/core.sh",
     "lib/core/dsl.sh",
     "lib/core/evaluation.sh",
+    "lib/core/file_descriptor.sh",
     "lib/core/hook.sh",
     "lib/core/matchers.sh",
     "lib/core/matchers/be.sh",
@@ -23,8 +24,9 @@
     "lib/core/matchers/be/variable.sh",
     "lib/core/matchers/end_with.sh",
     "lib/core/matchers/equal.sh",
-    "lib/core/matchers/has.sh",
-    "lib/core/matchers/has/stat.sh",
+    "lib/core/matchers/exist.sh",
+    "lib/core/matchers/have.sh",
+    "lib/core/matchers/have/stat.sh",
     "lib/core/matchers/include.sh",
     "lib/core/matchers/match.sh",
     "lib/core/matchers/satisfy.sh",
@@ -40,6 +42,7 @@
     "lib/core/outputs.sh",
     "lib/core/statement.sh",
     "lib/core/subjects.sh",
+    "lib/core/subjects/fd.sh",
     "lib/core/subjects/line.sh",
     "lib/core/subjects/path.sh",
     "lib/core/subjects/status.sh",
@@ -58,8 +61,8 @@
     "lib/cov/kcov/.zshenv",
     "lib/ext/ext.sh",
     "lib/general.sh",
-    "lib/getoptions.sh",
     "lib/getoptions_abbr.sh",
+    "lib/getoptions_base.sh",
     "lib/getoptions_help.sh",
     "lib/libexec.sh",
     "lib/libexec/binary.sh",
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/.shellcheckrc new/.shellcheckrc
--- old/.shellcheckrc	1970-01-01 01:00:00.000000000 +0100
+++ new/.shellcheckrc	2025-12-23 15:20:28.000000000 +0100
@@ -0,0 +1 @@
+disable=SC2317
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/.shellcheck-version new/.shellcheck-version
--- old/.shellcheck-version	2021-01-11 06:25:23.000000000 +0100
+++ new/.shellcheck-version	2025-12-23 15:20:28.000000000 +0100
@@ -1 +1 @@
-v0.7.1
+v0.10.0
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/shellspec new/shellspec
--- old/shellspec	2021-01-11 06:25:23.000000000 +0100
+++ new/shellspec	2025-12-23 15:20:28.000000000 +0100
@@ -5,9 +5,12 @@
 
 set -e -u -f
 
+#shellcheck disable=SC3044
+[ "${OIL_VERSION:-}" ] && shopt -s compat_array
+
 if [ "${1:-}" = "-" ]; then
   if [ $# -gt 1 ]; then shift; set -- "$0" "$@"; else set -- "$0"; fi
-  for i; do i="$i'" j=''
+  for i in "$@"; do i="$i'" j=''
     while [ "$i" ]; do j="$j${i%%\'*}'\''" && i=${i#*\'}; done
     set -- "$@" "'${j%????}'" && shift
   done
@@ -18,9 +21,10 @@
   exit 0
 fi
 
-export SHELLSPEC_VERSION='0.28.1'
-export SHELLSPEC_CWD=$PWD
+export SHELLSPEC_VERSION='0.29.0-dev'
+export SHELLSPEC_CWD="$PWD"
 export SHELLSPEC_PATH=''
+export SHELLSPEC_POSIX_PATH=''
 export SHELLSPEC_GRAMMAR_DSLS=''
 export SHELLSPEC_GRAMMAR_DIRECTIVES=''
 export SHELLSPEC_GRAMMAR_BLOCKS=''
@@ -30,7 +34,11 @@
 export SHELLSPEC_BUILTIN_PRINTF=''
 export SHELLSPEC_BUILTIN_PRINT=''
 export SHELLSPEC_BUILTIN_TYPESETF=''
-export SHELLSPEC_TIME=''
+export SHELLSPEC_BUILTIN_READARRAY=''
+export SHELLSPEC_SEEKABLE=''
+export SHELLSPEC_READ_DELIM=''
+export SHELLSPEC_YASH_ARRAY=''
+export SHELLSPEC_STRING_CONCAT=''
 export SHELLSPEC_LIST=''
 export SHELLSPEC_COUNT_FILE=''
 export SHELLSPEC_DEBUG_TRAP=''
@@ -38,7 +46,6 @@
 export SHELLSPEC_COVERAGE_SETUP=''
 export SHELLSPEC_COVERAGE_SHELL_OPTIONS=''
 export SHELLSPEC_KCOV_COMPATIBLE_SHELL=''
-export SHELLSPEC_OUTPUT_FD=9
 export SHELLSPEC_DEFECT_EMPTYPARAMS=''
 export SHELLSPEC_DEFECT_READONLY=''
 export SHELLSPEC_DEFECT_BUILTIN=''
@@ -46,24 +53,25 @@
 export SHELLSPEC_DEFECT_SHELLFLAG=''
 export SHELLSPEC_DEFECT_ERREXIT=''
 export SHELLSPEC_DEFECT_ZSHEXIT=''
+export SHELLSPEC_DEFECT_BOSHEXIT=''
 export SHELLSPEC_DEFECT_SUBSHELL=''
 export SHELLSPEC_DEFECT_SETE=''
 export SHELLSPEC_DEFECT_XTRACE=''
 export SHELLSPEC_DEFECT_EXPORTP=''
 export SHELLSPEC_DEFECT_SIGNAL=''
+export SHELLSPEC_DEFECT_DEBUGXS=''
 export SHELLSPEC_SHEBANG_MULTIARG=''
 export SHELLSPEC_BUSYBOX_W32=''
 export SHELLSPEC_SHOPT_AVAILABLE=''
 export SHELLSPEC_FAILGLOB_AVAILABLE=''
 export SHELLSPEC_NOMATCH_AVAILABLE=''
+export SHELLSPEC_FDVAR_AVAILABLE=''
 export SHELLSPEC_PATHSEP=":"
 export SHELLSPEC_REPAIR=''
 export SHELLSPEC_INFO=''
 export SHELLSPEC_TTY=''
 export SHELLSPEC_DEV_TTY="/dev/null"
-export SHELLSPEC_XTRACE_ON=''
-export SHELLSPEC_XTRACE_OFF=''
-export SHELLSPEC_XTRACEFD=2
+export SHELLSPEC_XTRACEFD=''
 export SHELLSPEC_XTRACEFD_VAR=''
 export SHELLSPEC_CLONE_TYPE=''
 export SHELLSPEC_PROC_VERSION='/proc/version'
@@ -80,9 +88,13 @@
 export SHELLSPEC_LS="ls"
 export SHELLSPEC_SORT="sort"
 export SHELLSPEC_FIND="find"
+export SHELLSPEC_OD="od"
+export SHELLSPEC_HEXDUMP="hexdump"
+
+SHELLSPEC_POSIX_PATH=$(getconf PATH 2>/dev/null) ||:
 
 #shellcheck disable=SC2039,SC3028
-export SHELLSPEC_HOSTNAME=${HOSTNAME:-localhost}
+export SHELLSPEC_HOSTNAME="${HOSTNAME:-localhost}"
 
 export SHELLSPEC_COLOR=''
 if [ ! "${NO_COLOR:-}" ] && { [ -t 1 ] || [ "${FORCE_COLOR:-}" ]; } then
@@ -118,6 +130,8 @@
 export SHELLSPEC_LIBEXEC="$SHELLSPEC_ROOT/libexec"
 export SHELLSPEC_INSPECTION="$SHELLSPEC_LIBEXEC/shellspec-inspection.sh"
 export SHELLSPEC_UNREADONLY_PATH="$SHELLSPEC_LIBEXEC/shellspec-unreadonly-path.sh"
+export SHELLSPEC_TIME_TYPE=auto
+export SHELLSPEC_TIME="$SHELLSPEC_LIBEXEC/shellspec-time.sh"
 
 # shellcheck source=lib/libexec/shellspec.sh
 . "$SHELLSPEC_LIB/libexec/shellspec.sh"
@@ -179,13 +193,14 @@
   SHELLSPEC_PROJECT_ROOT=${SHELLSPEC_PROJECT_ROOT%/*}
 done
 cd "${SHELLSPEC_PROJECT_ROOT:-.}"
+abspath SHELLSPEC_PROJECT_ROOT "$SHELLSPEC_PROJECT_ROOT"
 
 # option parsing
 {
   optparser parse_options error_message
 
   error_message() {
-    error "$1${options_file:+" [$options_file]"}"
+    error "$1${options_file:+ "[$options_file]"}"
   }
 
   options_file() {
@@ -221,6 +236,7 @@
   eval "set -- $params"
 }
 
+# shellcheck disable=SC2153
 case $SHELLSPEC_MODE in (init)
   SHELLSPEC_PROJECT_ROOT=${SHELLSPEC_PROJECT_ROOT:-$SHELLSPEC_CWD}
   helperdir=$SHELLSPEC_HELPERDIR
@@ -341,8 +357,13 @@
     warn "Unsupported shell (signal handling broken)."
   fi
 
-  [ "$SHELLSPEC_BUSYBOX_W32" ] && SHELLSPEC_PATHSEP=";"
-  [ "$SHELLSPEC_TTY" ] && SHELLSPEC_DEV_TTY=/dev/tty
+  if [ "$SHELLSPEC_BUSYBOX_W32" ]; then
+    SHELLSPEC_PATHSEP=";"
+  fi
+
+  if [ "$SHELLSPEC_TTY" ]; then
+    SHELLSPEC_DEV_TTY=/dev/tty
+  fi
 }
 
 setup_load_path
@@ -351,34 +372,34 @@
   warn "Some features may fail due to incompatibilities with sandbox features."
 fi
 
-# xtrace
-{
-  # shellcheck disable=SC2153
-  if [ "$SHELLSPEC_XTRACE" ]; then
-    if [ ! "$SHELLSPEC_XTRACE_ONLY" ]; then
-      [ "$SHELLSPEC_XTRACEFD_VAR" ] && SHELLSPEC_XTRACEFD=9
-      if [ "$SHELLSPEC_XTRACEFD" = "2" ] && SHELLSPEC_XTRACE_ONLY=1; then
-        warn "Fall back to trace-only mode. All expectations will be skipped."
-      fi
-    fi
+# Convert to absolute paths as needed for command-based mocks
+if [ "$SHELLSPEC_BUSYBOX_W32" ]; then
+  case $SHELLSPEC_SHELL in
+    */*) ;;
+    *) SHELLSPEC_SHELL="/bin/$SHELLSPEC_SHELL"
+  esac
+fi
 
-    if [ "$SHELLSPEC_DEFECT_XTRACE" ]; then
-      warn "If xtrace doesn't work, " \
-        'execute `set -x` manually inside the function.'
+# shellcheck disable=SC2153
+if [ "$SHELLSPEC_XTRACE" ]; then
+  if [ "$SHELLSPEC_XTRACE_ONLY" ]; then
+    SHELLSPEC_XTRACEFD=2
+  elif [ "$SHELLSPEC_XTRACEFD_VAR" ]; then
+    if [ "$SHELLSPEC_FDVAR_AVAILABLE" ]; then
+      SHELLSPEC_XTRACEFD=${SHELLSPEC_XTRACEFD:-"{SHELLSPEC_XTRACEFD}"}
+    else
+      # Busybox ash only?
+      SHELLSPEC_XTRACEFD=${SHELLSPEC_XTRACEFD:-8}
     fi
+  else
+    SHELLSPEC_XTRACE_ONLY=1 SHELLSPEC_XTRACEFD=2
+    warn "Fall back to trace-only mode. All expectations will be skipped."
   fi
 
-  if [ "$SHELLSPEC_DEFECT_XTRACE" = "2" ]; then
-    SHELLSPEC_XTRACE_ON='typeset -ft $(typeset +f); '
-    SHELLSPEC_XTRACE_OFF='typeset +ft $(typeset +f); '
-  else
-    if [ "$SHELLSPEC_XTRACEFD_VAR" ]; then
-      SHELLSPEC_XTRACE_ON="$SHELLSPEC_XTRACEFD_VAR=\$SHELLSPEC_XTRACEFD; "
-    fi
+  if [ "$SHELLSPEC_DEFECT_XTRACE" ]; then
+    warn "If xtrace doesn't work, execute 'set -x' manually inside a function."
   fi
-  SHELLSPEC_XTRACE_ON="${SHELLSPEC_XTRACE_ON}set -x"
-  SHELLSPEC_XTRACE_OFF=": @SHELLSPEC_XTRACE_OFF@; ${SHELLSPEC_XTRACE_OFF}set +x"
-}
+fi
 
 # resolve basic command path
 {
@@ -394,17 +415,8 @@
   command_path SHELLSPEC_LS "ls" ||:
   command_path SHELLSPEC_SORT "sort" ||:
   command_path SHELLSPEC_FIND "find" ||:
-
-  if command_path "time" || [ "$SHELLSPEC_BUSYBOX_W32" ]; then
-    SHELLSPEC_TIME="time -p"
-  else
-    SHELLSPEC_TIME="$SHELLSPEC_LIBEXEC/shellspec-time.sh"
-    if command_path bash; then
-      SHELLSPEC_TIME="bash $SHELLSPEC_TIME"
-    elif command_path ksh; then
-      SHELLSPEC_TIME="ksh $SHELLSPEC_TIME"
-    fi
-  fi
+  command_path SHELLSPEC_OD "od" ||:
+  command_path SHELLSPEC_HEXDUMP "hexdump" ||:
 }
 
 if ! signal 0 $$ 2>/dev/null; then
diff --color -ruN '--exclude=.git*' '--exclude=*.md' '--exclude=spec' '--exclude=docs' '--exclude=CLAUDE.md' '--exclude=helper' '--exclude=sample' '--exclude=contrib' old/.travis.yml new/.travis.yml
--- old/.travis.yml	2021-01-11 06:25:23.000000000 +0100
+++ new/.travis.yml	1970-01-01 01:00:00.000000000 +0100
@@ -1,67 +0,0 @@
-language: shell
-os: linux
-dist: bionic
-env:
-  global:
-    - PATH=${PATH}:${HOME}/kcov/bin
-    - CC_TEST_REPORTER_URL=https://codeclimate.com/downloads/test-reporter/test-reporter-latest-darwin-amd64
-    - CC_TEST_REPORTER_ID=67e0534ee993a6bbd10ae205ef4e807956c01564564ed64738932db123b1b87a
-addons:
-  apt:
-    update: true
-jobs:
-  include:
-#   - os: linux # Ubuntu 12.04
-#     dist: precise
-#     env: PACKAGES="dash bash zsh ksh mksh yash busybox"
-#   - os: linux # Ubuntu 14.04
-#     dist: trusty
-#     env: PACKAGES="dash bash zsh ksh mksh yash posh busybox"
-#   - os: linux # Ubuntu 16.04
-#     dist: xenial
-#     env: PACKAGES="dash bash zsh ksh mksh yash posh busybox"
-#   - os: linux # Ubuntu 18.04
-#     dist: bionic
-#     env: PACKAGES="dash bash zsh ksh mksh yash posh busybox"
-#   - os: linux # Ubuntu 20.04
-#     dist: focal
-#     env: PACKAGES="dash bash zsh ksh mksh yash posh busybox"
-#   - os: osx # macOS Homebrew
-#     osx_image: xcode11.5
-#     env: FORMULAS="dash bash zsh ksh mksh yash"
-    - os: osx # macOS 10.10 Yosemite 2014-06
-      osx_image: xcode6.4
-      env: SHELLS="sh bash zsh ksh"
-    - os: osx # macOS 10.11 El Capitan 2015-06
-      osx_image: xcode8
-      env: SHELLS="sh bash zsh ksh"
-    - os: osx # macOS 10.12 Sierra 2016-06
-      osx_image: xcode9.2
-      env: SHELLS="sh bash zsh ksh"
-    - os: osx # macOS 10.13 High Sierra 2017-06
-      osx_image: xcode10.1
-      env: SHELLS="sh bash zsh ksh"
-    - os: osx # macOS 10.14 Mojave 2018-06
-      osx_image: xcode10.2
-      env: SHELLS="sh bash zsh ksh"
-#   - os: osx # macOS 10.15.4 Catalina 2020-03
-#     osx_image: xcode11.5
-#     env: SHELLS="sh bash zsh ksh"
-    - os: osx # coverage
-      osx_image: xcode12.2
-      env: FORMULAS="bash kcov" COVERAGE=1 CODECOV=1 CC=1
-before_install:
-  - if [ "$PACKAGES" ]; then sudo apt-get install -y $PACKAGES; fi
-  - if [ "$FORMULAS" ]; then brew update; brew install $FORMULAS; fi
-  - if [ "$CC" ]; then curl -sSL $CC_TEST_REPORTER_URL > ./cc-test-reporter; fi
-  - if [ "$CC" ]; then chmod +x ./cc-test-reporter; fi
-  - if [ "$CC" ]; then ./cc-test-reporter before-build; fi
-before_script:
-  - ./shellspec --shell sh --task fixture:stat:prepare
-script:
-  - if [ ! "$COVERAGE" ]; then contrib/all.sh contrib/various_test.sh; fi
-  - if [   "$COVERAGE" ]; then ./shellspec --shell bash --kcov --kcov-options "--coveralls-id=${TRAVIS_JOB_ID}"; fi
-after_success:
-  - if [ "$CODECOV" ]; then bash <(curl -s https://codecov.io/bash) -s coverage; fi
-  - if [ "$CC" ]; then ./cc-test-reporter format-coverage coverage/cobertura.xml -t cobertura; fi
-  - if [ "$CC" ]; then ./cc-test-reporter upload-coverage; fi
